<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Lock-Free Data Structures and Wait-Free Algorithms in Go: From Theory to Practice </title><meta name="keywords" content="go, data structures" /><meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/css/styles.css" />
</head>
<body class="antialiased text-grey-900">
    
    <div class="container mx-auto max-w-screen-lg">
    <header class="flex items-center justify-between h-16 px-3 border-b border-gray-300">
    <div >
        <a href="/" class="flex items-center">
            <span class="text-lg text-gray-800 font-semibold">Prasanth Janardhanan</span>
        </a>
    </div>
    <div>
        <ul class="flex">
            <li class="t ml-5 text-md text-gray-700 hover:text-red-800"><a href="/" class="hover:underline">Articles</a></li>
            <li class="t ml-5 text-md text-gray-700 hover:text-red-800"><a href="/projects/" class="hover:underline">Projects</a></li>
            <li class="t ml-5 text-md text-gray-700 hover:text-red-800"><a href="/about/" class="hover:underline">About</a></li>
        </ul>
    </div>
</header>
    
    <article class="mt-6 mx-auto md:w-9/12 min-h-screen">
<h1 class="mt-5">Lock-Free Data Structures and Wait-Free Algorithms in Go: From Theory to Practice</h1>
<ul class="flex mb-2 list-none px-0 text-sm mt-0 ml-0 pt-0">
    
      <li class="pr-4 list-none">&#x1f3f7; <a href="/tags/go" class="text-gray-600">go</a> </li>
    
      <li class="pr-4 list-none">&#x1f3f7; <a href="/tags/data-structures" class="text-gray-600">data structures</a> </li>
    
</ul>
  
<p>Have you ever been stuck in a bank line where everyone needs to visit the same teller? Frustrating, right? Now imagine a bank where every customer could magically make their transaction without waiting for others to finish. Sounds like a dream? Well, that&rsquo;s exactly what lock-free and wait-free programming aims to achieve in the world of concurrent computing!</p>
<h2 id="the-concurrent-programming-challenge">The Concurrent Programming Challenge</h2>
<p>Let&rsquo;s start with a simple scenario. Imagine you and your roommate share a kitchen (our computer&rsquo;s memory), and you&rsquo;re both trying to make sandwiches (execute operations) at the same time. In traditional programming, we&rsquo;d put a lock on the kitchen – &ldquo;Hey, I&rsquo;m using the kitchen, wait your turn!&rdquo; But what if your roommate just needs to grab a glass of water? Should they really have to wait for your entire sandwich-making process to finish?</p>
<p>This is exactly the problem with traditional locking mechanisms in programming. They&rsquo;re like putting a &ldquo;Do Not Enter&rdquo; sign on an entire room when you might only need to protect a single drawer.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Traditional locking approach</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">var</span> <span style="color:#1f2328">counter</span> <span style="color:#cf222e">int</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">var</span> <span style="color:#1f2328">mutex</span> <span style="color:#1f2328">sync</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Mutex</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">incrementCounter</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">mutex</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Lock</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">counter</span><span style="color:#0550ae">++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">mutex</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Unlock</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This code is like saying, &ldquo;Nobody else can even LOOK at the counter while I&rsquo;m updating it!&rdquo; A bit extreme, don&rsquo;t you think?</p>
<h2 id="why-traditional-locks-fall-short">Why Traditional Locks Fall Short</h2>
<p>Traditional locks come with some serious baggage:</p>
<ol>
<li>
<p><strong>Priority Inversion</strong>: Imagine you&rsquo;re a VIP (high-priority task) waiting to use the kitchen, but a slow cook (low-priority task) has locked it. Now you&rsquo;re stuck waiting! In computing terms, this can cause critical tasks to wait for less important ones.</p>
</li>
<li>
<p><strong>Deadlocks</strong>: Picture two people, each holding one key to two different locks, each waiting for the other person&rsquo;s key. They&rsquo;ll be waiting forever! This is a deadlock, and it&rsquo;s more common than you might think:</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Potential deadlock scenario</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">dangerousOperation</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">mutex1</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Lock</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">mutex2</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Lock</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// If another goroutine locks these in opposite order...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// ...we have a deadlock!</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">mutex2</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Unlock</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">mutex1</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Unlock</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><ol start="3">
<li><strong>Convoying</strong>: Think of a slow shopper at the grocery checkout. Even though other shoppers might have quick purchases, everyone gets stuck behind the slow one. This is convoying, and it&rsquo;s a real performance killer.</li>
</ol>
<h2 id="the-promise-of-lock-free-and-wait-free-programming">The Promise of Lock-Free and Wait-Free Programming</h2>
<p>This is where lock-free and wait-free programming enters the scene. Instead of putting locks on our data structures, we design them to be safely accessed by multiple threads simultaneously – like having a kitchen where multiple cooks can work without stepping on each other&rsquo;s toes.</p>
<p>Here&rsquo;s a simple example of a lock-free counter in Go:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#0a3069">&#34;sync/atomic&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">var</span> <span style="color:#1f2328">counter</span> <span style="color:#cf222e">uint64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">incrementCounter</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">AddUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">counter</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This code is like having a magical counter that multiple people can update simultaneously without any conflicts. No locks, no waiting, just smooth concurrent operations!</p>
<h2 id="the-building-blocks-of-concurrent-programming">The Building Blocks of Concurrent Programming</h2>
<p>Imagine you&rsquo;re in a shared kitchen again, but this time it&rsquo;s a busy restaurant kitchen. Multiple chefs are working simultaneously, each preparing different dishes. How do they coordinate without chaos? This is the essence of concurrent programming.</p>
<h3 id="memory-our-shared-kitchen-space">Memory: Our Shared Kitchen Space</h3>
<p>In a computer, memory is like our kitchen&rsquo;s counter space. But here&rsquo;s the tricky part – modern computers don&rsquo;t just have one counter. They have multiple levels of storage (caches) that act like different prep stations in our kitchen.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">var</span> <span style="color:#1f2328">sharedIngredient</span> <span style="color:#cf222e">int</span>  <span style="color:#57606a">// This is like a shared ingredient on the counter</span>
</span></span></code></pre></div><p>Just like a chef might work with their own copy of ingredients at their station before combining them with others, modern CPUs often work with their own cached copies of data:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// What CPU1 sees</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">sharedIngredient</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// What CPU2 sees (might be different!)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">sharedIngredient</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">3</span>
</span></span></code></pre></div><h2 id="memory-ordering-when-things-get-wild">Memory Ordering: When Things Get Wild</h2>
<p>Here&rsquo;s where it gets interesting. Imagine you&rsquo;re giving instructions to two chefs:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">var</span> <span style="color:#1f2328">flour</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">var</span> <span style="color:#1f2328">sugar</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Chef 1&#39;s instructions</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">flour</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">sugar</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Chef 2&#39;s instructions</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">if</span> <span style="color:#1f2328">sugar</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">2</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Println</span><span style="color:#1f2328">(</span><span style="color:#1f2328">flour</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>You might expect that if Chef 2 sees <code>sugar = 2</code>, they&rsquo;ll definitely see <code>flour = 1</code>. But in the world of modern computers, this isn&rsquo;t guaranteed! It&rsquo;s like having overeager chefs who might rearrange their tasks for &ldquo;efficiency.&rdquo; This is called memory reordering.</p>
<h2 id="atomic-operations-the-perfect-dance-move">Atomic Operations: The Perfect Dance Move</h2>
<p>Enter atomic operations – they&rsquo;re like perfectly choreographed dance moves that can&rsquo;t be interrupted. Take our earlier counter example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#0a3069">&#34;sync/atomic&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">var</span> <span style="color:#1f2328">counter</span> <span style="color:#cf222e">uint64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// This is like a perfect, uninterruptible dance move</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">AddUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">counter</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Instead of this clumsy two-step that could go wrong</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// temp := counter</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// counter = temp + 1</span>
</span></span></code></pre></div><p>Think of atomic operations like those amazing street performers who can spin plates – once they start a move, they complete it perfectly every time, no matter what&rsquo;s happening around them.</p>
<h2 id="compare-and-swap-the-heart-of-lock-free-programming">Compare-and-Swap: The Heart of Lock-Free Programming</h2>
<p>Now we&rsquo;re getting to the good stuff! Compare-and-Swap is like a magical kitchen helper who can:</p>
<ol>
<li>Look at a value</li>
<li>Compare it to what they expect</li>
<li>Change it only if it matches their expectation</li>
</ol>
<p>All in one uninterruptible motion!</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">var</span> <span style="color:#1f2328">value</span> <span style="color:#cf222e">uint64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">incrementWithCAS</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">current</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">value</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwapUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">value</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">current</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">current</span><span style="color:#0550ae">+</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// If we&#39;re here, someone else modified the value - try again!</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This is like saying: &ldquo;If the bowl has exactly 3 eggs, add one more. If not, check again!&rdquo; It&rsquo;s our first real taste of lock-free programming!</p>
<h2 id="the-happens-before-relationship-establishing-order-in-chaos">The Happens-Before Relationship: Establishing Order in Chaos</h2>
<p>In our kitchen analogy, &ldquo;happens-before&rdquo; is like saying, &ldquo;You MUST crack the eggs BEFORE making the omelet.&rdquo; In Go, we have similar rules:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">var</span> <span style="color:#1f2328">data</span> <span style="color:#cf222e">int32</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">var</span> <span style="color:#1f2328">ready</span> <span style="color:#cf222e">int32</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Writer goroutine</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">write</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Prepare the data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">d</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">prepareData</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">StoreInt32</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">data</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">d</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Signal that data is ready</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">StoreInt32</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">ready</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Reader goroutine</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">read</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Check if data is ready</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadInt32</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">ready</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">runtime</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Gosched</span><span style="color:#1f2328">()</span> <span style="color:#57606a">// Be nice to other goroutines</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// At this point, we&#39;re guaranteed to see the prepared data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">value</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadInt32</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">data</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Println</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>The atomic operations create a happens-before relationship, ensuring that if the reader sees <code>ready = 1</code>, it will definitely see the properly prepared data. This is a fundamental principle in memory ordering.</p>
<h2 id="practical-example-a-simple-lock-free-counter">Practical Example: A Simple Lock-Free Counter</h2>
<p>Let&rsquo;s put it all together with a complete example of a lock-free counter:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Counter</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">value</span> <span style="color:#cf222e">uint64</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">c</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Counter</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Increment</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">uint64</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Get the current value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">current</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Try to increment it</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">next</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">current</span> <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwapUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">current</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">next</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">next</span> <span style="color:#57606a">// Return the new value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// If we failed, someone else modified it - try again!</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">runtime</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Gosched</span><span style="color:#1f2328">()</span> <span style="color:#57606a">// Be nice to other goroutines</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">c</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Counter</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Get</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">uint64</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This counter can be safely used by multiple goroutines simultaneously, with no locks in sight!</p>
<h2 id="lock-free-vs-wait-free-understanding-the-distinction">Lock-Free vs. Wait-Free: Understanding the Distinction</h2>
<h3 id="the-progress-guarantee-spectrum">The Progress Guarantee Spectrum</h3>
<p>Imagine you&rsquo;re at a coffee shop. The way the shop handles customers can help us understand different types of progress guarantees:</p>
<ol>
<li>
<p><strong>Blocking (Lock-Based)</strong></p>
<ul>
<li>Like a coffee shop with one barista who can only serve one customer at a time</li>
<li>Everyone else must wait in line</li>
<li>If the barista takes a break (thread gets preempted), everyone&rsquo;s stuck!</li>
</ul>
</li>
<li>
<p><strong>Lock-Free</strong></p>
<ul>
<li>Like a coffee shop where multiple baristas share one coffee machine</li>
<li>If baristas collide, some might need to retry</li>
<li>But SOMEONE is always making progress</li>
<li>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">lockFreeIncrement</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span> <span style="color:#0550ae">*</span><span style="color:#cf222e">uint64</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">current</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadUint64</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwapUint64</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">current</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">current</span><span style="color:#0550ae">+</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>  <span style="color:#57606a">// Success! But we might have had to retry</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Someone else won the race - try again</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p><strong>Wait-Free</strong></p>
<ul>
<li>Like a coffee shop where each barista has their own machine</li>
<li>Everyone makes progress, no matter what</li>
<li>No retries needed, but more complex and resource-intensive</li>
<li>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Simplified wait-free increment using per-thread storage</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">WaitFreeCounter</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">counts</span> <span style="color:#1f2328">[</span><span style="color:#1f2328">MaxThreads</span><span style="color:#1f2328">]</span><span style="color:#cf222e">uint64</span>  <span style="color:#57606a">// Each thread gets its own counter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">total</span>  <span style="color:#cf222e">uint64</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ol>
<h3 id="the-lock-free-guarantee">The Lock-Free Guarantee</h3>
<p>Let&rsquo;s implement a simple lock-free stack to understand the concept better:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Node</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">value</span> <span style="color:#cf222e">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">next</span>  <span style="color:#0550ae">*</span><span style="color:#1f2328">Node</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Stack</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">head</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Node</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Stack</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Push</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span> <span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">node</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">{</span><span style="color:#1f2328">value</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">value</span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">head</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadPointer</span><span style="color:#1f2328">((</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">head</span><span style="color:#1f2328">)))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">node</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">head</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwapPointer</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">head</span><span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">head</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">node</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// If CAS failed, someone else modified the stack - try again</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This stack is like a game of Jenga where players can add pieces simultaneously. Sometimes you might need to retry, but someone always succeeds.</p>
<h3 id="wait-free-algorithms-the-gold-standard">Wait-Free Algorithms: The Gold Standard</h3>
<p>Wait-free algorithms are like having an express lane for every customer. Here&rsquo;s a simplified wait-free counter:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">WaitFreeCounter</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">counters</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">uint64</span>  <span style="color:#57606a">// One counter per goroutine</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">c</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">WaitFreeCounter</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Increment</span><span style="color:#1f2328">(</span><span style="color:#1f2328">goroutineID</span> <span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">AddUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">counters</span><span style="color:#1f2328">[</span><span style="color:#1f2328">goroutineID</span><span style="color:#1f2328">],</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// No retries needed! Each goroutine has its own counter</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">c</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">WaitFreeCounter</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">GetTotal</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">uint64</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">total</span> <span style="color:#cf222e">uint64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">counters</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">total</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">counters</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">total</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h2 id="the-aba-problem-a-classic-gotcha">The ABA Problem: A Classic Gotcha</h2>
<p>The ABA problem is like this scenario:</p>
<ol>
<li>You look at a coffee cup (it&rsquo;s blue)</li>
<li>You get distracted</li>
<li>Someone replaces it with a red cup</li>
<li>Someone replaces the red cup with a different blue cup</li>
<li>You come back and think nothing has changed!</li>
</ol>
<p>Here&rsquo;s how it can happen in code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Node</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">value</span> <span style="color:#cf222e">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">next</span>  <span style="color:#0550ae">*</span><span style="color:#1f2328">Node</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Potential ABA problem in a lock-free stack</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Stack</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Pop</span><span style="color:#1f2328">()</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Node</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">head</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadPointer</span><span style="color:#1f2328">((</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">head</span><span style="color:#1f2328">)))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">head</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">next</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">head</span><span style="color:#1f2328">).</span><span style="color:#1f2328">next</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwapPointer</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">head</span><span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">head</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">next</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">head</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>The solution? Add a counter that changes with every modification:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">TaggedPointer</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ptr</span>   <span style="color:#0550ae">*</span><span style="color:#1f2328">Node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">count</span> <span style="color:#cf222e">uint64</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h2 id="trade-offs-in-the-real-world">Trade-offs in the Real World</h2>
<p>Let&rsquo;s compare these approaches:</p>
<ol>
<li>
<p><strong>Lock-Free</strong></p>
<ul>
<li>Pros:
<ul>
<li>Simpler implementation</li>
<li>Lower memory overhead</li>
<li>Often good enough in practice</li>
</ul>
</li>
<li>Cons:
<ul>
<li>No guarantee against individual thread starvation</li>
<li>Can lead to lengthy retry loops</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Wait-Free</strong></p>
<ul>
<li>Pros:
<ul>
<li>Guaranteed progress for all threads</li>
<li>Predictable performance</li>
<li>Real-time system friendly</li>
</ul>
</li>
<li>Cons:
<ul>
<li>More complex implementation</li>
<li>Higher memory usage</li>
<li>Often slower in low-contention scenarios</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="making-the-choice-a-decision-framework">Making the Choice: A Decision Framework</h3>
<p>When should you choose each approach? Here&rsquo;s a simple decision tree:</p>
<ol>
<li>
<p>Choose Wait-Free when:</p>
<ul>
<li>You need real-time guarantees</li>
<li>Thread starvation is unacceptable</li>
<li>You have memory to spare</li>
</ul>
</li>
<li>
<p>Choose Lock-Free when:</p>
<ul>
<li>Average performance is more important than worst-case</li>
<li>Memory is constrained</li>
<li>Implementation simplicity is crucial</li>
</ul>
</li>
</ol>
<h2 id="building-blocks-in-go-your-concurrent-programming-toolkit">Building Blocks in Go: Your Concurrent Programming Toolkit</h2>
<p>Imagine you&rsquo;re building a house. You don&rsquo;t start with the roof – you need a strong foundation and the right tools first. In the world of lock-free programming, Go provides us with some powerful tools that act as our hammer, nails, and measuring tape. Let&rsquo;s explore them!</p>
<h3 id="atomic-operations-your-swiss-army-knife">Atomic Operations: Your Swiss Army Knife</h3>
<p>Remember playing with Lego blocks as a kid? Each piece snaps perfectly into place in one smooth motion. Atomic operations work the same way – they&rsquo;re operations that complete in one uninterruptible step. Go&rsquo;s sync/atomic package is our box of these special Lego pieces.</p>
<p>Here&rsquo;s a simple example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">var</span> <span style="color:#1f2328">counter</span> <span style="color:#cf222e">uint64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// This is like snapping a Lego piece into place - one smooth motion</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">AddUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">counter</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Instead of this risky two-step dance:</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// counter = counter + 1  // Don&#39;t do this in concurrent code!</span>
</span></span></code></pre></div><h3 id="memory-fences-the-traffic-lights-of-memory-access">Memory Fences: The Traffic Lights of Memory Access</h3>
<p>Think of memory fences like traffic lights at a busy intersection. They ensure cars (our data) move in an orderly fashion. In Go, atomic operations automatically include these &ldquo;traffic lights&rdquo;:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">var</span> <span style="color:#1f2328">data</span> <span style="color:#cf222e">int</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">var</span> <span style="color:#1f2328">ready</span> <span style="color:#cf222e">uint32</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">producer</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">data</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">42</span>                        <span style="color:#57606a">// Set up the data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">StoreUint32</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">ready</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>    <span style="color:#57606a">// Green light for readers!</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">consumer</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadUint32</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">ready</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">1</span> <span style="color:#1f2328">{</span>  <span style="color:#57606a">// Check if light is green</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Println</span><span style="color:#1f2328">(</span><span style="color:#1f2328">data</span><span style="color:#1f2328">)</span>                <span style="color:#57606a">// Safe to read data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h3 id="compare-and-swap-the-careful-craftsman">Compare-and-Swap: The Careful Craftsman</h3>
<p>Compare-and-Swap (CAS) is like a careful craftsman who follows a specific ritual:</p>
<ol>
<li>Look at the current value</li>
<li>Check if it matches what they expect</li>
<li>Only make changes if everything looks right</li>
</ol>
<p>Here&rsquo;s a real-world example – a thread-safe counter that never misses an increment:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">PreciseCounter</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">value</span> <span style="color:#cf222e">uint64</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">c</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">PreciseCounter</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Increment</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">uint64</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Take a snapshot of the current value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">current</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Try to update it, but only if no one else has</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwapUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">current</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">current</span><span style="color:#0550ae">+</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">current</span> <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Someone else changed it - let&#39;s try again!</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h3 id="a-complete-example-building-a-thread-safe-stack">A Complete Example: Building a Thread-Safe Stack</h3>
<p>Let&rsquo;s put all these tools together to build something useful – a stack that multiple goroutines can safely use at the same time. Think of it like a stack of plates where multiple waiters can add or remove plates safely:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">LockFreeStack</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">top</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span>  <span style="color:#57606a">// Points to the top node</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Node</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">value</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">next</span>  <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeStack</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Push</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">newNode</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">{</span><span style="color:#1f2328">value</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">value</span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// See what&#39;s on top</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">oldTop</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadPointer</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">top</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Place our plate on top of the existing stack</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">newNode</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">oldTop</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Try to make our node the new top</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwapPointer</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">top</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">oldTop</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">newNode</span><span style="color:#1f2328">))</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Someone else changed the stack - try again</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h3 id="common-pitfalls-the-hidden-traps">Common Pitfalls: The Hidden Traps</h3>
<p>Just like a beautiful garden can hide thorny bushes, our concurrent tools come with their own hazards. Here&rsquo;s a classic trap:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// DON&#39;T DO THIS!</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">value</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">counter</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">value</span><span style="color:#0550ae">++</span>                              <span style="color:#57606a">// Oops! Not atomic anymore</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">StoreUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">counter</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">value</span><span style="color:#1f2328">)</span>  <span style="color:#57606a">// Too late, might have lost updates</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// DO THIS INSTEAD</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">AddUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">counter</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>  <span style="color:#57606a">// One smooth, atomic operation</span>
</span></span></code></pre></div><p>It&rsquo;s like trying to juggle – you need to keep all the balls in the air at once. Drop one, and the whole pattern falls apart!</p>
<h2 id="lock-free-data-structure-implementations-building-thread-safe-collections">Lock-Free Data Structure Implementations: Building Thread-Safe Collections</h2>
<h3 id="the-lock-free-stack-our-first-adventure">The Lock-Free Stack: Our First Adventure</h3>
<p>Think of a stack like a Pringles can – typically, you can only add or remove chips from the top. But imagine a magical can where multiple people could safely add or remove chips simultaneously without any collisions. That&rsquo;s our lock-free stack!</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">LockFreeStack</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">top</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Node</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">value</span>    <span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">next</span>     <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewLockFreeStack</span><span style="color:#1f2328">()</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeStack</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">LockFreeStack</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>Let&rsquo;s implement the push operation first:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeStack</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Push</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">newNode</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">{</span><span style="color:#1f2328">value</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">value</span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Snapshot the current top</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">oldTop</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">top</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Point our new node to the current top</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">newNode</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#1f2328">oldTop</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Try to update the top to our new node</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">top</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwap</span><span style="color:#1f2328">(</span><span style="color:#1f2328">oldTop</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">newNode</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Someone else won the race - try again!</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>And here&rsquo;s the pop operation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeStack</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Pop</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">oldTop</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">top</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">oldTop</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>  <span style="color:#57606a">// Stack is empty</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Try to update top to the next node</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">top</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwap</span><span style="color:#1f2328">(</span><span style="color:#1f2328">oldTop</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">oldTop</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">())</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">oldTop</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Someone else modified the stack - try again!</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h3 id="the-lock-free-queue-a-more-complex-beast">The Lock-Free Queue: A More Complex Beast</h3>
<p>If a stack is like a Pringles can, a queue is like a tube slide at a water park – people enter at one end and exit at the other. Our lock-free queue needs to handle both ends safely:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">LockFreeQueue</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">head</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">tail</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewLockFreeQueue</span><span style="color:#1f2328">()</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeQueue</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">dummy</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">q</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">LockFreeQueue</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">head</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#1f2328">dummy</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tail</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#1f2328">dummy</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">q</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>Here&rsquo;s the enqueue operation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">q</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeQueue</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Enqueue</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">newNode</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">{</span><span style="color:#1f2328">value</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">value</span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">tail</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tail</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">next</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">tail</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Make sure tail was still the tail</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">tail</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tail</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">next</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a">// Try to link the new node</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwapPointer</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">tail</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">newNode</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a">// Try to swing the tail to the new node</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tail</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwap</span><span style="color:#1f2328">(</span><span style="color:#1f2328">tail</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">newNode</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a">// Tail was falling behind, help move it</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tail</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwap</span><span style="color:#1f2328">(</span><span style="color:#1f2328">tail</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">next</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>Let&rsquo;s break this down with a water park analogy:</p>
<ol>
<li>You want to add a new person (node) to the slide</li>
<li>You check the end of the line (tail)</li>
<li>If someone is secretly already there but not officially &ldquo;in line&rdquo;, help them first</li>
<li>Then add your person to the line</li>
</ol>
<h3 id="the-lock-free-linked-list-the-grand-challenge">The Lock-Free Linked List: The Grand Challenge</h3>
<p>A lock-free linked list is like a conga line where people can join or leave at any point. It&rsquo;s trickier because we need to handle changes in the middle of the structure:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">LockFreeList</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">head</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Node</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">value</span>    <span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">next</span>     <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">isMarked</span> <span style="color:#cf222e">bool</span>  <span style="color:#57606a">// For safe deletion</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">l</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeList</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Insert</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">prev</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">l</span><span style="color:#1f2328">.</span><span style="color:#1f2328">head</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">curr</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">prev</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Find insertion point</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> <span style="color:#1f2328">curr</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span><span style="color:#1f2328">.(</span><span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&lt;</span> <span style="color:#1f2328">value</span><span style="color:#1f2328">.(</span><span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">prev</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">curr</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">curr</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Set up new node</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">newNode</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">{</span><span style="color:#1f2328">value</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">value</span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">newNode</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#1f2328">curr</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Try to insert</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">prev</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwap</span><span style="color:#1f2328">(</span><span style="color:#1f2328">curr</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">newNode</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Someone modified the list - try again</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This is complex stuff! Let&rsquo;s handle deletion:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">l</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeList</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Delete</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">prev</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">l</span><span style="color:#1f2328">.</span><span style="color:#1f2328">head</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">curr</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">prev</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Find the node</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> <span style="color:#1f2328">curr</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span><span style="color:#1f2328">.(</span><span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&lt;</span> <span style="color:#1f2328">value</span><span style="color:#1f2328">.(</span><span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">prev</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">curr</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">curr</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">curr</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#0550ae">||</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">value</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">false</span>  <span style="color:#57606a">// Not found</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Mark for deletion</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">isMarked</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Try to unlink</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">next</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">prev</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwap</span><span style="color:#1f2328">(</span><span style="color:#1f2328">curr</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">next</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Someone modified the list - try again</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h3 id="memory-management-the-cleanup-crew">Memory Management: The Cleanup Crew</h3>
<p>Just like a water park needs cleanup crews, our lock-free structures need memory management. In Go, we rely on the garbage collector, but we need to be careful about the ABA problem:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">TaggedPointer</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ptr</span>   <span style="color:#0550ae">*</span><span style="color:#1f2328">Node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">count</span> <span style="color:#cf222e">uint64</span>  <span style="color:#57606a">// Changes with every modification</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This is like giving each person in line a unique ticket number – even if they leave and come back, we&rsquo;ll know they&rsquo;re not the same instance!</p>
<h2 id="implementing-a-lock-free-linked-list">Implementing a Lock-Free Linked List</h2>
<p>Here&rsquo;s a complete implementation of a lock-free linked list with safe memory management:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;sync/atomic&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;unsafe&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Node represents a node in the lock-free linked list</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Node</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">value</span>    <span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">next</span>     <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">deleted</span>  <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Bool</span> <span style="color:#57606a">// Marked true during deletion</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// SafeList implements a lock-free linked list</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">SafeList</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">head</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// NewSafeList creates a new empty SafeList</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewSafeList</span><span style="color:#1f2328">()</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SafeList</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">list</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">SafeList</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Initialize with a sentinel node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">sentinel</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">{</span><span style="color:#1f2328">value</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">list</span><span style="color:#1f2328">.</span><span style="color:#1f2328">head</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#1f2328">sentinel</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">list</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Insert adds a new value to the list in sorted order</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Returns true if the value was inserted, false if it already exists</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Thread-safety: Safe to call from multiple goroutines.</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Progress: Lock-free. Completes in O(n) steps.</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">l</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SafeList</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Insert</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">node</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">{</span><span style="color:#1f2328">value</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">value</span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Find the insertion point</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">prev</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">curr</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">l</span><span style="color:#1f2328">.</span><span style="color:#6639ba">findInsertionPoint</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">curr</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">value</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">deleted</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">false</span> <span style="color:#57606a">// Value already exists</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Link the new node</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">node</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#1f2328">curr</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Try to update prev.next to point to our new node</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwapPointer</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">prev</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">curr</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">node</span><span style="color:#1f2328">))</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">runtime</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Gosched</span><span style="color:#1f2328">()</span> <span style="color:#57606a">// Be nice to other goroutines</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Delete removes a value from the list</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Returns true if the value was deleted, false if it wasn&#39;t found</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Thread-safety: Safe to call from multiple goroutines.</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Progress: Lock-free. Completes in O(n) steps.</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">l</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SafeList</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Delete</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">prev</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">l</span><span style="color:#1f2328">.</span><span style="color:#1f2328">head</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">curr</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">prev</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Find the node</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> <span style="color:#1f2328">curr</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span><span style="color:#1f2328">.(</span><span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&lt;</span> <span style="color:#1f2328">value</span><span style="color:#1f2328">.(</span><span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">prev</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">curr</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">curr</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">curr</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#0550ae">||</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">value</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">false</span> <span style="color:#57606a">// Not found</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Mark the node as deleted</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">deleted</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwap</span><span style="color:#1f2328">(</span><span style="color:#cf222e">false</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">true</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">false</span> <span style="color:#57606a">// Already deleted</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Try to unlink the node</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">next</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwapPointer</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">prev</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">curr</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">next</span><span style="color:#1f2328">))</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">runtime</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Gosched</span><span style="color:#1f2328">()</span> <span style="color:#57606a">// Be nice to other goroutines</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Find returns true if the value exists in the list</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">l</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SafeList</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Find</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">curr</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">l</span><span style="color:#1f2328">.</span><span style="color:#1f2328">head</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">curr</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">value</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">deleted</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">curr</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// findInsertionPoint finds the position where a value should be inserted</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Returns the previous and current nodes</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">l</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SafeList</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">findInsertionPoint</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">retry</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">prev</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">l</span><span style="color:#1f2328">.</span><span style="color:#1f2328">head</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">curr</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">prev</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">curr</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Skip deleted nodes</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">deleted</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// Try to unlink the deleted node</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">next</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwapPointer</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">prev</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">curr</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">next</span><span style="color:#1f2328">))</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">goto</span> <span style="color:#1f2328">retry</span> <span style="color:#57606a">// Someone else modified the list, retry</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">curr</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">next</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Compare values for sorted insertion</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">switch</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span><span style="color:#1f2328">.(</span><span style="color:#cf222e">type</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">case</span> <span style="color:#cf222e">int</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span><span style="color:#1f2328">.(</span><span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">&gt;=</span> <span style="color:#1f2328">value</span><span style="color:#1f2328">.(</span><span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#1f2328">prev</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">curr</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">case</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span><span style="color:#1f2328">.(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">&gt;=</span> <span style="color:#1f2328">value</span><span style="color:#1f2328">.(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#1f2328">prev</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">curr</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">default</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// For non-comparable types, just append to the end</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">prev</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">curr</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">curr</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">prev</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">curr</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This implementation includes several important features:</p>
<ol>
<li><strong>Safe Memory Management</strong>: Uses atomic pointers and deletion markers to prevent ABA problems</li>
<li><strong>Type-Safe Operations</strong>: Handles different comparable types appropriately</li>
<li><strong>Garbage Collection Friendly</strong>: Marks nodes as deleted before unlinking them</li>
<li><strong>Lock-Free Progress</strong>: All operations can proceed without locks</li>
<li><strong>Memory Ordering</strong>: Proper use of atomic operations ensures correct visibility</li>
</ol>
<h2 id="understanding-wait-free-a-fresh-perspective">Understanding Wait-Free: A Fresh Perspective</h2>
<p>Imagine a busy restaurant with an innovative ordering system. In a normal restaurant, if one waiter gets stuck with a difficult customer, other waiters might have to wait. But in our wait-free restaurant, every waiter is guaranteed to complete their task in a fixed number of steps, no matter what other waiters are doing.</p>
<h2 id="wait-free-universal-construction">Wait-Free Universal Construction</h2>
<p>Let&rsquo;s start with something mind-bending – a technique that can transform any data structure into a wait-free version. Think of it like a magical recipe that can turn any regular dish into one that can be cooked simultaneously by multiple chefs without conflicts:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Operation</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">id</span>        <span style="color:#cf222e">int64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">type</span>      <span style="color:#1f2328">OperationType</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">data</span>      <span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">completed</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Bool</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">WaitFreeStructure</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">operations</span> <span style="color:#1f2328">[]</span><span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Operation</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">results</span>    <span style="color:#1f2328">[]</span><span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Value</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">current</span>    <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Int64</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">w</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">WaitFreeStructure</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Apply</span><span style="color:#1f2328">(</span><span style="color:#1f2328">op</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Operation</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">myPosition</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#1f2328">current</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Add</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-</span> <span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#1f2328">operations</span><span style="color:#1f2328">[</span><span style="color:#1f2328">myPosition</span><span style="color:#1f2328">].</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#1f2328">op</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Help complete all operations up to ours</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">int64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">0</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">&lt;=</span> <span style="color:#1f2328">myPosition</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span><span style="color:#0550ae">++</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#6639ba">helpComplete</span><span style="color:#1f2328">(</span><span style="color:#1f2328">i</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#1f2328">results</span><span style="color:#1f2328">[</span><span style="color:#1f2328">myPosition</span><span style="color:#1f2328">].</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>The key idea here is &ldquo;helping&rdquo; – if you see an operation that&rsquo;s not complete, you help finish it before moving on. It&rsquo;s like seeing a fellow chef struggling and jumping in to help them finish their dish!</p>
<h2 id="a-practical-wait-free-queue">A Practical Wait-Free Queue</h2>
<p>Here&rsquo;s a simplified wait-free queue that guarantees progress for every operation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">WaitFreeQueue</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">slots</span>    <span style="color:#1f2328">[]</span><span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Value</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">enqIdx</span>   <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Uint64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">deqIdx</span>   <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Uint64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">capacity</span> <span style="color:#cf222e">uint64</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">q</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">WaitFreeQueue</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Enqueue</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">idx</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">enqIdx</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">idx</span><span style="color:#0550ae">-</span><span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">deqIdx</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span> <span style="color:#0550ae">&gt;=</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">capacity</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">false</span>  <span style="color:#57606a">// Queue is full</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">slot</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">slots</span><span style="color:#1f2328">[</span><span style="color:#1f2328">idx</span><span style="color:#0550ae">%</span><span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">capacity</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">slot</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwap</span><span style="color:#1f2328">(</span><span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">value</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">enqIdx</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Add</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Someone else took our slot - move forward</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">enqIdx</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Add</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This is like having an infinite row of empty boxes moving on a conveyor belt. Each person (thread) is guaranteed to find an empty box within a fixed number of steps!</p>
<h2 id="multi-word-compare-and-swap">Multi-Word Compare-and-Swap</h2>
<p>Sometimes we need to update multiple values atomically. Imagine coordinating multiple traffic lights to change simultaneously:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">WCAS2</span><span style="color:#1f2328">[</span><span style="color:#1f2328">T</span> <span style="color:#cf222e">any</span><span style="color:#1f2328">]</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">loc1</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">loc2</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">T</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">old1</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">old2</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">T</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">new1</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">new2</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">T</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">c</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">WCAS2</span><span style="color:#1f2328">[</span><span style="color:#1f2328">T</span><span style="color:#1f2328">])</span> <span style="color:#6639ba">Try</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Phase 1: Announce our intention</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">descriptor</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">WCASDescriptor</span><span style="color:#1f2328">[</span><span style="color:#1f2328">T</span><span style="color:#1f2328">]{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">locations</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[</span><span style="color:#0550ae">2</span><span style="color:#1f2328">]</span><span style="color:#0550ae">*</span><span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">T</span><span style="color:#1f2328">]{</span><span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">loc1</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">loc2</span><span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">oldValues</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[</span><span style="color:#0550ae">2</span><span style="color:#1f2328">]</span><span style="color:#0550ae">*</span><span style="color:#1f2328">T</span><span style="color:#1f2328">{</span><span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">old1</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">old2</span><span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">newValues</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[</span><span style="color:#0550ae">2</span><span style="color:#1f2328">]</span><span style="color:#0550ae">*</span><span style="color:#1f2328">T</span><span style="color:#1f2328">{</span><span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">new1</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">new2</span><span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Phase 2: Try to lock locations</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span> <span style="color:#1f2328">&lt;</span> <span style="color:#0550ae">2</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span><span style="color:#0550ae">++</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">descriptor</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Complete</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">descriptor</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Failed</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// Try to lock location i</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// Help anyone else we see along the way</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">descriptor</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Complete</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h2 id="the-helping-mechanism-being-a-good-neighbor">The Helping Mechanism: Being a Good Neighbor</h2>
<p>The secret sauce of wait-free algorithms is helping others. It&rsquo;s like a neighborhood where everyone shovels snow from their sidewalk and helps their neighbors too:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">w</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">WaitFreeStructure</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">helpComplete</span><span style="color:#1f2328">(</span><span style="color:#1f2328">position</span> <span style="color:#cf222e">int64</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">op</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#1f2328">operations</span><span style="color:#1f2328">[</span><span style="color:#1f2328">position</span><span style="color:#1f2328">].</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">op</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#0550ae">||</span> <span style="color:#1f2328">op</span><span style="color:#1f2328">.</span><span style="color:#1f2328">completed</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Apply the operation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">result</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#6639ba">applyOperation</span><span style="color:#1f2328">(</span><span style="color:#1f2328">op</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#1f2328">results</span><span style="color:#1f2328">[</span><span style="color:#1f2328">position</span><span style="color:#1f2328">].</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#1f2328">result</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">op</span><span style="color:#1f2328">.</span><span style="color:#1f2328">completed</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#cf222e">true</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h2 id="elimination-a-clever-shortcut">Elimination: A Clever Shortcut</h2>
<p>Sometimes, operations can cancel each other out. Imagine a stack where a push and pop arrive simultaneously – why not just hand the value directly from pusher to popper?</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">EliminationArray</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">slots</span> <span style="color:#1f2328">[]</span><span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Value</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">e</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">EliminationArray</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">TryEliminate</span><span style="color:#1f2328">(</span><span style="color:#1f2328">op</span> <span style="color:#1f2328">Operation</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">value</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">slot</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">rand</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Intn</span><span style="color:#1f2328">(</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">e</span><span style="color:#1f2328">.</span><span style="color:#1f2328">slots</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">op</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">Push</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">e</span><span style="color:#1f2328">.</span><span style="color:#1f2328">slots</span><span style="color:#1f2328">[</span><span style="color:#1f2328">slot</span><span style="color:#1f2328">].</span><span style="color:#6639ba">CompareAndSwap</span><span style="color:#1f2328">(</span><span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">value</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// Wait briefly for a matching pop</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sleep</span><span style="color:#1f2328">(</span><span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Microsecond</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">e</span><span style="color:#1f2328">.</span><span style="color:#1f2328">slots</span><span style="color:#1f2328">[</span><span style="color:#1f2328">slot</span><span style="color:#1f2328">].</span><span style="color:#6639ba">CompareAndSwap</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span> <span style="color:#57606a">// No match found</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">value</span> <span style="color:#57606a">// Successfully eliminated!</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Similar logic for Pop...</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This is like having a &ldquo;fast lane&rdquo; where people can directly exchange items without going through the main structure!</p>
<h2 id="the-memory-management-challenge">The Memory Management Challenge</h2>
<p>Imagine you&rsquo;re playing a game of hot potato, but with a twist. Sometimes players might look down at their hands and find they&rsquo;re holding a potato that was thrown away ages ago! This is exactly the problem we face with memory in lock-free programming.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">dangerousCode</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">node</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">list</span><span style="color:#1f2328">.</span><span style="color:#1f2328">head</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>  <span style="color:#57606a">// Get a node reference</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// ... meanwhile, another thread removes and deletes this node ...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Println</span><span style="color:#1f2328">(</span><span style="color:#1f2328">node</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span><span style="color:#1f2328">)</span>   <span style="color:#57606a">// Oops! Accessing freed memory!</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h2 id="hazard-pointers-your-memory-safety-guard">Hazard Pointers: Your Memory Safety Guard</h2>
<p>Think of hazard pointers like putting a &ldquo;Do Not Touch!&rdquo; sticky note on objects you&rsquo;re using. Here&rsquo;s how we implement them in Go:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">HazardPointer</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">pointer</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">active</span>  <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Bool</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">HazardManager</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">hazards</span>    <span style="color:#1f2328">[</span><span style="color:#1f2328">MaxThreads</span><span style="color:#1f2328">]</span><span style="color:#1f2328">HazardPointer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">retired</span>    <span style="color:#1f2328">[]</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">retireLock</span> <span style="color:#1f2328">sync</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Mutex</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">hm</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">HazardManager</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Protect</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ptr</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Node</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Mark this pointer as being used</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">myHazard</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">hm</span><span style="color:#1f2328">.</span><span style="color:#1f2328">hazards</span><span style="color:#1f2328">[</span><span style="color:#6639ba">getCurrentThreadID</span><span style="color:#1f2328">()]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">myHazard</span><span style="color:#1f2328">.</span><span style="color:#1f2328">pointer</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ptr</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">myHazard</span><span style="color:#1f2328">.</span><span style="color:#1f2328">active</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#cf222e">true</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Double-check the pointer is still valid</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#6639ba">isStillValid</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ptr</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">myHazard</span><span style="color:#1f2328">.</span><span style="color:#1f2328">active</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#cf222e">false</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">ptr</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h2 id="epoch-based-reclamation-time-travel-safety">Epoch-Based Reclamation: Time-Travel Safety</h2>
<p>Epoch-based reclamation is like having a time-stamped security system. Instead of protecting individual objects, we protect time periods:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Epoch</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">current</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Uint64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">slots</span>   <span style="color:#1f2328">[</span><span style="color:#0550ae">3</span><span style="color:#1f2328">][]</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span>  <span style="color:#57606a">// Three epochs worth of retired nodes</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">e</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Epoch</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Enter</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">uint64</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">epoch</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">e</span><span style="color:#1f2328">.</span><span style="color:#1f2328">current</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Announce we&#39;re in this epoch</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">myEpochAnnouncement</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#1f2328">epoch</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">epoch</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">e</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Epoch</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Retire</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ptr</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">epoch</span> <span style="color:#cf222e">uint64</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">slot</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">epoch</span> <span style="color:#0550ae">%</span> <span style="color:#0550ae">3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">e</span><span style="color:#1f2328">.</span><span style="color:#1f2328">slots</span><span style="color:#1f2328">[</span><span style="color:#1f2328">slot</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">e</span><span style="color:#1f2328">.</span><span style="color:#1f2328">slots</span><span style="color:#1f2328">[</span><span style="color:#1f2328">slot</span><span style="color:#1f2328">],</span> <span style="color:#1f2328">ptr</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// If all threads have moved past this epoch,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// we can safely free everything in this slot</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">canFreeEpoch</span><span style="color:#1f2328">(</span><span style="color:#1f2328">epoch</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">freeAll</span><span style="color:#1f2328">(</span><span style="color:#1f2328">e</span><span style="color:#1f2328">.</span><span style="color:#1f2328">slots</span><span style="color:#1f2328">[</span><span style="color:#1f2328">slot</span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">e</span><span style="color:#1f2328">.</span><span style="color:#1f2328">slots</span><span style="color:#1f2328">[</span><span style="color:#1f2328">slot</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h2 id="reference-counting-the-collective-tracking-approach">Reference Counting: The Collective Tracking Approach</h2>
<p>Sometimes we need to keep count of how many threads are using an object, like keeping track of how many people are in a room:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">RefCountedNode</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">value</span>     <span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">next</span>      <span style="color:#0550ae">*</span><span style="color:#1f2328">RefCountedNode</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">refCount</span>  <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Int32</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">n</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">RefCountedNode</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Acquire</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">count</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">n</span><span style="color:#1f2328">.</span><span style="color:#1f2328">refCount</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">count</span> <span style="color:#0550ae">&lt;=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">panic</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Acquiring a deleted node!&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">n</span><span style="color:#1f2328">.</span><span style="color:#1f2328">refCount</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwap</span><span style="color:#1f2328">(</span><span style="color:#1f2328">count</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">count</span><span style="color:#0550ae">+</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">n</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">RefCountedNode</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Release</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">n</span><span style="color:#1f2328">.</span><span style="color:#1f2328">refCount</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Add</span><span style="color:#1f2328">(</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Last reference, safe to delete</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">free</span><span style="color:#1f2328">(</span><span style="color:#1f2328">n</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h2 id="a-complete-example-safe-node-removal">A Complete Example: Safe Node Removal</h2>
<p>Let&rsquo;s put it all together with a complete example of safe node removal in a lock-free linked list:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">SafeList</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">head</span>   <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">epochs</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Epoch</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">l</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SafeList</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Remove</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">epoch</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">l</span><span style="color:#1f2328">.</span><span style="color:#1f2328">epochs</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Enter</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">defer</span> <span style="color:#1f2328">l</span><span style="color:#1f2328">.</span><span style="color:#1f2328">epochs</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Exit</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">prev</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">l</span><span style="color:#1f2328">.</span><span style="color:#1f2328">head</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">curr</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">prev</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">curr</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">value</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">next</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">prev</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwap</span><span style="color:#1f2328">(</span><span style="color:#1f2328">curr</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">next</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a">// Successfully unlinked, retire the node</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">l</span><span style="color:#1f2328">.</span><span style="color:#1f2328">epochs</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Retire</span><span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">curr</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">epoch</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">prev</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">curr</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">curr</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">curr</span><span style="color:#1f2328">.</span><span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h2 id="best-practices-and-design-patterns-making-smart-choices-in-lock-free-programming">Best Practices and Design Patterns: Making Smart Choices in Lock-Free Programming</h2>
<p>Imagine you&rsquo;re a chef deciding whether to cook a complex dish or order takeout. Similarly, when building concurrent systems, you need to know when to use lock-free structures and when to stick with simpler solutions. Let&rsquo;s explore this through practical examples and real-world scenarios.</p>
<h2 id="when-to-go-lock-free">When to Go Lock-Free</h2>
<p>Let&rsquo;s start with a simple decision framework, presented as a story:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Scenario 1: Simple counter with low contention</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">SimpleCounter</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">value</span> <span style="color:#cf222e">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">mutex</span> <span style="color:#1f2328">sync</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Mutex</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// This is probably fine! Don&#39;t overcomplicate it</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">c</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SimpleCounter</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Increment</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">mutex</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Lock</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span><span style="color:#0550ae">++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">mutex</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Unlock</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Scenario 2: High-performance queue with many producers/consumers</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">HighPerformanceQueue</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">head</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">tail</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Now we&#39;re talking! Lock-free makes sense here</span>
</span></span></code></pre></div><p>Think of it like choosing transportation: you don&rsquo;t need a Formula 1 car to drive to the grocery store, but you might want one for a racing championship!</p>
<h2 id="design-considerations-the-architecture-phase">Design Considerations: The Architecture Phase</h2>
<p>When building lock-free structures, think like a building architect:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Bad: Mixing locks and lock-free operations</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">HybridStack</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">top</span>  <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">size</span> <span style="color:#cf222e">int</span>  <span style="color:#57606a">// Oops! This needs synchronization</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Good: Fully lock-free design</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">CleanStack</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">top</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Size is calculated on demand or tracked atomically</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">size</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Int64</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">CleanStack</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Size</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">int64</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">size</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h2 id="testing-strategies-catching-the-invisible-bugs">Testing Strategies: Catching the Invisible Bugs</h2>
<p>Testing concurrent code is like trying to catch a ghost – the problems are often invisible until they suddenly appear! Here&rsquo;s how we approach it:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">TestConcurrentStack</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">testing</span><span style="color:#1f2328">.</span><span style="color:#1f2328">T</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">stack</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">NewLockFreeStack</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">const</span> <span style="color:#1f2328">numGoroutines</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">const</span> <span style="color:#1f2328">opsPerGoroutine</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">1000</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Use a WaitGroup to synchronize goroutines</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">wg</span> <span style="color:#1f2328">sync</span><span style="color:#1f2328">.</span><span style="color:#1f2328">WaitGroup</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">wg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">numGoroutines</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Launch multiple goroutines</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span> <span style="color:#1f2328">&lt;</span> <span style="color:#1f2328">numGoroutines</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span><span style="color:#0550ae">++</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">go</span> <span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">id</span> <span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">defer</span> <span style="color:#1f2328">wg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Done</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// Mix operations to create contention</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> <span style="color:#1f2328">j</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">j</span> <span style="color:#1f2328">&lt;</span> <span style="color:#1f2328">opsPerGoroutine</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">j</span><span style="color:#0550ae">++</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#1f2328">j</span><span style="color:#0550ae">%</span><span style="color:#0550ae">2</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">stack</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Push</span><span style="color:#1f2328">(</span><span style="color:#1f2328">j</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">stack</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pop</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}(</span><span style="color:#1f2328">i</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">wg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Wait</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Verify final state</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h2 id="debugging-techniques-finding-the-invisible">Debugging Techniques: Finding the Invisible</h2>
<p>Debugging lock-free code is like being a detective. Here&rsquo;s our toolkit:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">DebugNode</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">value</span>     <span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">next</span>      <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">DebugNode</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">debugInfo</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">threadID</span>    <span style="color:#cf222e">int64</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">operationID</span> <span style="color:#cf222e">int64</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">timestamp</span>   <span style="color:#cf222e">int64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">n</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">DebugNode</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">String</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">string</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sprintf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Node[value=%v, thread=%d, op=%d, time=%d]&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">n</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">n</span><span style="color:#1f2328">.</span><span style="color:#1f2328">debugInfo</span><span style="color:#1f2328">.</span><span style="color:#1f2328">threadID</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">n</span><span style="color:#1f2328">.</span><span style="color:#1f2328">debugInfo</span><span style="color:#1f2328">.</span><span style="color:#1f2328">operationID</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">n</span><span style="color:#1f2328">.</span><span style="color:#1f2328">debugInfo</span><span style="color:#1f2328">.</span><span style="color:#1f2328">timestamp</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h2 id="documentation-your-future-self-will-thank-you">Documentation: Your Future Self Will Thank You</h2>
<p>Good documentation is like leaving a map for future explorers:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// LockFreeQueue implements a multi-producer, multi-consumer queue</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// with the following guarantees:</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//   1. Wait-free enqueue operations</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//   2. Lock-free dequeue operations</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//   3. Preservation of FIFO ordering</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Memory ordering: All operations use acquire/release semantics.</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// ABA prevention: Uses tagged pointers with a 16-bit counter.</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">LockFreeQueue</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">head</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">tail</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Enqueue adds an item to the queue.</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Returns true if successful, false if the queue is full.</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Thread-safety: Safe to call from multiple goroutines.</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Progress: Wait-free. Completes in O(1) steps.</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">q</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeQueue</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Enqueue</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Implementation...</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h2 id="real-world-integration-tips">Real-World Integration Tips</h2>
<p>When integrating lock-free structures into existing systems:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Wrapper pattern for gradual adoption</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">SafeWrapper</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">internal</span>    <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeQueue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">monitoring</span>  <span style="color:#0550ae">*</span><span style="color:#1f2328">Metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">isEnabled</span>   <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Bool</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">w</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SafeWrapper</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Enqueue</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#1f2328">isEnabled</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">start</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Now</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">result</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#1f2328">internal</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Enqueue</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#1f2328">monitoring</span><span style="color:#1f2328">.</span><span style="color:#6639ba">RecordLatency</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;enqueue&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Since</span><span style="color:#1f2328">(</span><span style="color:#1f2328">start</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">result</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Fallback to traditional implementation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#6639ba">legacyEnqueue</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h2 id="real-world-applications-lock-free-programming-in-the-wild">Real-World Applications: Lock-Free Programming in the Wild</h2>
<p>Let&rsquo;s dive into some real-world scenarios where lock-free programming shines. Think of these as cooking recipes that have been battle-tested in professional kitchens!</p>
<h3 id="case-study-1-high-performance-message-queue">Case Study 1: High-Performance Message Queue</h3>
<p>Imagine you&rsquo;re building a system like Discord, where millions of messages need to be processed in real-time:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">MessageBroker</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">queues</span>    <span style="color:#1f2328">[]</span><span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeQueue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">producers</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Uint64</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">mb</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">MessageBroker</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">PublishMessage</span><span style="color:#1f2328">(</span><span style="color:#1f2328">msg</span> <span style="color:#1f2328">Message</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Distribute messages across queues using a lock-free approach</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">queueIndex</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">mb</span><span style="color:#1f2328">.</span><span style="color:#1f2328">producers</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Add</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">%</span> <span style="color:#6639ba">uint64</span><span style="color:#1f2328">(</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">mb</span><span style="color:#1f2328">.</span><span style="color:#1f2328">queues</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">queue</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">mb</span><span style="color:#1f2328">.</span><span style="color:#1f2328">queues</span><span style="color:#1f2328">[</span><span style="color:#1f2328">queueIndex</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">queue</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Enqueue</span><span style="color:#1f2328">(</span><span style="color:#1f2328">msg</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// If queue is full, try next one</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">queueIndex</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">queueIndex</span> <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">%</span> <span style="color:#6639ba">uint64</span><span style="color:#1f2328">(</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">mb</span><span style="color:#1f2328">.</span><span style="color:#1f2328">queues</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">queue</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">mb</span><span style="color:#1f2328">.</span><span style="color:#1f2328">queues</span><span style="color:#1f2328">[</span><span style="color:#1f2328">queueIndex</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This is like having multiple conveyor belts in a package sorting facility – if one belt gets full, packages automatically go to the next one!</p>
<h3 id="case-study-2-real-time-gaming-server">Case Study 2: Real-Time Gaming Server</h3>
<p>Here&rsquo;s how a game server might track player positions without locking:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">PlayerPosition</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">x</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">y</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">z</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Float64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">updated</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Int64</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">GameWorld</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">players</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#1f2328">PlayerID</span><span style="color:#1f2328">]</span><span style="color:#0550ae">*</span><span style="color:#1f2328">PlayerPosition</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">grid</span>    <span style="color:#1f2328">[][]</span><span style="color:#0550ae">*</span><span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">PlayerList</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">w</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">GameWorld</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">UpdatePosition</span><span style="color:#1f2328">(</span><span style="color:#1f2328">playerID</span> <span style="color:#1f2328">PlayerID</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">x</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">y</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">z</span> <span style="color:#cf222e">float64</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">pos</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#1f2328">players</span><span style="color:#1f2328">[</span><span style="color:#1f2328">playerID</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">pos</span><span style="color:#1f2328">.</span><span style="color:#1f2328">x</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#1f2328">x</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">pos</span><span style="color:#1f2328">.</span><span style="color:#1f2328">y</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#1f2328">y</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">pos</span><span style="color:#1f2328">.</span><span style="color:#1f2328">z</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#1f2328">z</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">pos</span><span style="color:#1f2328">.</span><span style="color:#1f2328">updated</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Now</span><span style="color:#1f2328">().</span><span style="color:#6639ba">UnixNano</span><span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Update grid position without locks</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#6639ba">updateGrid</span><span style="color:#1f2328">(</span><span style="color:#1f2328">playerID</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">x</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">y</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">z</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>Think of it like an air traffic control system where each plane&rsquo;s position needs to be updated without making other planes wait!</p>
<h3 id="case-study-3-high-frequency-trading-system">Case Study 3: High-Frequency Trading System</h3>
<p>Here&rsquo;s a simplified version of how trading systems handle orders:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">OrderBook</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">buyOrders</span>  <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeSkipList</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">sellOrders</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeSkipList</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">trades</span>     <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeQueue</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">ob</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">OrderBook</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">PlaceOrder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">order</span> <span style="color:#1f2328">Order</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Trade</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">order</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Type</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">Buy</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Look for matching sell orders</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">match</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">ob</span><span style="color:#1f2328">.</span><span style="color:#1f2328">sellOrders</span><span style="color:#1f2328">.</span><span style="color:#6639ba">FindAndRemove</span><span style="color:#1f2328">(</span><span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">o</span> <span style="color:#1f2328">Order</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">o</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Price</span> <span style="color:#0550ae">&lt;=</span> <span style="color:#1f2328">order</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Price</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">match</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">trade</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">Trade</span><span style="color:#1f2328">{</span><span style="color:#1f2328">BuyOrder</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">order</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">SellOrder</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">match</span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">ob</span><span style="color:#1f2328">.</span><span style="color:#1f2328">trades</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Enqueue</span><span style="color:#1f2328">(</span><span style="color:#1f2328">trade</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">trade</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// No match, add to buy orders</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">ob</span><span style="color:#1f2328">.</span><span style="color:#1f2328">buyOrders</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Insert</span><span style="color:#1f2328">(</span><span style="color:#1f2328">order</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Similar logic for sell orders...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This is like a super-fast matchmaking system for buyers and sellers where every microsecond counts!</p>
<h3 id="integration-with-existing-codebases">Integration with Existing Codebases</h3>
<p>Here&rsquo;s how you might gradually introduce lock-free structures into an existing system:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">HybridCache</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">modern</span>  <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeHashMap</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">legacy</span>  <span style="color:#0550ae">*</span><span style="color:#1f2328">sync</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Map</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">useModern</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Bool</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">c</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">HybridCache</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Get</span><span style="color:#1f2328">(</span><span style="color:#1f2328">key</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{},</span> <span style="color:#cf222e">bool</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">useModern</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">modern</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Get</span><span style="color:#1f2328">(</span><span style="color:#1f2328">key</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">legacy</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">(</span><span style="color:#1f2328">key</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">c</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">HybridCache</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">EnableModernCache</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Migrate data in the background</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">go</span> <span style="color:#cf222e">func</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">legacy</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Range</span><span style="color:#1f2328">(</span><span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">key</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">value</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">modern</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Put</span><span style="color:#1f2328">(</span><span style="color:#1f2328">key</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">value</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">useModern</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#cf222e">true</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}()</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h3 id="monitoring-and-observability">Monitoring and Observability</h3>
<p>Just like a Formula 1 car needs telemetry, lock-free systems need monitoring:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">MetricsCollector</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">operations</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Uint64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">retries</span>    <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Uint64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">latencies</span>  <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeHistogram</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">mc</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">MetricsCollector</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">RecordOperation</span><span style="color:#1f2328">(</span><span style="color:#1f2328">start</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Time</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">retryCount</span> <span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">mc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">operations</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Add</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">mc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">retries</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Add</span><span style="color:#1f2328">(</span><span style="color:#6639ba">uint64</span><span style="color:#1f2328">(</span><span style="color:#1f2328">retryCount</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">mc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">latencies</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Record</span><span style="color:#1f2328">(</span><span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Since</span><span style="color:#1f2328">(</span><span style="color:#1f2328">start</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Microseconds</span><span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">mc</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">MetricsCollector</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">GetMetrics</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">Metrics</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">Metrics</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">OperationCount</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">mc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">operations</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">RetryRate</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">float64</span><span style="color:#1f2328">(</span><span style="color:#1f2328">mc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">retries</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">())</span> <span style="color:#0550ae">/</span> <span style="color:#6639ba">float64</span><span style="color:#1f2328">(</span><span style="color:#1f2328">mc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">operations</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">AverageLatency</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">mc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">latencies</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Average</span><span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h3 id="failure-modes-and-recovery">Failure Modes and Recovery</h3>
<p>Even the best systems can fail. Here&rsquo;s how we handle failures gracefully:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">ResilientQueue</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">primary</span>   <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeQueue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">backup</span>    <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeQueue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">isHealthy</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Bool</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">q</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ResilientQueue</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Enqueue</span><span style="color:#1f2328">(</span><span style="color:#1f2328">item</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">isHealthy</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Try primary queue first</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">primary</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Enqueue</span><span style="color:#1f2328">(</span><span style="color:#1f2328">item</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Primary failed, try failover</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#6639ba">tryFailover</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Retry with backup as primary</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">backup</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Enqueue</span><span style="color:#1f2328">(</span><span style="color:#1f2328">item</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">q</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ResilientQueue</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">tryFailover</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Only one goroutine should perform failover</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">isHealthy</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwap</span><span style="color:#1f2328">(</span><span style="color:#cf222e">true</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">false</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Record failover metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">stats</span><span style="color:#1f2328">.</span><span style="color:#1f2328">failoverCount</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Add</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">stats</span><span style="color:#1f2328">.</span><span style="color:#1f2328">lastFailover</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Now</span><span style="color:#1f2328">().</span><span style="color:#6639ba">UnixNano</span><span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Swap primary and backup</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">temp</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">primary</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">primary</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">backup</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">backup</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">temp</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Mark system as healthy again</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">isHealthy</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#cf222e">true</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>Imagine you&rsquo;re standing at the edge of a technological frontier. Lock-free programming is evolving rapidly, just like how cars evolved from Model T&rsquo;s to Teslas. Let&rsquo;s explore what&rsquo;s on the horizon!</p>
<h2 id="emerging-patterns-the-new-wave">Emerging Patterns: The New Wave</h2>
<p>Think of these patterns like cooking techniques that are gaining popularity in modern kitchens:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// The future of shared memory: Memory Pools</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">ZeroAllocationQueue</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">pool</span>  <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreePool</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">head</span>  <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">tail</span>  <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">Node</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">q</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ZeroAllocationQueue</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Enqueue</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Get a pre-allocated node from the pool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">node</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">pool</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Acquire</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">node</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">value</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">tail</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tail</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tail</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwap</span><span style="color:#1f2328">(</span><span style="color:#1f2328">tail</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">node</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Someone else won - return node to pool</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">pool</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Release</span><span style="color:#1f2328">(</span><span style="color:#1f2328">node</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This is like having a magical kitchen where utensils clean and store themselves automatically!</p>
<h2 id="hardware-trends-the-new-kitchen-appliances">Hardware Trends: The New Kitchen Appliances</h2>
<p>Modern CPUs are introducing new instructions that make lock-free programming easier:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Future hardware might support these directly</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">WaitFreeRegister</span><span style="color:#1f2328">[</span><span style="color:#1f2328">T</span> <span style="color:#cf222e">any</span><span style="color:#1f2328">]</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">value</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">[</span><span style="color:#1f2328">T</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">r</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">WaitFreeRegister</span><span style="color:#1f2328">[</span><span style="color:#1f2328">T</span><span style="color:#1f2328">])</span> <span style="color:#6639ba">WriteWithoutContention</span><span style="color:#1f2328">(</span><span style="color:#1f2328">new</span> <span style="color:#1f2328">T</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Imaginary future CPU instruction</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// that guarantees no contention</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">atomicWriteNoContention</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">new</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>It&rsquo;s like getting a new kitchen appliance that makes previously complex tasks simple!</p>
<h2 id="new-atomic-primitives-better-building-blocks">New Atomic Primitives: Better Building Blocks</h2>
<p>The future might bring us more powerful atomic operations:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Hypothetical future atomic operations</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">FutureAtomics</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Atomic fetch-and-multiply</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">FetchAndMul</span> <span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">addr</span> <span style="color:#0550ae">*</span><span style="color:#cf222e">uint64</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">val</span> <span style="color:#cf222e">uint64</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">uint64</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Atomic conditional update</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">UpdateIf</span> <span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">addr</span> <span style="color:#0550ae">*</span><span style="color:#cf222e">uint64</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">update</span> <span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">old</span> <span style="color:#cf222e">uint64</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">new</span> <span style="color:#cf222e">uint64</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ok</span> <span style="color:#cf222e">bool</span><span style="color:#1f2328">))</span> <span style="color:#cf222e">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Using these new primitives</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">SmartCounter</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">value</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Uint64</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">c</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SmartCounter</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">MultiplyIfEven</span><span style="color:#1f2328">(</span><span style="color:#1f2328">factor</span> <span style="color:#cf222e">uint64</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">UpdateIf</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">old</span> <span style="color:#cf222e">uint64</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">uint64</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">bool</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">old</span><span style="color:#0550ae">%</span><span style="color:#0550ae">2</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">old</span> <span style="color:#0550ae">*</span> <span style="color:#1f2328">factor</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">old</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h2 id="research-directions-the-laboratory">Research Directions: The Laboratory</h2>
<p>Researchers are exploring fascinating new territories:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Experimental: Self-adjusting data structures</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">AdaptiveLockFreeQueue</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">queues</span>      <span style="color:#1f2328">[]</span><span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeQueue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">contention</span>  <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Uint64</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Automatically adjusts based on contention</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">q</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">AdaptiveLockFreeQueue</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">adjust</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">contention</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">&gt;</span> <span style="color:#1f2328">threshold</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// Split into multiple queues</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#6639ba">split</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// Merge queues</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#6639ba">merge</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Experimental: Quantum-resistant lock-free algorithms</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">QuantumSafeRegister</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Future-proof against quantum computers</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">value</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Value</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">hash</span>  <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Value</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h2 id="the-grand-vision-whats-coming-next">The Grand Vision: What&rsquo;s Coming Next?</h2>
<ol>
<li><strong>Composable Lock-Free Structures</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Future: Building complex structures from simple ones</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">ComposableLockFree</span><span style="color:#1f2328">[</span><span style="color:#1f2328">T</span> <span style="color:#cf222e">any</span><span style="color:#1f2328">]</span> <span style="color:#cf222e">interface</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">Atomic</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">Compose</span><span style="color:#1f2328">(</span><span style="color:#1f2328">other</span> <span style="color:#1f2328">ComposableLockFree</span><span style="color:#1f2328">[</span><span style="color:#1f2328">T</span><span style="color:#1f2328">])</span> <span style="color:#1f2328">ComposableLockFree</span><span style="color:#1f2328">[</span><span style="color:#1f2328">T</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><ol start="2">
<li><strong>Self-Healing Data Structures</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">SelfHealingQueue</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">health</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Value</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">q</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SelfHealingQueue</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">monitor</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#6639ba">detect_anomaly</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#6639ba">self_repair</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sleep</span><span style="color:#1f2328">(</span><span style="color:#1f2328">monitorInterval</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><ol start="3">
<li><strong>AI-Assisted Lock-Free Programming</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Future tools might automatically verify and optimize</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">AutoVerifiedQueue</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// AI-verified properties</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">properties</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">LinearizabilityVerified</span> <span style="color:#cf222e">bool</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">WaitFreeGuaranteed</span>     <span style="color:#cf222e">bool</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">MemorySafe</span>             <span style="color:#cf222e">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h2 id="closing-thoughts">Closing Thoughts</h2>
<p>Lock-free programming is like space exploration – we&rsquo;ve come far, but there&rsquo;s still so much to discover. The future holds:</p>
<ul>
<li>More hardware support for atomic operations</li>
<li>Better tools for verification and testing</li>
<li>New patterns for composing lock-free structures</li>
<li>Increased focus on energy efficiency</li>
<li>Integration with emerging technologies like quantum computing</li>
</ul>
<p>The key is to stay curious and keep experimenting. As we&rsquo;ve seen throughout this journey, lock-free programming is challenging but incredibly rewarding. It&rsquo;s a field where creativity meets precision, and the possibilities are endless.</p>
<h2 id="building-a-resilient-lock-free-queue">Building a Resilient Lock-Free Queue</h2>
<p>Here&rsquo;s a complete implementation of a resilient queue that can handle failures and provides automatic failover:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;sync/atomic&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// ResilientQueue implements a fault-tolerant queue with primary and backup storage</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">ResilientQueue</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">primary</span>    <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeQueue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">backup</span>     <span style="color:#0550ae">*</span><span style="color:#1f2328">LockFreeQueue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">isHealthy</span>  <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">stats</span>      <span style="color:#0550ae">*</span><span style="color:#1f2328">QueueStats</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// QueueStats tracks operational metrics</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">QueueStats</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">enqueueCount</span>   <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Uint64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">dequeueCount</span>   <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Uint64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">failoverCount</span>  <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Uint64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">lastFailover</span>   <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Int64</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// NewResilientQueue creates a new fault-tolerant queue</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewResilientQueue</span><span style="color:#1f2328">()</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ResilientQueue</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">q</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">ResilientQueue</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">primary</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">NewLockFreeQueue</span><span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">backup</span><span style="color:#1f2328">:</span>  <span style="color:#6639ba">NewLockFreeQueue</span><span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">stats</span><span style="color:#1f2328">:</span>   <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">QueueStats</span><span style="color:#1f2328">{},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">isHealthy</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#cf222e">true</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">q</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">var</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ErrQueueFull</span>      <span style="color:#1f2328">=</span> <span style="color:#1f2328">errors</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;queue is full&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ErrQueueEmpty</span>     <span style="color:#1f2328">=</span> <span style="color:#1f2328">errors</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;queue is empty&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ErrSystemUnhealthy</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">errors</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;system is in unhealthy state&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Enqueue adds an item to the queue with automatic failover</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">q</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ResilientQueue</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Enqueue</span><span style="color:#1f2328">(</span><span style="color:#1f2328">item</span> <span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#cf222e">error</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">isHealthy</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">ErrSystemUnhealthy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Try primary queue first</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">primary</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Enqueue</span><span style="color:#1f2328">(</span><span style="color:#1f2328">item</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">stats</span><span style="color:#1f2328">.</span><span style="color:#1f2328">enqueueCount</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Add</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Mirror to backup</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">backup</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Enqueue</span><span style="color:#1f2328">(</span><span style="color:#1f2328">item</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Primary failed, try failover</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#6639ba">tryFailover</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Retry with backup as primary</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">backup</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Enqueue</span><span style="color:#1f2328">(</span><span style="color:#1f2328">item</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">stats</span><span style="color:#1f2328">.</span><span style="color:#1f2328">enqueueCount</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Add</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">ErrQueueFull</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Dequeue removes and returns an item from the queue</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">q</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ResilientQueue</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Dequeue</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{},</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">isHealthy</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ErrSystemUnhealthy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Try primary queue first</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">item</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ok</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">primary</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Dequeue</span><span style="color:#1f2328">();</span> <span style="color:#1f2328">ok</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">stats</span><span style="color:#1f2328">.</span><span style="color:#1f2328">dequeueCount</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Add</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Keep backup in sync</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">backup</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Dequeue</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">item</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Primary failed, try failover</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#6639ba">tryFailover</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Retry with backup as primary</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">item</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ok</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">backup</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Dequeue</span><span style="color:#1f2328">();</span> <span style="color:#1f2328">ok</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">stats</span><span style="color:#1f2328">.</span><span style="color:#1f2328">dequeueCount</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Add</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">item</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ErrQueueEmpty</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// tryFailover attempts to switch to backup queue</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">q</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ResilientQueue</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">tryFailover</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Only one goroutine should perform failover</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">isHealthy</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwap</span><span style="color:#1f2328">(</span><span style="color:#cf222e">true</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">false</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Record failover metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">stats</span><span style="color:#1f2328">.</span><span style="color:#1f2328">failoverCount</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Add</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">stats</span><span style="color:#1f2328">.</span><span style="color:#1f2328">lastFailover</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Now</span><span style="color:#1f2328">().</span><span style="color:#6639ba">UnixNano</span><span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Swap primary and backup</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">temp</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">primary</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">primary</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">backup</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">backup</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">temp</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Mark system as healthy again</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">isHealthy</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#cf222e">true</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// GetStats returns current queue statistics</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">q</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ResilientQueue</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">GetStats</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">QueueStats</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">QueueStats</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">enqueueCount</span><span style="color:#1f2328">:</span>  <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">stats</span><span style="color:#1f2328">.</span><span style="color:#1f2328">enqueueCount</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">dequeueCount</span><span style="color:#1f2328">:</span>  <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">stats</span><span style="color:#1f2328">.</span><span style="color:#1f2328">dequeueCount</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">failoverCount</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">stats</span><span style="color:#1f2328">.</span><span style="color:#1f2328">failoverCount</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">lastFailover</span><span style="color:#1f2328">:</span>  <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">stats</span><span style="color:#1f2328">.</span><span style="color:#1f2328">lastFailover</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// IsHealthy returns the current health status</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">q</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ResilientQueue</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">IsHealthy</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">isHealthy</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Size returns the number of items in the primary queue</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">q</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ResilientQueue</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Size</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">int</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">isHealthy</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">primary</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Size</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">q</span><span style="color:#1f2328">.</span><span style="color:#1f2328">backup</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Size</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This implementation provides several important features:</p>
<ol>
<li><strong>Automatic Failover</strong>: Seamlessly switches to backup queue if primary fails</li>
<li><strong>Data Consistency</strong>: Maintains consistency between primary and backup queues</li>
<li><strong>Health Monitoring</strong>: Tracks system health and operation statistics</li>
<li><strong>Thread Safety</strong>: All operations are lock-free and thread-safe</li>
<li><strong>Error Handling</strong>: Proper error handling for all edge cases</li>
<li><strong>Metrics</strong>: Comprehensive statistics for monitoring and debugging</li>
</ol>
<p>The <code>ResilientQueue</code> can be used in high-availability systems where data loss is not acceptable. It automatically handles failures and provides monitoring capabilities through its stats interface.</p>


<div class="mt-6 py-6 border-gray-200 border-t flex justify-between">
    
    <a href="/go/concurrency-and-worker-pools/" class="pr-4">&larr; The Evolution of Concurrency Patterns in Go: From Goroutines to Advanced Worker Pools</a>
    
        
</div>



    </article>
    </div>
    <footer class="container mx-auto pl-5 pt-3 pb-5 mt-32 border-t border-gray-400">
        <div class="text-xs text-gray-700 float-right h-24">
            &copy; 2025 Prasanth Janardhanan
        </div>
    </footer>
</body>
</html>

