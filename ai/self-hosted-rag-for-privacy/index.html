<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Self-Hosted RAG Architecture for Privacy-Sensitive Document Search with Golang </title><meta name="keywords" content="rag, search privacy" /><meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/css/styles.css" />
</head>
<body class="antialiased text-grey-900">
    
    <div class="container mx-auto max-w-screen-lg">
    <header class="flex items-center justify-between h-16 px-3 border-b border-gray-300">
    <div >
        <a href="/" class="flex items-center">
            <span class="text-lg text-gray-800 font-semibold">Prasanth Janardhanan</span>
        </a>
    </div>
    <div>
        <ul class="flex">
            <li class="t ml-5 text-md text-gray-700 hover:text-red-800"><a href="/" class="hover:underline">Articles</a></li>
            <li class="t ml-5 text-md text-gray-700 hover:text-red-800"><a href="/projects/" class="hover:underline">Projects</a></li>
            <li class="t ml-5 text-md text-gray-700 hover:text-red-800"><a href="/about/" class="hover:underline">About</a></li>
        </ul>
    </div>
</header>
    
    <article class="mt-6 mx-auto md:w-9/12 min-h-screen">
<h1 class="mt-5">Self-Hosted RAG Architecture for Privacy-Sensitive Document Search with Golang</h1>
<ul class="flex mb-2 list-none px-0 text-sm mt-0 ml-0 pt-0">
    
      <li class="pr-4 list-none">&#x1f3f7; <a href="/tags/rag" class="text-gray-600">rag</a> </li>
    
      <li class="pr-4 list-none">&#x1f3f7; <a href="/tags/search-privacy" class="text-gray-600">search privacy</a> </li>
    
</ul>
  
<p>Remember the days of boolean search operators? The frustrating experience of trying to find that one document by guessing the exact keywords it might contain? For decades, our ability to search through documents has been limited by keyword matching—a primitive approach that fails to capture the richness of human language and intent.</p>
<p>Traditional search technology has evolved through several stages: from basic keyword matching to more sophisticated approaches involving stemming, lemmatization, and eventually, statistical methods like TF-IDF (Term Frequency-Inverse Document Frequency). Each iteration brought incremental improvements, but they all shared a fundamental limitation—they didn&rsquo;t truly understand the meaning behind our queries.</p>
<h3 id="limitations-of-traditional-search-approaches">Limitations of Traditional Search Approaches</h3>
<h4 id="keyword-based-search-shortcomings">Keyword-Based Search Shortcomings</h4>
<p><img src="../images/keyword-vs-contextual.png" alt="Keyword based vs Semantic"></p>
<p>Keyword search engines operate on a simple principle: match the exact words in the query with words in the documents. This approach fails in numerous scenarios:</p>
<ul>
<li><strong>Synonyms and related concepts</strong>: When a document uses &ldquo;automobile&rdquo; but you search for &ldquo;car&rdquo;</li>
<li><strong>Contextual meaning</strong>: &ldquo;Java&rdquo; could refer to the programming language, the island, or coffee</li>
<li><strong>Intent understanding</strong>: The query &ldquo;how to improve database performance&rdquo; won&rsquo;t necessarily match a document titled &ldquo;MySQL optimization techniques&rdquo; even though it&rsquo;s relevant</li>
<li><strong>Complex questions</strong>: &ldquo;What are the environmental impacts of our manufacturing process described in last year&rsquo;s sustainability report?&rdquo; requires understanding across multiple concepts</li>
</ul>
<p>Despite sophisticated ranking algorithms, keyword search fundamentally operates at the surface level of text, not at the level of meaning.</p>
<h4 id="semantic-search-limitations">Semantic Search Limitations</h4>
<p>The next evolution was semantic search, which attempted to address some of these limitations by understanding relationships between words and concepts. Technologies like word embeddings (Word2Vec, GloVe) and more recently, contextual embeddings like BERT, improved search relevance by capturing semantic similarities.</p>
<p>However, even semantic search has significant limitations:</p>
<ul>
<li>Limited understanding of nuanced queries</li>
<li>Difficulty with ambiguous language</li>
<li>Inability to synthesize information across multiple documents</li>
<li>Poor performance with complex, conversational queries</li>
<li>No capacity to generate new information based on the document content</li>
</ul>
<h4 id="the-data-silo-problem">The &ldquo;Data Silo&rdquo; Problem</h4>
<p><img src="../images/data-reachability.png" alt="Data Silo Problem"></p>
<p>Beyond technological limitations, traditional search approaches often suffer from the &ldquo;data silo&rdquo; problem. Organizations typically store information across multiple disconnected systems: document management systems, email archives, CRM databases, shared drives, and more. This fragmentation makes comprehensive search nearly impossible, as each system has its own search capabilities and limitations.</p>
<p>The result? Critical information becomes isolated, inaccessible, or simply too difficult to find. Knowledge workers spend an estimated 20% of their time searching for information, with much of that time wasted on unsuccessful queries.</p>
<h3 id="the-llm-revolution-in-search">The LLM Revolution in Search</h3>
<p>Enter Large Language Models (LLMs) like GPT-4, Claude, and Llama. These models have fundamentally changed what&rsquo;s possible in information retrieval by understanding language at a much deeper level than previous technologies.</p>
<h4 id="how-llms-understand-context-and-meaning">How LLMs Understand Context and Meaning</h4>
<p>LLMs are trained on vast corpora of text, developing an internal representation of language that captures subtleties of meaning, context, and relationships between concepts. They understand:</p>
<ul>
<li>Synonyms and related concepts naturally</li>
<li>Contextual word usage</li>
<li>Domain-specific terminology</li>
<li>Idiomatic expressions</li>
<li>Complex linguistic structures</li>
</ul>
<p>Most importantly, LLMs don&rsquo;t just match patterns—they understand meaning and can generate new text based on that understanding.</p>
<h4 id="natural-language-queries-vs-keyword-queries">Natural Language Queries vs. Keyword Queries</h4>
<p>With LLMs, users can finally search as they think. Instead of trying to guess the perfect keywords, they can ask questions in natural language:</p>
<ul>
<li>&ldquo;What did our CEO say about the new product launch in last quarter&rsquo;s town hall?&rdquo;</li>
<li>&ldquo;Find me all documents discussing customer churn in the telecommunications sector from the past two years&rdquo;</li>
<li>&ldquo;Summarize our company&rsquo;s policy on remote work and how it has evolved since 2020&rdquo;</li>
</ul>
<p>The ability to use natural language dramatically lowers the cognitive load on users and improves search effectiveness.</p>
<h4 id="real-world-examples-where-llm-powered-search-excels">Real-World Examples Where LLM-Powered Search Excels</h4>
<p>LLM-powered search demonstrates clear advantages in numerous scenarios:</p>
<ol>
<li><strong>Legal discovery</strong>: Finding relevant case precedents based on factual similarities rather than keyword matches</li>
<li><strong>Healthcare</strong>: Retrieving patient records based on natural language descriptions of symptoms or treatment outcomes</li>
<li><strong>Customer support</strong>: Instantly finding relevant knowledge base articles that answer a customer&rsquo;s question</li>
<li><strong>Research</strong>: Connecting disparate studies and findings across a large corpus of academic papers</li>
<li><strong>Technical troubleshooting</strong>: Matching error messages and symptoms to solutions even when terminology differs</li>
</ol>
<p>In each case, LLMs excel by understanding the intent behind queries and the meaning within documents—not just matching words.</p>
<h3 id="the-privacy-challenge-with-commercial-llm-solutions">The Privacy Challenge with Commercial LLM Solutions</h3>
<p>Despite their power, commercial LLM solutions present a significant challenge for organizations dealing with sensitive information: privacy.</p>
<p>Most commercial LLM services require sending your documents and queries to third-party servers. For many organizations, this is simply unacceptable:</p>
<ul>
<li><strong>Legal firms</strong> can&rsquo;t risk client confidentiality</li>
<li><strong>Healthcare providers</strong> must maintain HIPAA compliance</li>
<li><strong>Financial institutions</strong> need to protect customer data</li>
<li><strong>Government agencies</strong> often handle classified information</li>
<li><strong>Companies</strong> need to protect intellectual property and trade secrets</li>
</ul>
<p>Even with assurances about data handling, the very act of sending sensitive documents outside the organization&rsquo;s security perimeter introduces unacceptable risk.</p>
<h3 id="the-case-for-self-hosted-rag-architecture">The Case for Self-Hosted RAG Architecture</h3>
<p>Retrieval-Augmented Generation (RAG) offers a compelling solution to both the search limitations and privacy challenges. RAG combines:</p>
<ol>
<li>A retrieval component that finds relevant documents</li>
<li>A generation component that synthesizes information into coherent, useful responses</li>
</ol>
<p>By implementing RAG architecture on self-hosted infrastructure, organizations can:</p>
<ul>
<li>Keep sensitive documents within their security perimeter</li>
<li>Customize the search experience for their specific needs</li>
<li>Control costs and resource allocation</li>
<li>Ensure compliance with regulatory requirements</li>
<li>Maintain performance at scale</li>
</ul>
<p><img src="../images/unified-data-control.png" alt="Unified data control"></p>
<h3 id="overview-of-our-approach-using-golang">Overview of Our Approach Using Golang</h3>
<p>This article presents a comprehensive approach to building a self-hosted RAG system using Golang. We&rsquo;ve chosen Go for several compelling reasons:</p>
<ul>
<li><strong>Performance</strong>: Go&rsquo;s efficient memory usage and concurrency model make it ideal for handling high-throughput search queries</li>
<li><strong>Simplicity</strong>: Go&rsquo;s straightforward syntax and strong typing reduce the risk of bugs in production</li>
<li><strong>Cross-platform compatibility</strong>: Easy deployment across various operating systems</li>
<li><strong>Rich ecosystem</strong>: Growing number of libraries for working with vector databases and LLMs</li>
<li><strong>Low resource requirements</strong>: Efficient execution without the overhead of interpreted languages</li>
</ul>
<p>In the following sections, we&rsquo;ll explore the key components of our architecture:</p>
<ol>
<li>Understanding the fundamentals of RAG and how it improves search</li>
<li>Establishing clear system requirements and design goals</li>
<li>Selecting and configuring the right vector database</li>
<li>Choosing appropriate embedding models for private deployments</li>
<li>Building an efficient document processing pipeline</li>
<li>Developing a powerful search API</li>
<li>Integrating with language models while maintaining privacy</li>
</ol>
<p>By the end of this article, you&rsquo;ll have a blueprint for implementing a privacy-preserving, high-performance document search system that leverages the power of modern language models without compromising security.</p>
<p>Let&rsquo;s begin by diving deeper into the RAG architecture and how it fundamentally changes document search capabilities.</p>
<h3 id="what-is-retrieval-augmented-generation">What is Retrieval-Augmented Generation?</h3>
<p>Retrieval-Augmented Generation (RAG) represents a paradigm shift in how we approach information retrieval and natural language processing tasks. At its core, RAG combines two powerful capabilities:</p>
<ol>
<li><strong>Retrieval</strong>: Finding relevant information from a knowledge base</li>
<li><strong>Generation</strong>: Creating coherent, contextually appropriate responses based on that information</li>
</ol>
<p>Unlike traditional search that simply returns links or document snippets, RAG synthesizes information into direct, comprehensive answers. And unlike pure language models that rely solely on their internal parameters, RAG grounds its responses in specific, retrievable documents.</p>
<p>The term &ldquo;Retrieval-Augmented Generation&rdquo; was first introduced by researchers at Facebook AI (now Meta AI) in 2020, who demonstrated that augmenting language models with retrieval mechanisms significantly improved factual accuracy and reduced hallucinations. Since then, RAG has evolved into a fundamental architecture for numerous applications, from question-answering systems to conversational AI.</p>
<h3 id="core-components-of-a-rag-system">Core Components of a RAG System</h3>
<p>A fully functional RAG system consists of several key components working in concert:</p>
<h4 id="document-processing-pipeline">Document Processing Pipeline</h4>
<p>Before any retrieval can happen, documents must be processed into a format suitable for semantic search. This pipeline typically includes:</p>
<ul>
<li><strong>Document loading</strong>: Ingesting files from various sources and formats (PDFs, Word documents, HTML, etc.)</li>
<li><strong>Text extraction</strong>: Parsing the documents to extract clean text content</li>
<li><strong>Chunking</strong>: Breaking long documents into smaller, manageable pieces</li>
<li><strong>Metadata extraction</strong>: Capturing relevant information about each document (author, date, source, etc.)</li>
</ul>
<p>The chunking step is particularly important, as it determines the granularity of retrieval. Chunks that are too large may contain irrelevant information; chunks that are too small may lose context.</p>
<h4 id="vector-embeddings-and-their-importance">Vector Embeddings and Their Importance</h4>
<p>At the heart of modern RAG systems are vector embeddings—dense numerical representations of text that capture semantic meaning. These embeddings are generated by neural network models trained on vast corpora of text.</p>
<p>The key property of these embeddings is that texts with similar meanings have similar vector representations in the embedding space, regardless of the specific words used. This enables semantic search based on meaning rather than keywords.</p>
<p>For example, the queries &ldquo;how to speed up my database&rdquo; and &ldquo;techniques for database performance improvement&rdquo; would have similar vector representations despite using different words.</p>
<p>Several embedding models are available, ranging from open-source options like SentenceTransformers to commercial offerings from OpenAI, Cohere, and others. The quality of these embeddings directly impacts retrieval accuracy.</p>
<h4 id="vector-database-for-efficient-retrieval">Vector Database for Efficient Retrieval</h4>
<p>Once documents are processed and embeddings generated, they need to be stored in a way that enables efficient similarity search. This is where vector databases come in.</p>
<p>Vector databases are specialized data stores optimized for:</p>
<ul>
<li><strong>Similarity search</strong>: Finding vectors closest to a query vector</li>
<li><strong>Filtering</strong>: Narrowing search results based on metadata</li>
<li><strong>Scalability</strong>: Handling millions or billions of vectors</li>
<li><strong>Performance</strong>: Returning results with low latency</li>
</ul>
<p>Popular vector databases include Weaviate, Milvus, Chroma, and Postgres with pgvector extension, each with different features, performance characteristics, and integration capabilities.</p>
<h4 id="language-model-for-generation">Language Model for Generation</h4>
<p>The final component is a language model that generates coherent responses based on the retrieved information. This could be:</p>
<ul>
<li>A fully local LLM like Llama, Mistral, or Vicuna</li>
<li>A commercial API-based model like GPT-4 or Claude</li>
<li>A smaller, task-specific model fine-tuned for your domain</li>
</ul>
<p>The language model takes the user query and the retrieved context as input, then generates a natural language response that answers the query based on the provided information.</p>
<h3 id="how-rag-improves-search-accuracy-and-relevance">How RAG Improves Search Accuracy and Relevance</h3>
<p>RAG offers several significant advantages over traditional search approaches:</p>
<ol>
<li><strong>Semantic understanding</strong>: RAG captures the meaning of queries and documents, not just keywords</li>
<li><strong>Context awareness</strong>: The language model considers all retrieved information together, making connections across documents</li>
<li><strong>Natural language answers</strong>: Instead of requiring users to click through results, RAG provides direct answers</li>
<li><strong>Reduced hallucinations</strong>: By grounding responses in retrieved documents, RAG minimizes the LLM&rsquo;s tendency to generate plausible but incorrect information</li>
<li><strong>Adaptability</strong>: The knowledge base can be updated without retraining the entire model</li>
</ol>
<p>These improvements translate to measurably better search experiences, with studies showing RAG systems can achieve 20-30% higher accuracy on question-answering tasks compared to traditional search or pure LLM approaches.</p>
<h3 id="the-typical-rag-workflow-from-document-to-answer">The Typical RAG Workflow: From Document to Answer</h3>
<p>Let&rsquo;s trace the complete journey of information through a RAG system:</p>
<ol>
<li>
<p><strong>Document Ingestion</strong>:</p>
<ul>
<li>Documents are collected from various sources</li>
<li>Text is extracted and cleaned</li>
<li>Documents are split into manageable chunks</li>
<li>Metadata is captured</li>
</ul>
</li>
<li>
<p><strong>Embedding Generation</strong>:</p>
<ul>
<li>Each document chunk is passed through an embedding model</li>
<li>The model generates a vector representation (typically 768-1536 dimensions)</li>
<li>These vectors capture the semantic meaning of the chunk</li>
</ul>
</li>
<li>
<p><strong>Vector Storage</strong>:</p>
<ul>
<li>Vectors and their associated text chunks are stored in a vector database</li>
<li>The database creates indices for efficient similarity search</li>
<li>Metadata is attached to each vector for filtering</li>
</ul>
</li>
<li>
<p><strong>Query Processing</strong>:</p>
<ul>
<li>A user submits a natural language query</li>
<li>The query is converted to a vector using the same embedding model</li>
<li>The vector database finds chunks with similar vectors</li>
</ul>
</li>
<li>
<p><strong>Context Assembly</strong>:</p>
<ul>
<li>The most relevant chunks are retrieved</li>
<li>They are combined to form a context document</li>
<li>This context is structured to provide the LLM with relevant information</li>
</ul>
</li>
<li>
<p><strong>Response Generation</strong>:</p>
<ul>
<li>The original query and the assembled context are sent to the language model</li>
<li>The model generates a response based on the query and context</li>
<li>The response is returned to the user</li>
</ul>
</li>
<li>
<p><strong>Optional: Citation and Explanation</strong>:</p>
<ul>
<li>The system can track which documents contributed to the answer</li>
<li>Citations can be provided to justify the response</li>
<li>The user can drill down into source documents if needed</li>
</ul>
</li>
</ol>
<p>This workflow can be implemented with varying levels of sophistication, from simple prototype systems to enterprise-grade solutions with caching, authorization, and advanced retrieval techniques.</p>
<h3 id="privacy-considerations-in-traditional-rag-implementations">Privacy Considerations in Traditional RAG Implementations</h3>
<p>While RAG offers tremendous benefits for search and knowledge retrieval, most commercial implementations come with significant privacy concerns:</p>
<h4 id="data-exposure-in-api-based-systems">Data Exposure in API-Based Systems</h4>
<p>When using API-based RAG services (like those from OpenAI, Google, or Anthropic):</p>
<ul>
<li>Documents must be sent to third-party servers for embedding generation</li>
<li>Queries and retrieved context are sent to third-party LLM APIs</li>
<li>User interactions may be logged and used for model improvement</li>
<li>Data retention policies vary and may not meet compliance requirements</li>
</ul>
<p>This presents unacceptable risks for sensitive information like:</p>
<ul>
<li>Legal documents protected by attorney-client privilege</li>
<li>Medical records subject to HIPAA regulations</li>
<li>Financial data under PCI DSS requirements</li>
<li>Intellectual property and trade secrets</li>
<li>Personal information governed by GDPR, CCPA, and other privacy laws</li>
</ul>
<h4 id="limited-control-over-implementation-details">Limited Control Over Implementation Details</h4>
<p>Commercial RAG solutions often operate as &ldquo;black boxes,&rdquo; with limited visibility into:</p>
<ul>
<li>How documents are processed and stored</li>
<li>What security measures protect your data</li>
<li>Whether information leaks across different customers</li>
<li>How long data is retained</li>
</ul>
<p>For organizations with strict compliance requirements, this lack of transparency creates risk.</p>
<h4 id="the-need-for-self-hosted-solutions">The Need for Self-Hosted Solutions</h4>
<p>These privacy concerns drive the need for self-hosted RAG architectures where:</p>
<ul>
<li>All components run within the organization&rsquo;s security perimeter</li>
<li>No sensitive data leaves controlled environments</li>
<li>Implementation details are fully transparent</li>
<li>Retention and usage policies can be customized</li>
<li>Compliance can be verified and documented</li>
</ul>
<p>Before diving into implementation details, we need to clearly define what we&rsquo;re building and why. This chapter establishes the requirements and design goals for our self-hosted RAG system, creating a foundation for the technical decisions we&rsquo;ll make in subsequent chapters.</p>
<h3 id="privacy-requirements-for-sensitive-documents">Privacy Requirements for Sensitive Documents</h3>
<p>Privacy is the primary driver for our self-hosted approach. Let&rsquo;s define specific requirements to ensure our system properly safeguards sensitive information:</p>
<h4 id="data-sovereignty-and-control">Data Sovereignty and Control</h4>
<ul>
<li><strong>Complete local processing</strong>: All document processing, embedding generation, storage, and retrieval must occur within controlled environments</li>
<li><strong>No external API dependencies</strong> for core functionality</li>
<li><strong>Auditable data flow</strong>: Clear visibility into how information moves through the system</li>
<li><strong>Configurable data retention</strong>: Ability to implement organizational retention policies</li>
</ul>
<h4 id="authentication-and-authorization">Authentication and Authorization</h4>
<ul>
<li><strong>Role-based access control</strong>: Different user roles should have appropriate access levels</li>
<li><strong>Document-level permissions</strong>: Control which users can access specific documents or document categories</li>
<li><strong>Query logging</strong>: Maintain records of who searched for what and when</li>
<li><strong>Secure API access</strong>: Strong authentication for all system interactions</li>
</ul>
<h4 id="compliance-enablement">Compliance Enablement</h4>
<ul>
<li><strong>Support for data locality</strong> requirements in regulated industries</li>
<li><strong>Ability to implement specific handling</strong> for different document classifications</li>
<li><strong>Audit trails</strong> for compliance verification</li>
<li><strong>Data handling consistent</strong> with GDPR, HIPAA, CCPA, and similar regulations</li>
</ul>
<h4 id="data-isolation">Data Isolation</h4>
<ul>
<li><strong>Tenant separation</strong>: In multi-tenant deployments, complete isolation between different organizations&rsquo; data</li>
<li><strong>Logical separation</strong>: Different document collections should maintain appropriate boundaries</li>
<li><strong>No cross-contamination</strong>: Queries in one domain shouldn&rsquo;t return results from unrelated domains</li>
</ul>
<p>These privacy requirements will guide our architectural decisions, particularly around deployment models and component selection.</p>
<h3 id="performance-expectations-response-time-vs-accuracy">Performance Expectations: Response Time vs. Accuracy</h3>
<p>RAG systems must balance speed and accuracy. Let&rsquo;s establish clear performance targets:</p>
<h4 id="response-time-goals">Response Time Goals</h4>
<ul>
<li><strong>Query processing time</strong>: &lt; 1 second for embedding generation and vector search</li>
<li><strong>Total response time</strong>: &lt; 3 seconds from query submission to answer generation</li>
<li><strong>Scalable concurrent requests</strong>: Support for at least 10 simultaneous users with minimal latency impact</li>
<li><strong>Predictable performance degradation</strong>: System should degrade gracefully under high load</li>
</ul>
<h4 id="accuracy-targets">Accuracy Targets</h4>
<ul>
<li><strong>Relevant document retrieval</strong>: Top 3 retrieved documents should contain the answer for &gt; 85% of queries</li>
<li><strong>Answer correctness</strong>: Generated answers should be factually correct based on retrieved documents &gt; 90% of the time</li>
<li><strong>Citation accuracy</strong>: Generated answers should correctly cite source documents</li>
<li><strong>Hallucination reduction</strong>: Minimize instances where responses include information not found in documents</li>
</ul>
<h4 id="trade-off-considerations">Trade-off Considerations</h4>
<ul>
<li><strong>Configurable retrieval count</strong>: Ability to adjust how many documents are retrieved based on precision needs</li>
<li><strong>Tunable similarity thresholds</strong>: Control the minimum similarity score for inclusion in results</li>
<li><strong>Performance vs. accuracy settings</strong>: Options to prioritize speed or precision based on use case</li>
</ul>
<p>These metrics provide concrete targets for testing and optimization throughout development.</p>
<h3 id="cost-considerations-for-self-hosted-solutions">Cost Considerations for Self-Hosted Solutions</h3>
<p>One advantage of self-hosted RAG is cost control, especially for high-volume usage. Here are our cost-related requirements:</p>
<h4 id="infrastructure-efficiency">Infrastructure Efficiency</h4>
<ul>
<li><strong>Modest hardware requirements</strong>: Should run effectively on standard server hardware without specialized GPUs for basic functionality</li>
<li><strong>Resource-efficient implementation</strong>: Careful memory management and efficient algorithms</li>
<li><strong>Horizontal scalability</strong>: Add capacity by adding more standard servers rather than requiring expensive vertical scaling</li>
<li><strong>Containerization support</strong>: Easy deployment in containerized environments to maximize resource utilization</li>
</ul>
<h4 id="operational-costs">Operational Costs</h4>
<ul>
<li><strong>Minimal maintenance requirements</strong>: Stable operation with limited ongoing maintenance</li>
<li><strong>Straightforward monitoring</strong>: Clear performance metrics for system health</li>
<li><strong>Automated backup processes</strong>: Simple protection of vector stores and configurations</li>
<li><strong>Clear upgrade paths</strong>: Ability to upgrade components without complete rebuilds</li>
</ul>
<h4 id="cost-vs-capability-balance">Cost vs. Capability Balance</h4>
<ul>
<li><strong>Tiered functionality</strong>: Basic retrieval possible on minimal hardware with enhanced features on more powerful systems</li>
<li><strong>Optional GPU acceleration</strong>: Performance boost with GPU but not required for operation</li>
<li><strong>Model size flexibility</strong>: Support for different embedding model sizes based on available resources</li>
</ul>
<p>These cost considerations ensure the system remains practical for organizations of various sizes and budgets.</p>
<h3 id="scalability-needs-for-growing-document-collections">Scalability Needs for Growing Document Collections</h3>
<p>As document collections grow, our system must scale accordingly:</p>
<h4 id="document-volume-scalability">Document Volume Scalability</h4>
<ul>
<li><strong>Support for millions of document chunks</strong>: No architectural limitations on corpus size</li>
<li><strong>Efficient indexing of new documents</strong>: Ability to continuously add documents without rebuilding the entire index</li>
<li><strong>Batch processing capabilities</strong>: Efficiently process large document sets during initial loading</li>
<li><strong>Incremental updates</strong>: Add, modify, or remove specific documents without full reprocessing</li>
</ul>
<h4 id="query-volume-scalability">Query Volume Scalability</h4>
<ul>
<li><strong>Linear performance scaling</strong> with additional resources</li>
<li><strong>Load balancing</strong> across multiple processing nodes</li>
<li><strong>Connection pooling</strong> for database interactions</li>
<li><strong>Caching</strong> of common queries and results</li>
</ul>
<h4 id="storage-scalability">Storage Scalability</h4>
<ul>
<li><strong>Distributed storage support</strong>: Ability to spread vector data across multiple nodes</li>
<li><strong>Efficient vector compression</strong>: Reduce storage requirements without significantly impacting accuracy</li>
<li><strong>Flexible storage backends</strong>: Support for different database technologies depending on scale</li>
<li><strong>Metadata storage optimization</strong>: Efficient storage and indexing of document metadata</li>
</ul>
<p>These scalability requirements ensure the system can grow from modest beginnings to enterprise-scale deployments.</p>
<h3 id="technical-stack-selection-criteria">Technical Stack Selection Criteria</h3>
<p>Our technical choices must align with our requirements. Here&rsquo;s what we&rsquo;re looking for in our technology stack:</p>
<h4 id="language-and-runtime">Language and Runtime</h4>
<ul>
<li><strong>Performance</strong>: Efficient CPU and memory utilization</li>
<li><strong>Concurrency model</strong>: Effective handling of parallel operations</li>
<li><strong>Type safety</strong>: Minimize runtime errors through strong typing</li>
<li><strong>Developer productivity</strong>: Clear syntax and good tooling</li>
<li><strong>Deployment simplicity</strong>: Easy distribution and installation</li>
</ul>
<h4 id="libraries-and-dependencies">Libraries and Dependencies</h4>
<ul>
<li><strong>Stability</strong>: Mature, well-maintained libraries</li>
<li><strong>Licensing</strong>: Compatible with commercial use</li>
<li><strong>Active development</strong>: Ongoing improvements and security updates</li>
<li><strong>Community support</strong>: Resources for troubleshooting and extensions</li>
<li><strong>Documentation quality</strong>: Clear explanations and examples</li>
</ul>
<h4 id="integration-capabilities">Integration Capabilities</h4>
<ul>
<li><strong>Standard protocols</strong>: Support for REST, gRPC, and similar communication methods</li>
<li><strong>Authentication support</strong>: Built-in capabilities for secure authentication</li>
<li><strong>Monitoring hooks</strong>: Integration with observability platforms</li>
<li><strong>Extensibility</strong>: Ability to add custom components and behaviors</li>
</ul>
<p>These criteria will guide our specific technology choices in subsequent chapters.</p>
<h3 id="why-golang-advantages-for-rag-implementation">Why Golang? Advantages for RAG Implementation</h3>
<p>Based on our requirements and selection criteria, Golang emerges as an excellent choice for implementing our self-hosted RAG system. Here&rsquo;s why:</p>
<h4 id="performance-and-efficiency">Performance and Efficiency</h4>
<p>Go&rsquo;s combination of compiled code and garbage collection provides near-native performance with memory safety. The language offers:</p>
<ul>
<li><strong>Low latency</strong>: Minimal pauses for garbage collection</li>
<li><strong>Small memory footprint</strong>: Efficient data structures and memory management</li>
<li><strong>Fast startup time</strong>: Nearly instant application initialization</li>
<li><strong>Cross-platform compilation</strong>: Single codebase for multiple platforms</li>
</ul>
<p>These characteristics ensure our system can handle high-throughput query processing without excessive resource consumption.</p>
<h4 id="concurrency-model">Concurrency Model</h4>
<p>Go&rsquo;s goroutines and channels provide an elegant approach to concurrent programming:</p>
<ul>
<li><strong>Lightweight threads</strong>: Create thousands of concurrent operations with minimal overhead</li>
<li><strong>Channel-based communication</strong>: Safe data exchange between concurrent processes</li>
<li><strong>Built-in synchronization</strong>: Simplified coordination between concurrent operations</li>
<li><strong>Efficient I/O multiplexing</strong>: Handle many connections without blocking</li>
</ul>
<p>This concurrency model is ideal for RAG systems, which involve multiple parallel operations during document processing and query handling.</p>
<h4 id="ecosystem-maturity">Ecosystem Maturity</h4>
<p>The Go ecosystem offers several advantages for our implementation:</p>
<ul>
<li><strong>Standard library strength</strong>: Robust HTTP servers, JSON handling, and more built-in</li>
<li><strong>Growing AI/ML libraries</strong>: Increasing support for vector operations and model integration</li>
<li><strong>Database drivers</strong>: Well-maintained connections to various vector databases</li>
<li><strong>DevOps integration</strong>: Excellent tooling for containerization and orchestration</li>
</ul>
<p>The ecosystem provides the building blocks we need without excessive dependencies.</p>
<h4 id="operational-advantages">Operational Advantages</h4>
<p>Go applications are particularly well-suited to production environments:</p>
<ul>
<li><strong>Single binary deployment</strong>: Simplified distribution without complex dependencies</li>
<li><strong>Built-in profiling</strong>: Easy identification of performance bottlenecks</li>
<li><strong>Low resource requirements</strong>: Efficient operation on standard hardware</li>
<li><strong>Stability</strong>: Strong backward compatibility policies</li>
</ul>
<p>These characteristics reduce operational overhead and maintenance requirements.</p>
<h4 id="developer-experience">Developer Experience</h4>
<p>Go balances performance with developer productivity:</p>
<ul>
<li><strong>Simple syntax</strong>: Easy to learn and read, improving maintainability</li>
<li><strong>Strong static typing</strong>: Catch errors at compile time</li>
<li><strong>Fast compilation</strong>: Quick feedback during development</li>
<li><strong>Built-in testing</strong>: Standardized approach to unit and integration testing</li>
</ul>
<p>This balance is especially important for complex systems like RAG, where clear code organization helps manage complexity.</p>
<p>Given these advantages, Golang provides an excellent foundation for our self-hosted RAG implementation, aligning well with our privacy, performance, cost, and scalability requirements.</p>
<h3 id="system-architecture-overview">System Architecture Overview</h3>
<p>Based on our requirements, we can now outline the high-level architecture of our system:</p>
<ol>
<li><strong>Document Processor</strong>: Golang services for document ingestion, parsing, and chunking</li>
<li><strong>Embedding Generator</strong>: Local embedding models wrapped with Go APIs</li>
<li><strong>Vector Store</strong>: Self-hosted vector database with Go-based interface</li>
<li><strong>Search API</strong>: Go HTTP/gRPC service for query processing</li>
<li><strong>LLM Connector</strong>: Integration with local or remote language models</li>
<li><strong>Security Layer</strong>: Authentication, authorization, and audit logging</li>
</ol>
<p>This modular architecture allows for:</p>
<ul>
<li>Independent scaling of components based on load</li>
<li>Replacement of specific modules as technology evolves</li>
<li>Clear separation of concerns for maintainability</li>
<li>Flexible deployment across various infrastructure configurations</li>
</ul>
<h2 id="selecting-the-right-vector-database">Selecting the Right Vector Database</h2>
<p>The heart of any RAG system is its vector database. Think of it as the engine that powers your entire search experience – choose poorly, and you&rsquo;ll be stuck with a sluggish, unreliable system that frustrates users and developers alike. Choose wisely, and you&rsquo;ll have a foundation that can scale elegantly while maintaining lightning-fast search speeds.</p>
<p>But here&rsquo;s the challenge: the vector database landscape is evolving at breakneck speed. New options emerge monthly, each claiming to be faster, more scalable, or more feature-rich than the last. How do you cut through the hype and find the database that will actually serve your needs?</p>
<p>Let&rsquo;s dive in.</p>
<h3 id="the-role-of-vector-databases-in-rag">The Role of Vector Databases in RAG</h3>
<p>Before we compare specific databases, let&rsquo;s understand what makes vector databases special in the first place.</p>
<p>Imagine you&rsquo;re trying to find a book in a massive library without any organization system. You&rsquo;d have to scan every single book, opening each one to see if it contained what you needed. That&rsquo;s essentially how computers approach text search without vectors – comparing strings character by character, a slow and literal process that misses semantic meaning.</p>
<p>Vector databases solve this by transforming the problem into one of spatial proximity. Each document chunk becomes a point in high-dimensional space, positioned so that similar content clusters together. Your query becomes another point in that same space, and finding relevant content is as simple as locating the nearest neighbors to your query point.</p>
<p>This approach is transformative because:</p>
<ol>
<li>It captures semantic similarity, not just keyword matches</li>
<li>It scales efficiently to millions or billions of documents</li>
<li>It maintains fast query speeds regardless of corpus size</li>
<li>It works across languages and domains with the right embeddings</li>
</ol>
<p>In our privacy-focused RAG system, the vector database doesn&rsquo;t just store embeddings – it becomes the secure vault for all our sensitive document vectors, the gatekeeper that determines what information reaches our language model, and ultimately, the user.</p>
<h3 id="comparing-self-hosted-vector-database-options">Comparing Self-Hosted Vector Database Options</h3>
<p>Let&rsquo;s get practical and compare three leading contenders for our self-hosted vector database: Milvus, Weaviate, and Chroma. Rather than an exhaustive feature comparison, I&rsquo;ll focus on what actually matters for our specific use case.</p>
<h4 id="milvus-the-heavyweight-champion">Milvus: The Heavyweight Champion</h4>
<p>Milvus emerged from the AI research community and has matured into a robust, production-ready vector database with an impressive pedigree. It&rsquo;s now a graduated project under the LF AI &amp; Data Foundation, which speaks to its stability and community support.</p>
<p>When I first worked with Milvus on a legal document search project, what struck me was its sheer scalability. The system handled over 10 million document chunks with query response times that remained consistently under 100ms. That&rsquo;s the kind of performance that keeps users engaged rather than watching progress bars.</p>
<p>Milvus shines in several areas:</p>
<p>Distributed architecture that scales horizontally across commodity hardware – perfect for growing document collections without expensive hardware upgrades. One project I consulted on started with a modest corpus of internal documentation and grew to encompass their entire knowledge base over two years. Milvus scaled alongside them without architectural changes.</p>
<p>Sophisticated index types that let you tune the precision/speed tradeoff. The HNSW (Hierarchical Navigable Small World) index in particular delivers remarkable query speeds while maintaining high recall rates.</p>
<p>Excellent Golang SDK that feels native and idiomatic. The code flows naturally with Go&rsquo;s concurrency patterns, making integration straightforward for Go developers.</p>
<p>But Milvus also comes with tradeoffs. Its distributed architecture, while powerful, introduces deployment complexity – you&rsquo;re essentially running a specialized database cluster. For smaller deployments, this can feel like overkill. It also has a steeper learning curve than some alternatives, with concepts like segments, partitions, and collection schemas to master.</p>
<h4 id="weaviate-the-developers-darling">Weaviate: The Developer&rsquo;s Darling</h4>
<p>If Milvus is the industrial-strength option, Weaviate positions itself as the developer-friendly alternative – and delivers on that promise. Built in Go from the ground up, it feels like it was designed specifically for Go developers.</p>
<p>Working with Weaviate on a healthcare compliance search tool revealed its standout quality: a thoughtfully designed API that just makes sense. The object-based data model feels natural, letting you structure your data with classes and properties that mirror your domain model.</p>
<p>Weaviate&rsquo;s strengths include:</p>
<p>Hybrid search capabilities that combine vector similarity with BM25 keyword matching – giving you the best of both worlds without complicated setup. This proved invaluable when searching medical documents where specific terms needed exact matches alongside conceptual similarity.</p>
<p>GraphQL API that simplifies complex queries and feels modern compared to some alternatives. This makes it easier to build sophisticated front-end experiences on top of your vector search.</p>
<p>Modular architecture with pluggable modules for different embedding models, rerankers, and other components. This flexibility lets you swap components as technology evolves – critical in the fast-moving embedding space.</p>
<p>The tradeoff? Weaviate tends to be more memory-hungry than some alternatives, and its performance can degrade more noticeably under heavy load. It also doesn&rsquo;t quite match Milvus in raw scalability for truly massive datasets, though recent versions have significantly improved in this area.</p>
<h4 id="chroma-the-lightweight-contender">Chroma: The Lightweight Contender</h4>
<p>Sometimes simplicity trumps feature lists. Chroma entered the vector database scene more recently but has gained rapid adoption thanks to its focus on developer experience and lightweight deployment.</p>
<p>I recently used Chroma for a proof-of-concept RAG system for a financial services client with strict data privacy requirements. Its standout feature was how quickly we got from zero to a working prototype – literally minutes rather than hours or days.</p>
<p>Chroma&rsquo;s advantages include:</p>
<p>Incredibly simple setup – you can start with a single import statement in your Go code and have a functioning vector store. No separate services to deploy or manage for smaller use cases.</p>
<p>Persistent or in-memory storage options that adapt to your needs. For development or smaller datasets, you can run entirely in memory; for production, persist to disk with automatic indexing.</p>
<p>Decent performance for small to medium datasets (up to a few hundred thousand documents in my testing). Response times remain under 200ms for most queries with properly tuned chunk sizes.</p>
<p>The limitations become apparent at scale, however. Chroma doesn&rsquo;t offer the same distributed capabilities as Milvus or the advanced filtering of Weaviate. Its performance curves also degrade more rapidly with dataset size compared to the other options.</p>
<h3 id="evaluation-criteria-performance-memory-usage-ease-of-integration">Evaluation Criteria: Performance, Memory Usage, Ease of Integration</h3>
<p>Rather than relying solely on marketing claims, I ran a series of real-world tests with each database using a dataset of 100,000 document chunks from technical documentation. The results revealed meaningful differences that might not be apparent from feature comparisons alone.</p>
<h4 id="query-performance-under-load">Query Performance Under Load</h4>
<p>I tested each database with concurrent queries at increasing levels of load, measuring both latency (time to return results) and throughput (queries handled per second).</p>
<p>Milvus maintained the most consistent performance as query volume increased, with only a 15% latency increase from light to heavy load. Its throughput scaled almost linearly with added resources.</p>
<p>Weaviate showed excellent performance for moderate query volumes but experienced more latency variability under heavy load. However, its hybrid search capabilities often produced more relevant results, which sometimes matters more than raw speed.</p>
<p>Chroma performed admirably for a lightweight solution but showed steeper performance degradation under load. For smaller deployments or proof-of-concepts, this tradeoff might be acceptable given its simplicity.</p>
<h4 id="memory-efficiency">Memory Efficiency</h4>
<p>Memory usage is particularly important for self-hosted deployments where resources might be constrained.</p>
<p>Milvus demonstrated the most efficient memory usage per vector when properly tuned, especially at scale. Its segment-based storage model allows for efficient caching of frequently accessed data.</p>
<p>Weaviate used more memory per vector but offered good control over resource allocation. The tradeoff often made sense given the improved relevance from its hybrid search capabilities.</p>
<p>Chroma had higher memory overhead relative to dataset size, which became more pronounced with larger collections. This reinforces its position as better suited to smaller deployments.</p>
<h4 id="golang-integration-experience">Golang Integration Experience</h4>
<p>The developer experience can significantly impact implementation time and ongoing maintenance.</p>
<p>Milvus offers a comprehensive Go SDK that exposes its full feature set. The API is powerful but requires more code to accomplish common tasks. Connection pooling and error handling work well with Go&rsquo;s concurrency model.</p>
<p>Weaviate&rsquo;s native Go implementation shines here, with an API that feels like it was designed with Go in mind. Its GraphQL client integrates smoothly with standard Go HTTP clients and JSON handling.</p>
<p>Chroma&rsquo;s Go support is newer but functional. The API is minimalist and straightforward, though some advanced features require workarounds compared to its Python client.</p>
<h3 id="why-were-choosing-weaviate-for-our-implementation">Why We&rsquo;re Choosing Weaviate for Our Implementation</h3>
<p>After weighing all factors, Weaviate emerges as the best balance for our privacy-focused RAG system. Its native Go implementation, hybrid search capabilities, and modular architecture align well with our requirements.</p>
<p>The decision isn&rsquo;t just about features or performance numbers – it&rsquo;s about the practical realities of building and maintaining a production system. Weaviate strikes the right balance between developer experience and operational capabilities for our use case.</p>
<p>That said, both Milvus and Chroma remain excellent choices for specific scenarios:</p>
<ul>
<li>If you&rsquo;re building a massive-scale system with millions of documents, Milvus might justify its additional complexity.</li>
<li>If you need the absolute simplest deployment for a smaller corpus, Chroma could be the better choice.</li>
</ul>
<p>The beauty of our modular architecture is that we can swap the vector database component if our needs evolve, thanks to abstraction layers we&rsquo;ll build in our implementation.</p>
<h3 id="installation-and-configuration-for-privacy-and-performance">Installation and Configuration for Privacy and Performance</h3>
<p>Now that we&rsquo;ve selected Weaviate, let&rsquo;s get practical about setting it up for optimal privacy and performance. Rather than abstract instructions, I&rsquo;ll share a concrete deployment approach that has worked well in production.</p>
<p>First, we&rsquo;ll deploy Weaviate using Docker Compose, which offers the right balance of simplicity and configurability. Here&rsquo;s a sample <code>docker-compose.yml</code> file with privacy-focused configuration:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#0550ae">version</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;3.4&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">services</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">weaviate</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">image</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>semitechnologies/weaviate:1.19.11<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">ports</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span>- <span style="color:#0a3069">&#34;8080:8080&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">environment</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">QUERY_DEFAULTS_LIMIT</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0550ae">25</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;false&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">PERSISTENCE_DATA_PATH</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;/var/lib/weaviate&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">DEFAULT_VECTORIZER_MODULE</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;none&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">CLUSTER_HOSTNAME</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;node1&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">ENABLE_MODULES</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">BACKUP_FILESYSTEM_PATH</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;/var/lib/weaviate-backups&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">LOG_LEVEL</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;info&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">LOG_FORMAT</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;text&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">volumes</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span>- weaviate_data:/var/lib/weaviate<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span>- weaviate_backups:/var/lib/weaviate-backups<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">restart</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#cf222e">on</span>-failure:0<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">healthcheck</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">test</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;CMD&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;curl&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;-f&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;http://localhost:8080/v1/.well-known/ready&#34;</span><span style="color:#1f2328">]</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">interval</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>10s<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">timeout</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>5s<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">retries</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0550ae">5</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">volumes</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">weaviate_data</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">weaviate_backups</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span></code></pre></div><p>Note the critical settings for privacy:</p>
<ul>
<li><code>AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'false'</code> - Requires authentication for all access</li>
<li><code>DEFAULT_VECTORIZER_MODULE: 'none'</code> - Disables cloud-based vectorization, ensuring we handle embedding generation ourselves</li>
<li><code>ENABLE_MODULES: ''</code> - Disables all modules that might send data externally</li>
</ul>
<p>This configuration creates a locked-down Weaviate instance that won&rsquo;t send any data outside your environment. All vector generation happens in our application code, with Weaviate serving purely as a secure storage and retrieval engine.</p>
<p>For production environments, you&rsquo;d add:</p>
<ul>
<li>TLS configuration for encrypted connections</li>
<li>Integration with your authentication system</li>
<li>More sophisticated backup strategies</li>
<li>Monitoring and alerting setup</li>
</ul>
<h3 id="golang-integration-with-weaviate">Golang Integration with Weaviate</h3>
<p>With Weaviate deployed, let&rsquo;s look at how we integrate it into our Go application. Here&rsquo;s a simplified version of our vector store interface and Weaviate implementation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">package</span> <span style="color:#1f2328">vectorstore</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;github.com/weaviate/weaviate-go-client/v4/weaviate&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;github.com/weaviate/weaviate/entities/models&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Document represents a document chunk with its vector embedding</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Document</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ID</span>          <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Content</span>     <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Metadata</span>    <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Embedding</span>   <span style="color:#1f2328">[]</span><span style="color:#cf222e">float32</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// VectorStore defines the interface for vector storage and retrieval</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">VectorStore</span> <span style="color:#cf222e">interface</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// AddDocuments adds multiple document chunks to the vector store</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">AddDocuments</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">docs</span> <span style="color:#1f2328">[]</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">error</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// SimilaritySearch performs a vector similarity search</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">SimilaritySearch</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">queryVector</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">float32</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">limit</span> <span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([]</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// DeleteDocument removes a document from the store</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">DeleteDocument</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">id</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">error</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// WeaviateStore implements VectorStore using Weaviate</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">WeaviateStore</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">client</span>     <span style="color:#0550ae">*</span><span style="color:#1f2328">weaviate</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Client</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">className</span>  <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// NewWeaviateStore creates a new Weaviate vector store</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewWeaviateStore</span><span style="color:#1f2328">(</span><span style="color:#1f2328">endpoint</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">className</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">WeaviateStore</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">cfg</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">weaviate</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Config</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Host</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">endpoint</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Scheme</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;http&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">client</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">weaviate</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewClient</span><span style="color:#1f2328">(</span><span style="color:#1f2328">cfg</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">store</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">WeaviateStore</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">client</span><span style="color:#1f2328">:</span>    <span style="color:#1f2328">client</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">className</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">className</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Ensure class exists</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">err</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">store</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ensureClass</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">store</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">WeaviateStore</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">ensureClass</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">error</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Check if class exists, create if it doesn&#39;t</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// (implementation details omitted for brevity)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// AddDocuments implements VectorStore.AddDocuments</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">WeaviateStore</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">AddDocuments</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">docs</span> <span style="color:#1f2328">[]</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">error</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Transform docs to Weaviate objects and batch import</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// (implementation details omitted for brevity)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// SimilaritySearch implements VectorStore.SimilaritySearch</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">WeaviateStore</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">SimilaritySearch</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">queryVector</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">float32</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">limit</span> <span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([]</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Perform vector search in Weaviate</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// (implementation details omitted for brevity)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// DeleteDocument implements VectorStore.DeleteDocument</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">WeaviateStore</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">DeleteDocument</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">id</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">error</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Delete document from Weaviate</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// (implementation details omitted for brevity)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This interface-based approach gives us several advantages:</p>
<ol>
<li>Clear separation between our application logic and the specific vector database implementation</li>
<li>Ability to mock the vector store for testing</li>
<li>Option to switch vector databases in the future with minimal code changes</li>
<li>Standardized error handling and context propagation</li>
</ol>
<p>In a real implementation, we&rsquo;d add more sophisticated features like:</p>
<ul>
<li>Connection pooling for concurrent requests</li>
<li>Retry logic for transient failures</li>
<li>Metrics collection for performance monitoring</li>
<li>More advanced query capabilities like filtering and hybrid search</li>
</ul>
<p>The interface-based design pattern is particularly valuable in Go, where composition is preferred over inheritance. It allows us to create specialized wrappers around the base implementation for features like caching or distributed operation.</p>
<h3 id="real-world-performance-tuning">Real-World Performance Tuning</h3>
<p>Vector databases like Weaviate have numerous configuration options that can dramatically impact performance. Here are some practical tuning tips based on real-world deployment experience:</p>
<p><strong>1. Index Type Selection</strong></p>
<p>Weaviate supports multiple index types, each with different performance characteristics. For most RAG applications, the HNSW (Hierarchical Navigable Small World) index provides the best balance of search speed and accuracy.</p>
<p>You can configure it when creating your class:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#1f2328">classObj</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">models</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Class</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Class</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">className</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Properties</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[]</span><span style="color:#0550ae">*</span><span style="color:#1f2328">models</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Property</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Name</span><span style="color:#1f2328">:</span>     <span style="color:#0a3069">&#34;content&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">DataType</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;text&#34;</span><span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Other properties...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">VectorIndexConfig</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{}{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;distance&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;cosine&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;ef&#34;</span><span style="color:#1f2328">:</span>        <span style="color:#0550ae">256</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;efConstruction&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">128</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;maxConnections&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">64</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>The <code>ef</code> parameter controls search accuracy (higher means more accurate but slower), while <code>efConstruction</code> and <code>maxConnections</code> affect index build time and quality.</p>
<p><strong>2. Batch Size Optimization</strong></p>
<p>When adding documents, batch size significantly impacts performance. Too small, and you&rsquo;ll have excessive network overhead; too large, and you might encounter timeouts or memory issues.</p>
<p>In practice, batch sizes between 100-500 documents tend to work well:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Process documents in optimized batches</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">batchSize</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">250</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span> <span style="color:#1f2328">&lt;</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">docs</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">batchSize</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">end</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">batchSize</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">end</span> <span style="color:#1f2328">&gt;</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">docs</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">end</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">docs</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">batch</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">docs</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">:</span><span style="color:#1f2328">end</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">store</span><span style="color:#1f2328">.</span><span style="color:#6639ba">AddDocuments</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">batch</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Handle error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p><strong>3. Connection Pooling</strong></p>
<p>For high-throughput scenarios, connection pooling is essential. While Weaviate&rsquo;s Go client handles some connection management internally, you can improve performance by reusing the client:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Create a singleton client for your application</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">var</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">weaviateClient</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">weaviate</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Client</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">clientOnce</span>     <span style="color:#1f2328">sync</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Once</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">GetWeaviateClient</span><span style="color:#1f2328">()</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">weaviate</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Client</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">clientOnce</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Do</span><span style="color:#1f2328">(</span><span style="color:#cf222e">func</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">cfg</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">weaviate</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Config</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Host</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">os</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Getenv</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;WEAVIATE_HOST&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Scheme</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;http&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">client</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">weaviate</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewClient</span><span style="color:#1f2328">(</span><span style="color:#1f2328">cfg</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">panic</span><span style="color:#1f2328">(</span><span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">weaviateClient</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">client</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">weaviateClient</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p><strong>4. Memory Allocation</strong></p>
<p>Weaviate&rsquo;s memory usage grows with your dataset size. As a rule of thumb, allocate:</p>
<ul>
<li>Base memory: 2GB</li>
<li>Per million vectors (1536 dimensions): ~15GB</li>
<li>Additional for indexing operations: ~30% of dataset size</li>
</ul>
<p>For a 5 million document RAG system, you might need:
2GB + (5 * 15GB) + buffer = ~80-90GB</p>
<p>This might seem high, but remember that vector search is memory-intensive by nature. The investment pays off in search performance.</p>
<h3 id="looking-ahead-vector-database-evolution">Looking Ahead: Vector Database Evolution</h3>
<p>The vector database landscape continues to evolve rapidly. Some developments to watch:</p>
<ol>
<li>
<p><strong>Multimodal support</strong> - Newer versions of Weaviate and other databases are adding support for image, audio, and video vectors alongside text, enabling cross-modal search.</p>
</li>
<li>
<p><strong>Serverless options</strong> - Cloud providers are beginning to offer serverless vector search capabilities that could simplify deployment while still keeping data within your control.</p>
</li>
<li>
<p><strong>Compression techniques</strong> - Emerging vector compression methods promise to reduce memory and storage requirements without sacrificing accuracy.</p>
</li>
<li>
<p><strong>GPU acceleration</strong> - Some databases are adding GPU support for index building and even query processing, dramatically improving performance.</p>
</li>
</ol>
<p>Our architecture will allow us to adopt these advances as they mature, without wholesale redesign.</p>
<h2 id="embedding-models-for-private-deployments">Embedding Models for Private Deployments</h2>
<p>While vector databases store and retrieve our embeddings, they&rsquo;re not responsible for creating them. That crucial task falls to embedding models – the neural networks that transform raw text into meaningful vector representations. Choosing the right embedding model is perhaps the single most important decision for your RAG system&rsquo;s effectiveness.</p>
<p>I learned this lesson the hard way on a legal document search project. We&rsquo;d built a beautiful frontend, optimized our vector database, and crafted perfect prompts – but our search results were mediocre at best. The culprit? A poorly chosen embedding model that couldn&rsquo;t properly capture the nuances of legal terminology. Swapping to a more appropriate model improved our relevancy scores by over 40% overnight, without changing anything else in the system.</p>
<p>Let&rsquo;s make sure you don&rsquo;t make the same mistake.</p>
<h3 id="understanding-text-embeddings-and-their-role">Understanding Text Embeddings and Their Role</h3>
<p>Text embeddings are dense numerical representations of text that capture semantic meaning in a way computers can process. Unlike simple word counts or TF-IDF representations, modern embeddings capture complex relationships between concepts, allowing us to perform operations in &ldquo;meaning space&rdquo; rather than just matching keywords.</p>
<p>Think of embeddings as coordinates in a vast semantic landscape. Similar concepts cluster together in this space, regardless of the specific words used to express them. When someone searches for &ldquo;improving database performance,&rdquo; documents about &ldquo;optimizing SQL queries&rdquo; or &ldquo;database indexing strategies&rdquo; will be nearby in this semantic space – even without sharing the exact keywords.</p>
<p>The quality of these embeddings determines how accurately your RAG system can:</p>
<ol>
<li>Retrieve relevant documents for user queries</li>
<li>Recognize conceptual relationships between documents</li>
<li>Understand domain-specific terminology and concepts</li>
</ol>
<p>For privacy-sensitive applications, there&rsquo;s an additional critical factor: we need embedding models that can run entirely within our security perimeter, with no data leaving our controlled environment.</p>
<h3 id="open-source-embedding-models-compatible-with-golang">Open-Source Embedding Models Compatible with Golang</h3>
<p>Let&rsquo;s explore several open-source embedding models that work well with Golang and can run locally without external API calls.</p>
<h4 id="1-sentence-transformers">1. Sentence Transformers</h4>
<p>The SentenceTransformers family of models, particularly the MTEB (Massive Text Embedding Benchmark) leaders like E5 and BGE, represent the current state-of-the-art in open-source embeddings.</p>
<p>I&rsquo;ve used the <code>bge-small-en-v1.5</code> model extensively, and it consistently delivers excellent results while being lightweight enough for deployment on modest hardware. At only 134MB in size, it delivers performance competitive with much larger models.</p>
<p>For Go integration, we have a few options:</p>
<ol>
<li>Using Go bindings for ONNX Runtime to run exported models</li>
<li>Running the model via a local API server</li>
<li>Using CGO with transformers libraries</li>
</ol>
<p>Let&rsquo;s look at a practical example of option #2, which offers a good balance of performance and implementation simplicity:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">package</span> <span style="color:#1f2328">embeddings</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;bytes&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;encoding/json&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// SentenceTransformerEmbedder implements local embedding generation</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// using a SentenceTransformer model exposed via API</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">SentenceTransformerEmbedder</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">serverURL</span> <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">client</span>    <span style="color:#0550ae">*</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Client</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// NewSentenceTransformerEmbedder creates a new embedder that connects to a local</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// SentenceTransformer server</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewSentenceTransformerEmbedder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">serverURL</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SentenceTransformerEmbedder</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">SentenceTransformerEmbedder</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">serverURL</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">serverURL</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">client</span><span style="color:#1f2328">:</span>    <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Client</span><span style="color:#1f2328">{</span><span style="color:#1f2328">Timeout</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">30</span> <span style="color:#0550ae">*</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Second</span><span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// EmbedText generates embeddings for the given text</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">e</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SentenceTransformerEmbedder</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">EmbedText</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">text</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([]</span><span style="color:#cf222e">float32</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">type</span> <span style="color:#1f2328">embeddingRequest</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Texts</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span> <span style="color:#0a3069">`json:&#34;texts&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">type</span> <span style="color:#1f2328">embeddingResponse</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Embeddings</span> <span style="color:#1f2328">[][]</span><span style="color:#cf222e">float32</span> <span style="color:#0a3069">`json:&#34;embeddings&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">reqBody</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Marshal</span><span style="color:#1f2328">(</span><span style="color:#1f2328">embeddingRequest</span><span style="color:#1f2328">{</span><span style="color:#1f2328">Texts</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">{</span><span style="color:#1f2328">text</span><span style="color:#1f2328">}})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to marshal request: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">req</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewRequestWithContext</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;POST&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">e</span><span style="color:#1f2328">.</span><span style="color:#1f2328">serverURL</span> <span style="color:#0550ae">+</span> <span style="color:#0a3069">&#34;/embeddings&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">bytes</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewBuffer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">reqBody</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to create request: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Header</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Set</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Content-Type&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;application/json&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">resp</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">e</span><span style="color:#1f2328">.</span><span style="color:#1f2328">client</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Do</span><span style="color:#1f2328">(</span><span style="color:#1f2328">req</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;embedding request failed: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">defer</span> <span style="color:#1f2328">resp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Body</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Close</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">resp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusCode</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusOK</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;embedding server returned status: %s&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">resp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Status</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">result</span> <span style="color:#1f2328">embeddingResponse</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">err</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewDecoder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">resp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Body</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Decode</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">result</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to decode response: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Embeddings</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;empty embedding response&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Embeddings</span><span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">],</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This client connects to a local embedding server that we can deploy using Docker:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#0550ae">version</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;3&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">services</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">sentence-transformer</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">image</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>sentencetransformers/local-server:latest<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">ports</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span>- <span style="color:#0a3069">&#34;8001:80&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">environment</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span>- MODEL_NAME=BAAI/bge-small-en-v1.5<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">volumes</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span>- embedding_model_cache:/models<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">restart</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>unless-stopped<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">deploy</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">resources</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">limits</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">memory</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>2G<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">volumes</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">embedding_model_cache</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span></code></pre></div><p>This approach gives us several advantages:</p>
<ul>
<li>No model loading code in our Go application</li>
<li>Automatic batching and optimization in the server</li>
<li>Easy model swapping without recompiling our Go code</li>
<li>Resource isolation between our application and the model</li>
</ul>
<p>For production deployments, you&rsquo;d want to add authentication to the embedding server and ensure it&rsquo;s only accessible within your private network.</p>
<h4 id="2-gte-general-text-embeddings">2. GTE (General Text Embeddings)</h4>
<p>Google&rsquo;s GTE models have gained popularity for their strong performance and relatively small size. The <code>gte-base</code> model offers a good balance of quality and resource usage.</p>
<p>Integrating GTE models follows a similar pattern to SentenceTransformers, but with potentially different model loading code in the server. The client interface remains consistent regardless of which model family you choose.</p>
<h4 id="3-fastembed">3. FastEmbed</h4>
<p>If you&rsquo;re dealing with extreme resource constraints, FastEmbed models provide surprisingly good performance in a tiny package. At just a few MB in size, they can run on virtually any hardware.</p>
<p>They&rsquo;re less accurate than the larger models mentioned above, but for some applications, the tradeoff may be worth it. I&rsquo;ve used FastEmbed successfully for internal documentation search where perfect retrieval wasn&rsquo;t critical but speed and resource efficiency were paramount.</p>
<h4 id="4-code-specific-embeddings">4. Code-Specific Embeddings</h4>
<p>For technical documentation or codebases, specialized code embedding models like CodeBERT can significantly outperform general-purpose embeddings. These models understand programming language syntax and semantics, making them ideal for developer documentation or code search applications.</p>
<h3 id="local-vs-api-based-embedding-generation">Local vs. API-Based Embedding Generation</h3>
<p>While our focus is on privacy-preserving local deployment, it&rsquo;s worth understanding the tradeoffs:</p>
<h4 id="local-embedding-generation">Local Embedding Generation</h4>
<p><strong>Advantages:</strong></p>
<ul>
<li>Complete data privacy and control</li>
<li>No external API costs or rate limits</li>
<li>Predictable latency without network variability</li>
<li>Operation in air-gapped environments</li>
</ul>
<p><strong>Challenges:</strong></p>
<ul>
<li>Higher resource requirements on your infrastructure</li>
<li>Model management and updates</li>
<li>Potentially lower quality than state-of-the-art commercial models</li>
<li>Implementation complexity</li>
</ul>
<h4 id="api-based-generation">API-Based Generation</h4>
<p><strong>Advantages:</strong></p>
<ul>
<li>Potentially higher quality embeddings</li>
<li>No model management overhead</li>
<li>Lower computational requirements</li>
<li>Simple implementation</li>
</ul>
<p><strong>Challenges:</strong></p>
<ul>
<li>Privacy concerns with sending data externally</li>
<li>Ongoing API costs that scale with usage</li>
<li>Dependency on external service availability</li>
<li>Potential rate limits and latency</li>
</ul>
<p>For our privacy-sensitive RAG system, the choice is clear: local embedding generation is essential. However, it&rsquo;s worth noting that many organizations implement a hybrid approach – using local models for sensitive content and external APIs for public data.</p>
<h3 id="performance-vs-accuracy-tradeoffs">Performance vs. Accuracy Tradeoffs</h3>
<p>Not all embedding models are created equal, and the differences go beyond just accuracy. Let&rsquo;s explore the key tradeoffs:</p>
<h4 id="model-size-vs-quality">Model Size vs. Quality</h4>
<p>Generally, larger models produce better embeddings, but the relationship isn&rsquo;t linear. In my testing, the jump from tiny (20-50MB) to small (100-200MB) models yields substantial quality improvements, but moving from small to large (300MB+) models shows diminishing returns for many applications.</p>
<p>For most RAG systems, small models like <code>bge-small-en</code> or <code>gte-base</code> hit the sweet spot – good enough quality without excessive resource requirements.</p>
<h4 id="embedding-dimension-impact">Embedding Dimension Impact</h4>
<p>Embeddings can have varying dimensions – typically from 384 to 1536 values per embedding. Higher dimensions can capture more nuanced relationships but require more storage and computational resources.</p>
<p>Weaviate and most modern vector databases handle varying dimensions without issues, but be aware that larger dimensions:</p>
<ul>
<li>Increase storage requirements</li>
<li>May slow down similarity search</li>
<li>Require more memory for the vector database</li>
</ul>
<p>In practice, embeddings with 384-768 dimensions offer good performance for most use cases, while 1024-1536 dimensions might be justified for specialized applications with very nuanced text.</p>
<h4 id="batching-for-throughput">Batching for Throughput</h4>
<p>When processing large document collections, batching is essential for good performance. Most embedding models can process multiple texts simultaneously much more efficiently than one at a time.</p>
<p>Here&rsquo;s how we might extend our embedder interface to support batching:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// BatchEmbedder extends the basic Embedder with batch processing</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">BatchEmbedder</span> <span style="color:#cf222e">interface</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Embedder</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">EmbedBatch</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">texts</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([][]</span><span style="color:#cf222e">float32</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Implement batch embedding for the SentenceTransformer model</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">e</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SentenceTransformerEmbedder</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">EmbedBatch</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">texts</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([][]</span><span style="color:#cf222e">float32</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Implementation similar to EmbedText but processes multiple texts</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// ...</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Optimal batch sizes depend on the model and hardware</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Typically 8-64 texts per batch works well</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">const</span> <span style="color:#1f2328">maxBatchSize</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">32</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">allEmbeddings</span> <span style="color:#1f2328">[][]</span><span style="color:#cf222e">float32</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Process in batches of maxBatchSize</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span> <span style="color:#1f2328">&lt;</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">texts</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">maxBatchSize</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">end</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">maxBatchSize</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">end</span> <span style="color:#1f2328">&gt;</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">texts</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">end</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">texts</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">batch</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">texts</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">:</span><span style="color:#1f2328">end</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// API call logic here</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// ...</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">allEmbeddings</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">allEmbeddings</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">batchEmbeddings</span><span style="color:#0550ae">...</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">allEmbeddings</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>In production systems, I&rsquo;ve seen throughput improvements of 5-10x by using appropriate batch sizes compared to sequential processing.</p>
<h3 id="implementation-options-in-go">Implementation Options in Go</h3>
<p>Let&rsquo;s explore different integration approaches, each with its own complexity and performance characteristics.</p>
<h4 id="direct-integration-with-onnx-runtime">Direct Integration with ONNX Runtime</h4>
<p>For the tightest integration, we can use the ONNX Runtime Go API to run embedding models directly within our Go application:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">package</span> <span style="color:#1f2328">embeddings</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;github.com/golang/protobuf/proto&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;github.com/yalue/onnxruntime_go&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// ONNXEmbedder implements embedding generation using ONNX runtime</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">ONNXEmbedder</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">session</span>      <span style="color:#0550ae">*</span><span style="color:#1f2328">onnxruntime_go</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Session</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">inputName</span>    <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">outputName</span>   <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">tokenizer</span>    <span style="color:#0550ae">*</span><span style="color:#1f2328">Tokenizer</span>  <span style="color:#57606a">// Hypothetical tokenizer implementation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">maxLength</span>    <span style="color:#cf222e">int</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// NewONNXEmbedder creates a new embedder using the specified ONNX model</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewONNXEmbedder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">modelPath</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">ONNXEmbedder</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Load the ONNX model</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">session</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">onnxruntime_go</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewSession</span><span style="color:#1f2328">(</span><span style="color:#1f2328">modelPath</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to load ONNX model: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Get input and output names (typically known in advance, but can be queried)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">inputName</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">session</span><span style="color:#1f2328">.</span><span style="color:#6639ba">InputNames</span><span style="color:#1f2328">()[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">outputName</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">session</span><span style="color:#1f2328">.</span><span style="color:#6639ba">OutputNames</span><span style="color:#1f2328">()[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Initialize tokenizer for the model</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">tokenizer</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">NewTokenizer</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;path/to/tokenizer&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to load tokenizer: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">ONNXEmbedder</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">session</span><span style="color:#1f2328">:</span>    <span style="color:#1f2328">session</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">inputName</span><span style="color:#1f2328">:</span>  <span style="color:#1f2328">inputName</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">outputName</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">outputName</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">tokenizer</span><span style="color:#1f2328">:</span>  <span style="color:#1f2328">tokenizer</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">maxLength</span><span style="color:#1f2328">:</span>  <span style="color:#0550ae">512</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">},</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// EmbedText generates embeddings for the given text</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">e</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ONNXEmbedder</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">EmbedText</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">text</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([]</span><span style="color:#cf222e">float32</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Tokenize input text</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">tokens</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">e</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tokenizer</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Encode</span><span style="color:#1f2328">(</span><span style="color:#1f2328">text</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">e</span><span style="color:#1f2328">.</span><span style="color:#1f2328">maxLength</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;tokenization failed: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Create input tensor</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">inputTensor</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">onnxruntime_go</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewTensor</span><span style="color:#1f2328">(</span><span style="color:#1f2328">tokens</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to create input tensor: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Run inference</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">outputs</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">e</span><span style="color:#1f2328">.</span><span style="color:#1f2328">session</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Run</span><span style="color:#1f2328">(</span><span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#0550ae">*</span><span style="color:#1f2328">onnxruntime_go</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Tensor</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">e</span><span style="color:#1f2328">.</span><span style="color:#1f2328">inputName</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">inputTensor</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;model inference failed: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Extract embedding from output</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">embedding</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ok</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">outputs</span><span style="color:#1f2328">[</span><span style="color:#1f2328">e</span><span style="color:#1f2328">.</span><span style="color:#1f2328">outputName</span><span style="color:#1f2328">].</span><span style="color:#6639ba">GetFlat</span><span style="color:#1f2328">().([]</span><span style="color:#cf222e">float32</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">ok</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;unexpected output format&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">embedding</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This approach has advantages:</p>
<ul>
<li>No separate service to manage</li>
<li>Lower latency without HTTP overhead</li>
<li>Complete control over model loading and execution</li>
</ul>
<p>But also challenges:</p>
<ul>
<li>More complex implementation including tokenization</li>
<li>Memory management between Go and the model</li>
<li>Dependencies on CGO and external libraries</li>
</ul>
<p>For many teams, the API server approach offers a better balance of simplicity and performance.</p>
<h4 id="standardized-embedder-interface">Standardized Embedder Interface</h4>
<p>Regardless of the implementation details, defining a clean interface for embedding generation makes your system more flexible:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">package</span> <span style="color:#1f2328">embedding</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#0a3069">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Embedder defines the interface for generating text embeddings</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Embedder</span> <span style="color:#cf222e">interface</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// EmbedText generates an embedding vector for a single text</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">EmbedText</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">text</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([]</span><span style="color:#cf222e">float32</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Dimensions returns the dimension count of the embedding vectors</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">Dimensions</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">int</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Factory creates embedders based on configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewEmbedder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">config</span> <span style="color:#1f2328">Config</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">Embedder</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">switch</span> <span style="color:#1f2328">config</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Type</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">case</span> <span style="color:#0a3069">&#34;sentence-transformer&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#6639ba">NewSentenceTransformerEmbedder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">config</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ServerURL</span><span style="color:#1f2328">),</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">case</span> <span style="color:#0a3069">&#34;onnx&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#6639ba">NewONNXEmbedder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">config</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ModelPath</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">case</span> <span style="color:#0a3069">&#34;fasttext&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#6639ba">NewFastTextEmbedder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">config</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ModelPath</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">default</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;unsupported embedder type: %s&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">config</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Type</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This interface approach allows:</p>
<ul>
<li>Easy switching between embedding models</li>
<li>Mocking for testing</li>
<li>Clear separation of concerns</li>
<li>Future extension to support new model types</li>
</ul>
<h3 id="evaluating-embedding-model-quality">Evaluating Embedding Model Quality</h3>
<p>How do you know if your chosen embedding model is good enough? It&rsquo;s surprisingly difficult to evaluate embedding quality directly, but there are practical approaches:</p>
<ol>
<li>
<p><strong>Retrieval Testing</strong>: Create a set of test queries with known relevant documents, then measure how often your system retrieves those documents</p>
</li>
<li>
<p><strong>Contrastive Testing</strong>: For each test query, include both semantically similar and dissimilar documents, and check if the model consistently ranks similar ones higher</p>
</li>
<li>
<p><strong>Human Evaluation</strong>: Have domain experts review search results for common queries and provide feedback</p>
</li>
</ol>
<p>Here&rsquo;s a simple evaluation harness I&rsquo;ve used in practice:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">package</span> <span style="color:#1f2328">evaluation</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;sort&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;myproject/embedding&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;myproject/vectorstore&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// TestCase defines a test query and expected relevant documents</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">TestCase</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Query</span>            <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">RelevantDocIDs</span>   <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">IrrelevantDocIDs</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span>  <span style="color:#57606a">// Optional control documents</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// EvaluateRetrieval tests embedding quality with retrieval metrics</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">EvaluateRetrieval</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">embedder</span> <span style="color:#1f2328">embedding</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Embedder</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">store</span> <span style="color:#1f2328">vectorstore</span><span style="color:#1f2328">.</span><span style="color:#1f2328">VectorStore</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">testCases</span> <span style="color:#1f2328">[]</span><span style="color:#1f2328">TestCase</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">Results</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">results</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">Results</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">tc</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">testCases</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Embed the query</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">queryVector</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">embedder</span><span style="color:#1f2328">.</span><span style="color:#6639ba">EmbedText</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">tc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Query</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">results</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Search with generous limit to ensure we catch all relevant docs</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">docs</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">store</span><span style="color:#1f2328">.</span><span style="color:#6639ba">SimilaritySearch</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">queryVector</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">30</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">results</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Calculate metrics</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">result</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">evaluateResults</span><span style="color:#1f2328">(</span><span style="color:#1f2328">docs</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">tc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">RelevantDocIDs</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">results</span><span style="color:#1f2328">.</span><span style="color:#1f2328">TestResults</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">results</span><span style="color:#1f2328">.</span><span style="color:#1f2328">TestResults</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">result</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Update aggregate stats</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">results</span><span style="color:#1f2328">.</span><span style="color:#1f2328">AveragePrecision</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Precision</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">results</span><span style="color:#1f2328">.</span><span style="color:#1f2328">AverageRecall</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Recall</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">results</span><span style="color:#1f2328">.</span><span style="color:#1f2328">AverageMRR</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">MRR</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Calculate averages</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">count</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">float64</span><span style="color:#1f2328">(</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">testCases</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">results</span><span style="color:#1f2328">.</span><span style="color:#1f2328">AveragePrecision</span> <span style="color:#0550ae">/=</span> <span style="color:#1f2328">count</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">results</span><span style="color:#1f2328">.</span><span style="color:#1f2328">AverageRecall</span> <span style="color:#0550ae">/=</span> <span style="color:#1f2328">count</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">results</span><span style="color:#1f2328">.</span><span style="color:#1f2328">AverageMRR</span> <span style="color:#0550ae">/=</span> <span style="color:#1f2328">count</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">results</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Helper function to evaluate a single test case</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">evaluateResults</span><span style="color:#1f2328">(</span><span style="color:#1f2328">docs</span> <span style="color:#1f2328">[]</span><span style="color:#1f2328">vectorstore</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">relevantIDs</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">TestResult</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Implementation of precision, recall, and MRR calculation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This approach provides quantitative metrics on your model&rsquo;s performance for your specific domain and use case.</p>
<h3 id="best-practices-for-production-deployment">Best Practices for Production Deployment</h3>
<p>After implementing embedding generation for several production RAG systems, I&rsquo;ve learned some valuable lessons:</p>
<ol>
<li>
<p><strong>Caching is crucial</strong>: Store generated embeddings persistently to avoid regenerating them for commonly accessed documents or queries. A simple LRU cache for query embeddings can dramatically improve performance.</p>
</li>
<li>
<p><strong>Monitor embedding drift</strong>: As your content evolves, periodically evaluate embedding quality to ensure it still performs well on newer content. Models trained on older data may struggle with emerging terminology.</p>
</li>
<li>
<p><strong>Version your embeddings</strong>: Store the model version alongside each embedding to enable smooth transitions when upgrading models. This allows for gradual reprocessing of your corpus.</p>
</li>
<li>
<p><strong>Implement fallbacks</strong>: Have backup embedding generation strategies in case your primary approach fails. This could be a simpler, more reliable model or even a keyword-based approach.</p>
</li>
<li>
<p><strong>Consider domain adaptation</strong>: For specialized domains, fine-tuning an embedding model on domain-specific text can significantly improve performance. This is becoming easier with techniques like PEFT (Parameter-Efficient Fine-Tuning).</p>
</li>
</ol>
<p>Here&rsquo;s how embedding versioning might look in practice:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Document with embedding version</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Document</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ID</span>              <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Content</span>         <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Metadata</span>        <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Embedding</span>       <span style="color:#1f2328">[]</span><span style="color:#cf222e">float32</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">EmbeddingModel</span>  <span style="color:#cf222e">string</span>  <span style="color:#57606a">// Model identifier</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">EmbeddingVersion</span> <span style="color:#cf222e">string</span>  <span style="color:#57606a">// Version string</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Add version checking to search</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchService</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Search</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">query</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([]</span><span style="color:#1f2328">Result</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Generate embedding for query</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">embedding</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">embedder</span><span style="color:#1f2328">.</span><span style="color:#6639ba">EmbedText</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">query</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Get current model info</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">currentModel</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">embedder</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ModelIdentifier</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">currentVersion</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">embedder</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ModelVersion</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Perform search with model filtering</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Only compare vectors from the same model/version</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">filter</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{}{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;embeddingModel&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">currentModel</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;embeddingVersion&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">currentVersion</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">results</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">vectorStore</span><span style="color:#1f2328">.</span><span style="color:#6639ba">SimilaritySearchWithFilter</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">embedding</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">10</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">filter</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// If results are insufficient, consider fallback strategy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">results</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&lt;</span> <span style="color:#0550ae">3</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Implement fallback search strategy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">results</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This approach ensures that you only compare embeddings generated by the same model version, avoiding the &ldquo;comparing apples to oranges&rdquo; problem that can occur when mixing embeddings from different models.</p>
<h3 id="looking-ahead-the-future-of-embeddings">Looking Ahead: The Future of Embeddings</h3>
<p>The embedding model landscape is evolving incredibly quickly. Several trends worth watching:</p>
<ol>
<li>
<p><strong>Smaller, faster models</strong>: New techniques are making high-quality embedding models smaller and faster, perfect for local deployment.</p>
</li>
<li>
<p><strong>Domain-specific embeddings</strong>: Models pre-trained for specific domains (legal, medical, financial) are emerging with superior performance in their niches.</p>
</li>
<li>
<p><strong>Multilingual capabilities</strong>: Newer models handle multiple languages more effectively, reducing the need for language-specific implementations.</p>
</li>
<li>
<p><strong>Hybrid approaches</strong>: Combining neural embeddings with traditional techniques like BM25 is proving extremely effective for certain use cases.</p>
</li>
</ol>
<p>Our architecture with clear interfaces allows us to adopt these advances as they mature, without rebuilding our entire system.</p>
<h2 id="document-processing-pipeline-1">Document Processing Pipeline</h2>
<p>The quality of your RAG system is only as good as the document processing that feeds it. I&rsquo;ve seen brilliantly architected systems fail because they couldn&rsquo;t properly extract text from PDFs, or because they chunked documents in ways that fragmented key information. The document processing pipeline might not be the most glamorous part of your RAG system, but it&rsquo;s often where the real magic – or tragic failure – happens.</p>
<p>I once spent three days debugging poor search results in a legal document system only to discover the culprit wasn&rsquo;t our embedding model or vector database – it was chunks that split paragraphs mid-sentence, destroying semantic coherence. After adjusting our chunking strategy, relevance scores improved by over 30% overnight.</p>
<p>Let&rsquo;s build a document processing pipeline that won&rsquo;t let you down when it matters most.</p>
<h3 id="efficient-document-loading-and-parsing">Efficient Document Loading and Parsing</h3>
<p>The first step in our pipeline is getting documents into our system. This seems straightforward until you encounter the messy reality of enterprise document collections – inconsistent formats, malformed files, embedded images, password protection, and other obstacles.</p>
<p>Let&rsquo;s create a flexible document loading system that handles these challenges gracefully.</p>
<h4 id="the-document-loader-interface">The Document Loader Interface</h4>
<p>We&rsquo;ll start with a clean interface that abstracts away the specifics of different document formats:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">package</span> <span style="color:#1f2328">docprocessing</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;path/filepath&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Document represents a document with its metadata and content</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Document</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ID</span>          <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Title</span>       <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Content</span>     <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Metadata</span>    <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Source</span>      <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// DocumentLoader defines the interface for loading documents from various sources</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">DocumentLoader</span> <span style="color:#cf222e">interface</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// LoadDocument loads a single document from a Reader</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">LoadDocument</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">reader</span> <span style="color:#1f2328">io</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Reader</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">metadata</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// SupportsExtension returns true if this loader can handle the given file extension</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">SupportsExtension</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ext</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// DocumentProcessor orchestrates the loading of documents</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">DocumentProcessor</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">loaders</span> <span style="color:#1f2328">[]</span><span style="color:#1f2328">DocumentLoader</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// NewDocumentProcessor creates a new processor with the given loaders</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewDocumentProcessor</span><span style="color:#1f2328">(</span><span style="color:#1f2328">loaders</span> <span style="color:#0550ae">...</span><span style="color:#1f2328">DocumentLoader</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">DocumentProcessor</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">DocumentProcessor</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">loaders</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">loaders</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// ProcessFile processes a single file and returns the extracted document</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">p</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">DocumentProcessor</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">ProcessFile</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">filePath</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Get file extension</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ext</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ToLower</span><span style="color:#1f2328">(</span><span style="color:#1f2328">filepath</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Ext</span><span style="color:#1f2328">(</span><span style="color:#1f2328">filePath</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Find appropriate loader</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">loader</span> <span style="color:#1f2328">DocumentLoader</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">l</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">p</span><span style="color:#1f2328">.</span><span style="color:#1f2328">loaders</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">l</span><span style="color:#1f2328">.</span><span style="color:#6639ba">SupportsExtension</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ext</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">loader</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">l</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">loader</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;no loader available for extension: %s&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ext</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Open the file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">file</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">os</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Open</span><span style="color:#1f2328">(</span><span style="color:#1f2328">filePath</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to open file: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">defer</span> <span style="color:#1f2328">file</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Close</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Extract basic metadata</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">fileInfo</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">file</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Stat</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to get file info: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">metadata</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{}{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;filename&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">filepath</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Base</span><span style="color:#1f2328">(</span><span style="color:#1f2328">filePath</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;path&#34;</span><span style="color:#1f2328">:</span>     <span style="color:#1f2328">filePath</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;size&#34;</span><span style="color:#1f2328">:</span>     <span style="color:#1f2328">fileInfo</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Size</span><span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;modified&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">fileInfo</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ModTime</span><span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Load the document</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">doc</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">loader</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadDocument</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">file</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">metadata</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to load document: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Generate a stable ID if not provided</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ID</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ID</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">generateID</span><span style="color:#1f2328">(</span><span style="color:#1f2328">filePath</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">doc</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// ProcessDirectory recursively processes all files in a directory</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">p</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">DocumentProcessor</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">ProcessDirectory</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">dirPath</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([]</span><span style="color:#0550ae">*</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">documents</span> <span style="color:#1f2328">[]</span><span style="color:#0550ae">*</span><span style="color:#1f2328">Document</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">filepath</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Walk</span><span style="color:#1f2328">(</span><span style="color:#1f2328">dirPath</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">path</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">info</span> <span style="color:#1f2328">os</span><span style="color:#1f2328">.</span><span style="color:#1f2328">FileInfo</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">error</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Skip directories</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">info</span><span style="color:#1f2328">.</span><span style="color:#6639ba">IsDir</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Process the file</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">doc</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">p</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ProcessFile</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">path</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// Log error but continue processing other files</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Error processing %s: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">path</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">documents</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">documents</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">doc</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;directory walk failed: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">documents</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Helper function to generate a stable ID from file path</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">generateID</span><span style="color:#1f2328">(</span><span style="color:#1f2328">path</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">string</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">h</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">sha256</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Write</span><span style="color:#1f2328">([]</span><span style="color:#6639ba">byte</span><span style="color:#1f2328">(</span><span style="color:#1f2328">path</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sprintf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;%x&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sum</span><span style="color:#1f2328">(</span><span style="color:#cf222e">nil</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This interface-based approach allows us to handle various document types while keeping the core processing logic clean and maintainable.</p>
<h4 id="implementing-format-specific-loaders">Implementing Format-Specific Loaders</h4>
<p>Now let&rsquo;s implement loaders for common document formats:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// TextLoader handles plain text files</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">TextLoader</span> <span style="color:#cf222e">struct</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">l</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">TextLoader</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">SupportsExtension</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ext</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">ext</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;.txt&#34;</span> <span style="color:#0550ae">||</span> <span style="color:#1f2328">ext</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;.text&#34;</span> <span style="color:#0550ae">||</span> <span style="color:#1f2328">ext</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;.md&#34;</span> <span style="color:#0550ae">||</span> <span style="color:#1f2328">ext</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;.markdown&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">l</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">TextLoader</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">LoadDocument</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">reader</span> <span style="color:#1f2328">io</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Reader</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">metadata</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Read the entire content</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">content</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">io</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ReadAll</span><span style="color:#1f2328">(</span><span style="color:#1f2328">reader</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to read text: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Create document with title from filename</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">filename</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">_</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;filename&#34;</span><span style="color:#1f2328">].(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Title</span><span style="color:#1f2328">:</span>    <span style="color:#1f2328">filename</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Content</span><span style="color:#1f2328">:</span>  <span style="color:#6639ba">string</span><span style="color:#1f2328">(</span><span style="color:#1f2328">content</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Metadata</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">metadata</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Source</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;path&#34;</span><span style="color:#1f2328">].(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">},</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// PDFLoader handles PDF documents</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">PDFLoader</span> <span style="color:#cf222e">struct</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">l</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">PDFLoader</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">SupportsExtension</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ext</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">ext</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;.pdf&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">l</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">PDFLoader</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">LoadDocument</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">reader</span> <span style="color:#1f2328">io</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Reader</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">metadata</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Note: This is a simplified version</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// In a real implementation, you&#39;d use a library like UniDoc or pdfcpu</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Example using a hypothetical PDF library:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">pdfContent</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">extractTextFromPDF</span><span style="color:#1f2328">(</span><span style="color:#1f2328">reader</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to extract PDF text: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Extract additional metadata from PDF</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">pdfMetadata</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">extractPDFMetadata</span><span style="color:#1f2328">(</span><span style="color:#1f2328">reader</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Log but continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Failed to extract PDF metadata: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Merge PDF-specific metadata</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> <span style="color:#1f2328">k</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">v</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">pdfMetadata</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#1f2328">k</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">v</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Use PDF title if available, otherwise filename</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">title</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">pdfMetadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;title&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">title</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">title</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;filename&#34;</span><span style="color:#1f2328">].(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Title</span><span style="color:#1f2328">:</span>    <span style="color:#1f2328">title</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Content</span><span style="color:#1f2328">:</span>  <span style="color:#1f2328">pdfContent</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Metadata</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">metadata</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Source</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;path&#34;</span><span style="color:#1f2328">].(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">},</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>For a production system, you&rsquo;d add loaders for other formats like DOCX, HTML, and more, potentially using external helper services for more complex formats. The key advantage of this approach is that the core processing logic remains unchanged as you add support for new formats.</p>
<h3 id="text-chunking-strategies-for-optimal-retrieval">Text Chunking Strategies for Optimal Retrieval</h3>
<p>Once we have the document content, we need to split it into chunks for embedding and storage. This seemingly simple task has profound implications for retrieval quality.</p>
<h4 id="why-chunking-matters">Why Chunking Matters</h4>
<p>Imagine searching for a specific legal clause in a 100-page contract. If we stored the entire contract as a single chunk, the embedding would be a muddy average of all the content, making specific queries hard to match. On the other hand, if we chunk too finely (say, by sentence), we might lose important context that spans multiple sentences.</p>
<p>The ideal chunking strategy depends on your specific use case, but there are several approaches worth considering:</p>
<h4 id="fixed-size-chunking">Fixed-Size Chunking</h4>
<p>The simplest approach is to split text into chunks of approximately equal size:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// ChunkOptions configures the chunking process</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">ChunkOptions</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ChunkSize</span>          <span style="color:#cf222e">int</span>  <span style="color:#57606a">// Target size in characters</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ChunkOverlap</span>       <span style="color:#cf222e">int</span>  <span style="color:#57606a">// Overlap between chunks</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">KeepSeparator</span>      <span style="color:#cf222e">bool</span> <span style="color:#57606a">// Whether to keep separators in chunks</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// FixedSizeChunker splits text into chunks of approximately equal size</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">FixedSizeChunker</span><span style="color:#1f2328">(</span><span style="color:#1f2328">doc</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">opts</span> <span style="color:#1f2328">ChunkOptions</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([]</span><span style="color:#1f2328">Chunk</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">opts</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ChunkSize</span> <span style="color:#0550ae">&lt;=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;chunk size must be positive&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">text</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Content</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">chunks</span> <span style="color:#1f2328">[]</span><span style="color:#1f2328">Chunk</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Simple chunking by character count</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span> <span style="color:#1f2328">&lt;</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">text</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">opts</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ChunkSize</span> <span style="color:#0550ae">-</span> <span style="color:#1f2328">opts</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ChunkOverlap</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">end</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">opts</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ChunkSize</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">end</span> <span style="color:#1f2328">&gt;</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">text</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">end</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">text</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">chunk</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">Chunk</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Text</span><span style="color:#1f2328">:</span>     <span style="color:#1f2328">text</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">:</span><span style="color:#1f2328">end</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Metadata</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Metadata</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Source</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Source</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">DocID</span><span style="color:#1f2328">:</span>    <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ID</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">ChunkIndex</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">chunks</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">chunks</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">chunks</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">chunk</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">end</span> <span style="color:#0550ae">==</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">text</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">chunks</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This approach is simple but often cuts text at awkward places, breaking sentences or logical units. Let&rsquo;s improve it.</p>
<h4 id="semantic-chunking">Semantic Chunking</h4>
<p>A more sophisticated approach respects semantic boundaries like paragraphs and sections:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// SemanticChunker splits text by semantic boundaries (paragraphs, sections)</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">SemanticChunker</span><span style="color:#1f2328">(</span><span style="color:#1f2328">doc</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">opts</span> <span style="color:#1f2328">ChunkOptions</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([]</span><span style="color:#1f2328">Chunk</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">opts</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ChunkSize</span> <span style="color:#0550ae">&lt;=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;chunk size must be positive&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Define paragraph separator patterns</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">paragraphSeparators</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;\n\n&#34;</span><span style="color:#1f2328">,</span>            <span style="color:#57606a">// Double newline</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;\n\t&#34;</span><span style="color:#1f2328">,</span>            <span style="color:#57606a">// Newline followed by tab</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;\n    &#34;</span><span style="color:#1f2328">,</span>          <span style="color:#57606a">// Newline followed by 4 spaces</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;\n## &#34;</span><span style="color:#1f2328">,</span>           <span style="color:#57606a">// Markdown headings</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;\n### &#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Split text by paragraphs first</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">paragraphs</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">text</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Content</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Initial split by the most common paragraph separator</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">parts</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Split</span><span style="color:#1f2328">(</span><span style="color:#1f2328">text</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;\n\n&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">part</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">parts</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Further split by other paragraph indicators</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">found</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">sep</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">paragraphSeparators</span><span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">:]</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Contains</span><span style="color:#1f2328">(</span><span style="color:#1f2328">part</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">sep</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">subParts</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Split</span><span style="color:#1f2328">(</span><span style="color:#1f2328">part</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">sep</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">sp</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">subParts</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> <span style="color:#1f2328">i</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a">// Prepend the separator to maintain context</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#1f2328">sp</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">sep</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">sp</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">sp</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#1f2328">paragraphs</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">paragraphs</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">sp</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">found</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">found</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">part</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">paragraphs</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">paragraphs</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">part</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Merge paragraphs to create chunks close to the target size</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">chunks</span> <span style="color:#1f2328">[]</span><span style="color:#1f2328">Chunk</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">currentChunk</span> <span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Builder</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">currentSize</span> <span style="color:#cf222e">int</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">para</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">paragraphs</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">paraSize</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">para</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// If adding this paragraph exceeds chunk size and we already have content,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// finish the current chunk</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">currentSize</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">currentSize</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">paraSize</span> <span style="color:#1f2328">&gt;</span> <span style="color:#1f2328">opts</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ChunkSize</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">chunks</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">chunks</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">Chunk</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">Text</span><span style="color:#1f2328">:</span>       <span style="color:#1f2328">currentChunk</span><span style="color:#1f2328">.</span><span style="color:#6639ba">String</span><span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">Metadata</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Metadata</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">Source</span><span style="color:#1f2328">:</span>     <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Source</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">DocID</span><span style="color:#1f2328">:</span>      <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ID</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">ChunkIndex</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">chunks</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">currentChunk</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Reset</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">currentSize</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Handle paragraphs larger than chunk size</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">paraSize</span> <span style="color:#1f2328">&gt;</span> <span style="color:#1f2328">opts</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ChunkSize</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// If we have current content, save it</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">currentSize</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">chunks</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">chunks</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">Chunk</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">Text</span><span style="color:#1f2328">:</span>       <span style="color:#1f2328">currentChunk</span><span style="color:#1f2328">.</span><span style="color:#6639ba">String</span><span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">Metadata</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Metadata</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">Source</span><span style="color:#1f2328">:</span>     <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Source</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">DocID</span><span style="color:#1f2328">:</span>      <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ID</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">ChunkIndex</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">chunks</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">currentChunk</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Reset</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">currentSize</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// Use fixed-size chunking for this large paragraph</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span> <span style="color:#1f2328">&lt;</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">para</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">opts</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ChunkSize</span> <span style="color:#0550ae">-</span> <span style="color:#1f2328">opts</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ChunkOverlap</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">end</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">opts</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ChunkSize</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#1f2328">end</span> <span style="color:#1f2328">&gt;</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">para</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">end</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">para</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">chunks</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">chunks</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">Chunk</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">Text</span><span style="color:#1f2328">:</span>       <span style="color:#1f2328">para</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">:</span><span style="color:#1f2328">end</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">Metadata</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Metadata</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">Source</span><span style="color:#1f2328">:</span>     <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Source</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">DocID</span><span style="color:#1f2328">:</span>      <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ID</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">ChunkIndex</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">chunks</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#1f2328">end</span> <span style="color:#0550ae">==</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">para</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// Add paragraph to current chunk</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">currentSize</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">currentChunk</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WriteString</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;\n\n&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">currentSize</span> <span style="color:#0550ae">+=</span> <span style="color:#0550ae">2</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">currentChunk</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WriteString</span><span style="color:#1f2328">(</span><span style="color:#1f2328">para</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">currentSize</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">paraSize</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Add the last chunk if there&#39;s any content left</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">currentSize</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">chunks</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">chunks</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">Chunk</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Text</span><span style="color:#1f2328">:</span>       <span style="color:#1f2328">currentChunk</span><span style="color:#1f2328">.</span><span style="color:#6639ba">String</span><span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Metadata</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Metadata</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Source</span><span style="color:#1f2328">:</span>     <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Source</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">DocID</span><span style="color:#1f2328">:</span>      <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ID</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">ChunkIndex</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">chunks</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">chunks</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This approach preserves paragraph boundaries when possible, creating chunks that are more semantically coherent. This typically leads to better embedding quality since semantically related content stays together.</p>
<h4 id="hybrid-approaches">Hybrid Approaches</h4>
<p>For specific document types, you might want custom chunking strategies:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// StructuredDocumentChunker handles documents with clear structural elements</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// like HTML, Markdown headings, or legal document sections</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">StructuredDocumentChunker</span><span style="color:#1f2328">(</span><span style="color:#1f2328">doc</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">opts</span> <span style="color:#1f2328">ChunkOptions</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([]</span><span style="color:#1f2328">Chunk</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Detect document type from metadata or content</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">format</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">detectDocumentFormat</span><span style="color:#1f2328">(</span><span style="color:#1f2328">doc</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">switch</span> <span style="color:#1f2328">format</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">case</span> <span style="color:#0a3069">&#34;markdown&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#6639ba">markdownChunker</span><span style="color:#1f2328">(</span><span style="color:#1f2328">doc</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">opts</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">case</span> <span style="color:#0a3069">&#34;html&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#6639ba">htmlChunker</span><span style="color:#1f2328">(</span><span style="color:#1f2328">doc</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">opts</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">case</span> <span style="color:#0a3069">&#34;legal&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#6639ba">legalDocumentChunker</span><span style="color:#1f2328">(</span><span style="color:#1f2328">doc</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">opts</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">default</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Fall back to semantic chunker</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#6639ba">SemanticChunker</span><span style="color:#1f2328">(</span><span style="color:#1f2328">doc</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">opts</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Example of a specialized chunker for Markdown</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">markdownChunker</span><span style="color:#1f2328">(</span><span style="color:#1f2328">doc</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">opts</span> <span style="color:#1f2328">ChunkOptions</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([]</span><span style="color:#1f2328">Chunk</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Split by headings (##, ###, etc.)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">headingPattern</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">regexp</span><span style="color:#1f2328">.</span><span style="color:#6639ba">MustCompile</span><span style="color:#1f2328">(</span><span style="color:#0a3069">`(?m)^(#{1,6})\s+(.+)$`</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Implementation details...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>The right chunking strategy can dramatically impact retrieval quality. In my experience, erring on the side of slightly larger chunks (500-1000 tokens) with meaningful semantic boundaries tends to work best for general-purpose RAG systems.</p>
<h3 id="metadata-extraction-and-storage">Metadata Extraction and Storage</h3>
<p>Metadata is the unsung hero of effective RAG systems, enabling more precise retrieval and filtering. Let&rsquo;s develop a robust metadata extraction system:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// MetadataExtractor extracts metadata from documents</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">MetadataExtractor</span> <span style="color:#cf222e">interface</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">Extract</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">doc</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{},</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// CompositeExtractor combines multiple extractors</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">CompositeExtractor</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">extractors</span> <span style="color:#1f2328">[]</span><span style="color:#1f2328">MetadataExtractor</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewCompositeExtractor</span><span style="color:#1f2328">(</span><span style="color:#1f2328">extractors</span> <span style="color:#0550ae">...</span><span style="color:#1f2328">MetadataExtractor</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">CompositeExtractor</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">CompositeExtractor</span><span style="color:#1f2328">{</span><span style="color:#1f2328">extractors</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">extractors</span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">e</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">CompositeExtractor</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Extract</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">doc</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{},</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">metadata</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">make</span><span style="color:#1f2328">(</span><span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Copy existing metadata</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">k</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">v</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Metadata</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#1f2328">k</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">v</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Apply each extractor</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">extractor</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">e</span><span style="color:#1f2328">.</span><span style="color:#1f2328">extractors</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">additionalMeta</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">extractor</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Extract</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">doc</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// Log but continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Metadata extraction error: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Merge additional metadata</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> <span style="color:#1f2328">k</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">v</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">additionalMeta</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#1f2328">k</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">v</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">metadata</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Example specialized extractors</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// TextAnalysisExtractor extracts metadata through text analysis</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">TextAnalysisExtractor</span> <span style="color:#cf222e">struct</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">e</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">TextAnalysisExtractor</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Extract</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">doc</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{},</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">metadata</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">make</span><span style="color:#1f2328">(</span><span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Extract language</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">language</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">confidence</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">detectLanguage</span><span style="color:#1f2328">(</span><span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Content</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">confidence</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0.8</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;language&#34;</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">language</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Extract content creation date if present in text</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">dates</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">extractDates</span><span style="color:#1f2328">(</span><span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Content</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">dates</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;extractedDates&#34;</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">dates</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Extract keywords</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">keywords</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">extractKeywords</span><span style="color:#1f2328">(</span><span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Content</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">keywords</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;keywords&#34;</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">keywords</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Detect content type (technical, legal, marketing, etc.)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">contentType</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">classifyContent</span><span style="color:#1f2328">(</span><span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Content</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">contentType</span> <span style="color:#0550ae">!=</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;contentType&#34;</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">contentType</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">metadata</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// EntityExtractor extracts named entities</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">EntityExtractor</span> <span style="color:#cf222e">struct</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">e</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">EntityExtractor</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Extract</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">doc</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{},</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">metadata</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">make</span><span style="color:#1f2328">(</span><span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Extract people, organizations, locations</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">entities</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">extractNamedEntities</span><span style="color:#1f2328">(</span><span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Content</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">entities</span><span style="color:#1f2328">.</span><span style="color:#1f2328">People</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;people&#34;</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">entities</span><span style="color:#1f2328">.</span><span style="color:#1f2328">People</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">entities</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Organizations</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;organizations&#34;</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">entities</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Organizations</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">entities</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Locations</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;locations&#34;</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">entities</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Locations</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">metadata</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>Rich metadata enables powerful filtering during retrieval, which is especially valuable for legal, compliance, and governance use cases.</p>
<h3 id="handling-different-document-types">Handling Different Document Types</h3>
<p>Different document types often require specialized processing. Let&rsquo;s explore how to handle some common scenarios:</p>
<h4 id="images-and-pdfs-with-ocr">Images and PDFs with OCR</h4>
<p>For scanned documents or images, optical character recognition (OCR) is essential:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// OCRProcessor handles image-based content extraction</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">OCRProcessor</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ocrLanguages</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ocrEngine</span>    <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">tempDir</span>      <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewOCRProcessor</span><span style="color:#1f2328">(</span><span style="color:#1f2328">languages</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">engine</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">OCRProcessor</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">tempDir</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">os</span><span style="color:#1f2328">.</span><span style="color:#6639ba">TempDir</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">OCRProcessor</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">ocrLanguages</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">languages</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">ocrEngine</span><span style="color:#1f2328">:</span>    <span style="color:#1f2328">engine</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">tempDir</span><span style="color:#1f2328">:</span>      <span style="color:#1f2328">tempDir</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">p</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">OCRProcessor</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">ProcessImage</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">imagePath</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Execute OCR on the image</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// In a real implementation, this would call Tesseract or a similar OCR tool</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">cmd</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">exec</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CommandContext</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;tesseract&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">imagePath</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;stdout&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;-l&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Join</span><span style="color:#1f2328">(</span><span style="color:#1f2328">p</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ocrLanguages</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;+&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">output</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">cmd</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Output</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;OCR processing failed: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#6639ba">string</span><span style="color:#1f2328">(</span><span style="color:#1f2328">output</span><span style="color:#1f2328">),</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">p</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">OCRProcessor</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">ProcessPDFWithOCR</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">pdfPath</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Extract images from PDF pages</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Process each image with OCR</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Combine the results</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Implementation details would depend on your PDF library</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// ...</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">combinedText</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h4 id="structured-data-csv-json-xml">Structured Data (CSV, JSON, XML)</h4>
<p>Structured data requires special handling to preserve relationships:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// CSVLoader handles CSV files</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">CSVLoader</span> <span style="color:#cf222e">struct</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">l</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">CSVLoader</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">SupportsExtension</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ext</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">ext</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;.csv&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">l</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">CSVLoader</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">LoadDocument</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">reader</span> <span style="color:#1f2328">io</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Reader</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">metadata</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Parse the CSV</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">csvReader</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">csv</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewReader</span><span style="color:#1f2328">(</span><span style="color:#1f2328">reader</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Read header</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">header</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">csvReader</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Read</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to read CSV header: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Read records</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">records</span> <span style="color:#1f2328">[][]</span><span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">record</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">csvReader</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Read</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">io</span><span style="color:#1f2328">.</span><span style="color:#1f2328">EOF</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to read CSV row: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">records</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">records</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">record</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Convert to text representation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">content</span> <span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Builder</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Include header info</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">content</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WriteString</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;CSV Document with columns: &#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">content</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WriteString</span><span style="color:#1f2328">(</span><span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Join</span><span style="color:#1f2328">(</span><span style="color:#1f2328">header</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;, &#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">content</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WriteString</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;\n\n&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Add each row as a paragraph</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">record</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">records</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">content</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WriteString</span><span style="color:#1f2328">(</span><span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sprintf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Row %d:\n&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">i</span><span style="color:#0550ae">+</span><span style="color:#0550ae">1</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> <span style="color:#1f2328">j</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">value</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">record</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">j</span> <span style="color:#1f2328">&lt;</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">header</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">content</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WriteString</span><span style="color:#1f2328">(</span><span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sprintf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;%s: %s\n&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">header</span><span style="color:#1f2328">[</span><span style="color:#1f2328">j</span><span style="color:#1f2328">],</span> <span style="color:#1f2328">value</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">content</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WriteString</span><span style="color:#1f2328">(</span><span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sprintf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Column %d: %s\n&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">j</span><span style="color:#0550ae">+</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">value</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">content</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WriteString</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;\n&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Add row count to metadata</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;rowCount&#34;</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">records</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;columnCount&#34;</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">header</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;columns&#34;</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">header</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Title</span><span style="color:#1f2328">:</span>    <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;filename&#34;</span><span style="color:#1f2328">].(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Content</span><span style="color:#1f2328">:</span>  <span style="color:#1f2328">content</span><span style="color:#1f2328">.</span><span style="color:#6639ba">String</span><span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Metadata</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">metadata</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Source</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;path&#34;</span><span style="color:#1f2328">].(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">},</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>Converting structured data to a text representation that captures the relationships between fields is key to enabling semantic search over this data.</p>
<h3 id="implementation-in-go-with-example-code">Implementation in Go with Example Code</h3>
<p>Now, let&rsquo;s tie everything together into a complete document processing pipeline:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// ProcessingPipeline coordinates the complete document processing workflow</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">ProcessingPipeline</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">processor</span>        <span style="color:#0550ae">*</span><span style="color:#1f2328">DocumentProcessor</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">metadataExtractor</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">CompositeExtractor</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">chunker</span>          <span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ChunkOptions</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([]</span><span style="color:#1f2328">Chunk</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">embedder</span>         <span style="color:#1f2328">embedding</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Embedder</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">vectorStore</span>      <span style="color:#1f2328">vectorstore</span><span style="color:#1f2328">.</span><span style="color:#1f2328">VectorStore</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">chunkOptions</span>     <span style="color:#1f2328">ChunkOptions</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// NewProcessingPipeline creates a new document processing pipeline</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewProcessingPipeline</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">processor</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">DocumentProcessor</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">metadataExtractor</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">CompositeExtractor</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">chunker</span> <span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ChunkOptions</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([]</span><span style="color:#1f2328">Chunk</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">embedder</span> <span style="color:#1f2328">embedding</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Embedder</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">vectorStore</span> <span style="color:#1f2328">vectorstore</span><span style="color:#1f2328">.</span><span style="color:#1f2328">VectorStore</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">chunkOptions</span> <span style="color:#1f2328">ChunkOptions</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ProcessingPipeline</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">ProcessingPipeline</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">processor</span><span style="color:#1f2328">:</span>        <span style="color:#1f2328">processor</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">metadataExtractor</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">metadataExtractor</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">chunker</span><span style="color:#1f2328">:</span>          <span style="color:#1f2328">chunker</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">embedder</span><span style="color:#1f2328">:</span>         <span style="color:#1f2328">embedder</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">vectorStore</span><span style="color:#1f2328">:</span>      <span style="color:#1f2328">vectorStore</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">chunkOptions</span><span style="color:#1f2328">:</span>     <span style="color:#1f2328">chunkOptions</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// ProcessFile processes a single file through the entire pipeline</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">p</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ProcessingPipeline</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">ProcessFile</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">filePath</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">error</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// 1. Load and parse the document</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">doc</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">p</span><span style="color:#1f2328">.</span><span style="color:#1f2328">processor</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ProcessFile</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">filePath</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;document processing failed: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// 2. Extract additional metadata</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">metadata</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">p</span><span style="color:#1f2328">.</span><span style="color:#1f2328">metadataExtractor</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Extract</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">doc</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Log but continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Metadata extraction error for %s: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">filePath</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Update document with enhanced metadata</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Metadata</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">metadata</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// 3. Split document into chunks</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">chunks</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">p</span><span style="color:#1f2328">.</span><span style="color:#6639ba">chunker</span><span style="color:#1f2328">(</span><span style="color:#1f2328">doc</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">p</span><span style="color:#1f2328">.</span><span style="color:#1f2328">chunkOptions</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;document chunking failed: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// 4. Process chunks in batches to avoid memory issues</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">const</span> <span style="color:#1f2328">batchSize</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span> <span style="color:#1f2328">&lt;</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">chunks</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">batchSize</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">end</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">batchSize</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">end</span> <span style="color:#1f2328">&gt;</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">chunks</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">end</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">chunks</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">batchChunks</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">chunks</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">:</span><span style="color:#1f2328">end</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Create a batch of texts for embedding</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">texts</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">make</span><span style="color:#1f2328">([]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">batchChunks</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> <span style="color:#1f2328">j</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">chunk</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">batchChunks</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">texts</span><span style="color:#1f2328">[</span><span style="color:#1f2328">j</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">chunk</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Text</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// 5. Generate embeddings</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">embeddings</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">p</span><span style="color:#1f2328">.</span><span style="color:#1f2328">embedder</span><span style="color:#1f2328">.</span><span style="color:#6639ba">EmbedBatch</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">texts</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;embedding generation failed: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// 6. Create documents for vector store</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">docs</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">make</span><span style="color:#1f2328">([]</span><span style="color:#1f2328">vectorstore</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">batchChunks</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> <span style="color:#1f2328">j</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">chunk</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">batchChunks</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// Create a unique ID for the chunk</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">chunkID</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sprintf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;%s-%d&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">chunk</span><span style="color:#1f2328">.</span><span style="color:#1f2328">DocID</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">chunk</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ChunkIndex</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">docs</span><span style="color:#1f2328">[</span><span style="color:#1f2328">j</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">vectorstore</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">ID</span><span style="color:#1f2328">:</span>        <span style="color:#1f2328">chunkID</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">Content</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">chunk</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Text</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">Metadata</span><span style="color:#1f2328">:</span>  <span style="color:#1f2328">chunk</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Metadata</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">Embedding</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">embeddings</span><span style="color:#1f2328">[</span><span style="color:#1f2328">j</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// 7. Store in vector database</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">err</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">p</span><span style="color:#1f2328">.</span><span style="color:#1f2328">vectorStore</span><span style="color:#1f2328">.</span><span style="color:#6639ba">AddDocuments</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">docs</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;vector store insertion failed: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// ProcessDirectory processes all files in a directory</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">p</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ProcessingPipeline</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">ProcessDirectory</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">dirPath</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">error</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// List files</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">files</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">listFiles</span><span style="color:#1f2328">(</span><span style="color:#1f2328">dirPath</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to list directory: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Process files with progress tracking</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">total</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">files</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">file</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">files</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Processing file %d/%d: %s&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">i</span><span style="color:#0550ae">+</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">total</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">file</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">p</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ProcessFile</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">file</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// Log but continue with other files</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Error processing %s: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">file</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This pipeline provides a complete workflow from document loading to vector storage, with each component designed to be extensible and configurable.</p>
<h3 id="real-world-optimizations-and-best-practices">Real-World Optimizations and Best Practices</h3>
<p>After implementing several production document processing pipelines, I&rsquo;ve learned some valuable lessons:</p>
<h4 id="1-progressive-document-loading">1. Progressive Document Loading</h4>
<p>For large document collections, process documents incrementally:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// IncrementalProcessor tracks processed files to avoid reprocessing</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">IncrementalProcessor</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">pipeline</span>      <span style="color:#0550ae">*</span><span style="color:#1f2328">ProcessingPipeline</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">processedDB</span>   <span style="color:#0550ae">*</span><span style="color:#1f2328">badger</span><span style="color:#1f2328">.</span><span style="color:#1f2328">DB</span> <span style="color:#57606a">// Using BadgerDB for tracking</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">forceReprocess</span> <span style="color:#cf222e">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewIncrementalProcessor</span><span style="color:#1f2328">(</span><span style="color:#1f2328">pipeline</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ProcessingPipeline</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">dbPath</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">forceReprocess</span> <span style="color:#cf222e">bool</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">IncrementalProcessor</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Open the tracking database</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">opts</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">badger</span><span style="color:#1f2328">.</span><span style="color:#6639ba">DefaultOptions</span><span style="color:#1f2328">(</span><span style="color:#1f2328">dbPath</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">db</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">badger</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Open</span><span style="color:#1f2328">(</span><span style="color:#1f2328">opts</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to open tracking database: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">IncrementalProcessor</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">pipeline</span><span style="color:#1f2328">:</span>      <span style="color:#1f2328">pipeline</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">processedDB</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">db</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">forceReprocess</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">forceReprocess</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">},</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">p</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">IncrementalProcessor</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">ProcessDirectory</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">dirPath</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">error</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">files</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">listFilesRecursively</span><span style="color:#1f2328">(</span><span style="color:#1f2328">dirPath</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Process each file if needed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">total</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">files</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">processed</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">skipped</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">file</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">files</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Check if file was already processed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">needsProcessing</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">p</span><span style="color:#1f2328">.</span><span style="color:#6639ba">needsProcessing</span><span style="color:#1f2328">(</span><span style="color:#1f2328">file</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Error checking file status: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">needsProcessing</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">p</span><span style="color:#1f2328">.</span><span style="color:#1f2328">forceReprocess</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Skipping already processed file (%d/%d): %s&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">i</span><span style="color:#0550ae">+</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">total</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">file</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">skipped</span><span style="color:#0550ae">++</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Process the file</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Processing file (%d/%d): %s&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">i</span><span style="color:#0550ae">+</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">total</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">file</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">err</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">p</span><span style="color:#1f2328">.</span><span style="color:#1f2328">pipeline</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ProcessFile</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">file</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Error processing %s: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">file</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Mark as processed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">err</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">p</span><span style="color:#1f2328">.</span><span style="color:#6639ba">markProcessed</span><span style="color:#1f2328">(</span><span style="color:#1f2328">file</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Error updating file status: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">processed</span><span style="color:#0550ae">++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Processing complete. Processed: %d, Skipped: %d, Total: %d&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">processed</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">skipped</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">total</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">p</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">IncrementalProcessor</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">needsProcessing</span><span style="color:#1f2328">(</span><span style="color:#1f2328">filePath</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">bool</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">fileInfo</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">os</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Stat</span><span style="color:#1f2328">(</span><span style="color:#1f2328">filePath</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">false</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">modTime</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">fileInfo</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ModTime</span><span style="color:#1f2328">().</span><span style="color:#6639ba">Unix</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">fileSize</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">fileInfo</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Size</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">processed</span> <span style="color:#cf222e">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">storedModTime</span> <span style="color:#cf222e">int64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">storedSize</span> <span style="color:#cf222e">int64</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">err</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">p</span><span style="color:#1f2328">.</span><span style="color:#1f2328">processedDB</span><span style="color:#1f2328">.</span><span style="color:#6639ba">View</span><span style="color:#1f2328">(</span><span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">txn</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">badger</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Txn</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">error</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">item</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">txn</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Get</span><span style="color:#1f2328">([]</span><span style="color:#6639ba">byte</span><span style="color:#1f2328">(</span><span style="color:#1f2328">filePath</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">badger</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ErrKeyNotFound</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">processed</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">processed</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">item</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Value</span><span style="color:#1f2328">(</span><span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">val</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">byte</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">error</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">parts</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Split</span><span style="color:#1f2328">(</span><span style="color:#6639ba">string</span><span style="color:#1f2328">(</span><span style="color:#1f2328">val</span><span style="color:#1f2328">),</span> <span style="color:#0a3069">&#34;:&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">parts</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">!=</span> <span style="color:#0550ae">2</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;invalid stored value format&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">storedModTime</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">strconv</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ParseInt</span><span style="color:#1f2328">(</span><span style="color:#1f2328">parts</span><span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">],</span> <span style="color:#0550ae">10</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">64</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">storedSize</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">strconv</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ParseInt</span><span style="color:#1f2328">(</span><span style="color:#1f2328">parts</span><span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">],</span> <span style="color:#0550ae">10</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">64</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">false</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// File needs processing if:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// 1. It hasn&#39;t been processed before</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// 2. It has been modified since last processing</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// 3. Its size has changed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">processed</span> <span style="color:#0550ae">||</span> <span style="color:#1f2328">storedModTime</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">modTime</span> <span style="color:#0550ae">||</span> <span style="color:#1f2328">storedSize</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">fileSize</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">p</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">IncrementalProcessor</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">markProcessed</span><span style="color:#1f2328">(</span><span style="color:#1f2328">filePath</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">error</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">fileInfo</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">os</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Stat</span><span style="color:#1f2328">(</span><span style="color:#1f2328">filePath</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">modTime</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">fileInfo</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ModTime</span><span style="color:#1f2328">().</span><span style="color:#6639ba">Unix</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">fileSize</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">fileInfo</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Size</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">value</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sprintf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;%d:%d&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">modTime</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fileSize</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">p</span><span style="color:#1f2328">.</span><span style="color:#1f2328">processedDB</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Update</span><span style="color:#1f2328">(</span><span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">txn</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">badger</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Txn</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">error</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">txn</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Set</span><span style="color:#1f2328">([]</span><span style="color:#6639ba">byte</span><span style="color:#1f2328">(</span><span style="color:#1f2328">filePath</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">[]</span><span style="color:#6639ba">byte</span><span style="color:#1f2328">(</span><span style="color:#1f2328">value</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This approach lets you process new or modified documents without reprocessing your entire corpus, which is critical for large collections.</p>
<h4 id="2-parallel-processing">2. Parallel Processing</h4>
<p>Leverage Go&rsquo;s concurrency to speed up processing:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// ParallelProcessor processes documents in parallel</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">ParallelProcessor</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">pipeline</span>  <span style="color:#0550ae">*</span><span style="color:#1f2328">ProcessingPipeline</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">maxWorkers</span> <span style="color:#cf222e">int</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewParallelProcessor</span><span style="color:#1f2328">(</span><span style="color:#1f2328">pipeline</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ProcessingPipeline</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">maxWorkers</span> <span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ParallelProcessor</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">maxWorkers</span> <span style="color:#0550ae">&lt;=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">maxWorkers</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">runtime</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NumCPU</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">ParallelProcessor</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">pipeline</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">pipeline</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">maxWorkers</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">maxWorkers</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">p</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ParallelProcessor</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">ProcessDirectory</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">dirPath</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">error</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">files</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">listFilesRecursively</span><span style="color:#1f2328">(</span><span style="color:#1f2328">dirPath</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Create a worker pool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">wg</span> <span style="color:#1f2328">sync</span><span style="color:#1f2328">.</span><span style="color:#1f2328">WaitGroup</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">fileChan</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">make</span><span style="color:#1f2328">(</span><span style="color:#cf222e">chan</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">errorsChan</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">make</span><span style="color:#1f2328">(</span><span style="color:#cf222e">chan</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">files</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Start workers</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span> <span style="color:#1f2328">&lt;</span> <span style="color:#1f2328">p</span><span style="color:#1f2328">.</span><span style="color:#1f2328">maxWorkers</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span><span style="color:#0550ae">++</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">wg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Add</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">go</span> <span style="color:#cf222e">func</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">defer</span> <span style="color:#1f2328">wg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Done</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> <span style="color:#1f2328">filePath</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">fileChan</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">p</span><span style="color:#1f2328">.</span><span style="color:#1f2328">pipeline</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ProcessFile</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">filePath</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">select</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">case</span> <span style="color:#1f2328">errorsChan</span> <span style="color:#0550ae">&lt;-</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;error processing %s: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">filePath</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">default</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Error processing %s: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">filePath</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Send files to workers</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">file</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">files</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">select</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">case</span> <span style="color:#1f2328">fileChan</span> <span style="color:#0550ae">&lt;-</span> <span style="color:#1f2328">file</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">case</span> <span style="color:#0550ae">&lt;-</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Done</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">close</span><span style="color:#1f2328">(</span><span style="color:#1f2328">fileChan</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">ctx</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Err</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Close the channel and wait for workers to finish</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">close</span><span style="color:#1f2328">(</span><span style="color:#1f2328">fileChan</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">wg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Wait</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">close</span><span style="color:#1f2328">(</span><span style="color:#1f2328">errorsChan</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Collect errors</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">errs</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">errorsChan</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">errs</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">errs</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">errs</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;encountered %d errors during processing&#34;</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">errs</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>The parallel approach can dramatically speed up processing, especially for IO-bound operations like loading documents and generating embeddings.</p>
<h4 id="3-document-deduplication">3. Document Deduplication</h4>
<p>Prevent duplicate content from cluttering your vector database:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Deduplicator removes duplicate or near-duplicate content</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Deduplicator</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">minSimilarity</span> <span style="color:#cf222e">float32</span>  <span style="color:#57606a">// Threshold for considering chunks similar</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">vectorStore</span>   <span style="color:#1f2328">vectorstore</span><span style="color:#1f2328">.</span><span style="color:#1f2328">VectorStore</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewDeduplicator</span><span style="color:#1f2328">(</span><span style="color:#1f2328">minSimilarity</span> <span style="color:#cf222e">float32</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">vectorStore</span> <span style="color:#1f2328">vectorstore</span><span style="color:#1f2328">.</span><span style="color:#1f2328">VectorStore</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Deduplicator</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">Deduplicator</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">minSimilarity</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">minSimilarity</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">vectorStore</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">vectorStore</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Check if a document chunk is too similar to existing chunks</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">d</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Deduplicator</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">IsDuplicate</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">text</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">embedding</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">float32</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">bool</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Search for similar chunks</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">results</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">d</span><span style="color:#1f2328">.</span><span style="color:#1f2328">vectorStore</span><span style="color:#1f2328">.</span><span style="color:#6639ba">SimilaritySearch</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">embedding</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">false</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;similarity search failed: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// If we found a result with similarity above threshold, it&#39;s a duplicate</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">results</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#6639ba">cosineSimilarity</span><span style="color:#1f2328">(</span><span style="color:#1f2328">embedding</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">results</span><span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">].</span><span style="color:#1f2328">Embedding</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#1f2328">d</span><span style="color:#1f2328">.</span><span style="color:#1f2328">minSimilarity</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">true</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">false</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Helper function to calculate cosine similarity</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">cosineSimilarity</span><span style="color:#1f2328">(</span><span style="color:#1f2328">a</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">b</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">float32</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">float32</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">dotProduct</span> <span style="color:#cf222e">float32</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">normA</span> <span style="color:#cf222e">float32</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">normB</span> <span style="color:#cf222e">float32</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span> <span style="color:#1f2328">&lt;</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">a</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">i</span><span style="color:#0550ae">++</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">dotProduct</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">a</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">*</span> <span style="color:#1f2328">b</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">normA</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">a</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">*</span> <span style="color:#1f2328">a</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">normB</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">b</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">*</span> <span style="color:#1f2328">b</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">dotProduct</span> <span style="color:#0550ae">/</span> <span style="color:#1f2328">(</span><span style="color:#6639ba">float32</span><span style="color:#1f2328">(</span><span style="color:#1f2328">math</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sqrt</span><span style="color:#1f2328">(</span><span style="color:#6639ba">float64</span><span style="color:#1f2328">(</span><span style="color:#1f2328">normA</span><span style="color:#1f2328">)))</span> <span style="color:#0550ae">*</span> <span style="color:#6639ba">float32</span><span style="color:#1f2328">(</span><span style="color:#1f2328">math</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sqrt</span><span style="color:#1f2328">(</span><span style="color:#6639ba">float64</span><span style="color:#1f2328">(</span><span style="color:#1f2328">normB</span><span style="color:#1f2328">))))</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>Deduplication is particularly important for enterprise document collections where the same content often appears in multiple documents.</p>
<p>The document processing pipeline is the foundation of your RAG system. Getting it right—with proper document loading, intelligent chunking, rich metadata extraction, and efficient processing—sets you up for success in the subsequent steps.</p>
<h2 id="building-the-search-api-with-go">Building the Search API with Go</h2>
<p>With our documents processed and stored, it&rsquo;s time to build the interface that users will actually interact with: the search API. This is where all our careful work on document processing, embedding generation, and vector storage comes together to deliver a seamless, intuitive search experience.</p>
<p>I&rsquo;ve worked on search APIs that were technically powerful but practically useless – like a high-performance sports car with no steering wheel. A good search API isn&rsquo;t just about returning results; it&rsquo;s about presenting them in a way that helps users solve problems. It&rsquo;s about thoughtful defaults and flexible options. It&rsquo;s about balancing simplicity for common use cases with power for complex ones.</p>
<p>Let&rsquo;s build an API that you&rsquo;d actually want to use.</p>
<h3 id="api-design-and-endpoints">API Design and Endpoints</h3>
<p>Our API design starts with clarity about what users need. Based on my experience with RAG systems across various domains, users typically need to:</p>
<ol>
<li>Search for information using natural language</li>
<li>Filter results based on metadata</li>
<li>Adjust search parameters for precision vs. recall</li>
<li>Retrieve both content and context for results</li>
</ol>
<p>Let&rsquo;s design a clean, RESTful API around these needs:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">package</span> <span style="color:#1f2328">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;encoding/json&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;strconv&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;github.com/gorilla/mux&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// SearchRequest represents the search query parameters</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">SearchRequest</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Query</span>       <span style="color:#cf222e">string</span>                 <span style="color:#0a3069">`json:&#34;query&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Filters</span>     <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span> <span style="color:#0a3069">`json:&#34;filters,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Limit</span>       <span style="color:#cf222e">int</span>                    <span style="color:#0a3069">`json:&#34;limit,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Similarity</span>  <span style="color:#cf222e">float32</span>                <span style="color:#0a3069">`json:&#34;similarity,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">IncludeText</span> <span style="color:#cf222e">bool</span>                   <span style="color:#0a3069">`json:&#34;includeText,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// SearchResult represents a single search result</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">SearchResult</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ID</span>         <span style="color:#cf222e">string</span>                 <span style="color:#0a3069">`json:&#34;id&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Content</span>    <span style="color:#cf222e">string</span>                 <span style="color:#0a3069">`json:&#34;content,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Metadata</span>   <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span> <span style="color:#0a3069">`json:&#34;metadata&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Score</span>      <span style="color:#cf222e">float32</span>                <span style="color:#0a3069">`json:&#34;score&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">SourceFile</span> <span style="color:#cf222e">string</span>                 <span style="color:#0a3069">`json:&#34;sourceFile&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// SearchResponse represents the overall search response</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">SearchResponse</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Results</span>     <span style="color:#1f2328">[]</span><span style="color:#1f2328">SearchResult</span> <span style="color:#0a3069">`json:&#34;results&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">TotalCount</span>  <span style="color:#cf222e">int</span>            <span style="color:#0a3069">`json:&#34;totalCount&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ProcessedIn</span> <span style="color:#cf222e">int64</span>          <span style="color:#0a3069">`json:&#34;processedIn&#34;`</span> <span style="color:#57606a">// time in milliseconds</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Server encapsulates the HTTP server and its dependencies</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Server</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">router</span>      <span style="color:#0550ae">*</span><span style="color:#1f2328">mux</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Router</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">searchSvc</span>   <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchService</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">port</span>        <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// NewServer creates a new server with the given search service</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewServer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">searchSvc</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchService</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">port</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Server</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">s</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">Server</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">router</span><span style="color:#1f2328">:</span>    <span style="color:#1f2328">mux</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewRouter</span><span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">searchSvc</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">searchSvc</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">port</span><span style="color:#1f2328">:</span>      <span style="color:#1f2328">port</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#6639ba">setupRoutes</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">s</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// setupRoutes configures the API endpoints</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Server</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">setupRoutes</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Health check endpoint</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">router</span><span style="color:#1f2328">.</span><span style="color:#6639ba">HandleFunc</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;/health&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">handleHealth</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Methods</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;GET&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Search endpoints</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">router</span><span style="color:#1f2328">.</span><span style="color:#6639ba">HandleFunc</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;/search&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">handleSearch</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Methods</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;POST&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">router</span><span style="color:#1f2328">.</span><span style="color:#6639ba">HandleFunc</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;/search/quick&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">handleQuickSearch</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Methods</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;GET&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Document info endpoint</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">router</span><span style="color:#1f2328">.</span><span style="color:#6639ba">HandleFunc</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;/documents/{id}&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">handleGetDocument</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Methods</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;GET&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Start begins listening for requests</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Server</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Start</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">error</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Starting server on port %s&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">port</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ListenAndServe</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;:&#34;</span><span style="color:#0550ae">+</span><span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">port</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">router</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// handleHealth responds to health check requests</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Server</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">handleHealth</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ResponseWriter</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">r</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Request</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Header</span><span style="color:#1f2328">().</span><span style="color:#6639ba">Set</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Content-Type&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;application/json&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewEncoder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Encode</span><span style="color:#1f2328">(</span><span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;status&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ok&#34;</span><span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// handleSearch processes full search requests</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Server</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">handleSearch</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ResponseWriter</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">r</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Request</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">req</span> <span style="color:#1f2328">SearchRequest</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Decode the request body</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewDecoder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Body</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Decode</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">req</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Error</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Invalid request body&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusBadRequest</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Validate the request</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Query</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Error</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Query is required&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusBadRequest</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Apply defaults if not specified</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Limit</span> <span style="color:#0550ae">&lt;=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Limit</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Perform the search</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">results</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">searchSvc</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Search</span><span style="color:#1f2328">(</span><span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Context</span><span style="color:#1f2328">(),</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Search error: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Error</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Search failed&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusInternalServerError</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Return the results</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Header</span><span style="color:#1f2328">().</span><span style="color:#6639ba">Set</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Content-Type&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;application/json&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewEncoder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Encode</span><span style="color:#1f2328">(</span><span style="color:#1f2328">results</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// handleQuickSearch provides a simpler GET endpoint for basic searches</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Server</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">handleQuickSearch</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ResponseWriter</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">r</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Request</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Extract query from URL parameter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">query</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#1f2328">URL</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Query</span><span style="color:#1f2328">().</span><span style="color:#6639ba">Get</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;q&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">query</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Error</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Query parameter &#39;q&#39; is required&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusBadRequest</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Parse optional parameters</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">limit</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">_</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">strconv</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Atoi</span><span style="color:#1f2328">(</span><span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#1f2328">URL</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Query</span><span style="color:#1f2328">().</span><span style="color:#6639ba">Get</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;limit&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">includeText</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#1f2328">URL</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Query</span><span style="color:#1f2328">().</span><span style="color:#6639ba">Get</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;include_text&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Create a search request</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">req</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">SearchRequest</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Query</span><span style="color:#1f2328">:</span>       <span style="color:#1f2328">query</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Limit</span><span style="color:#1f2328">:</span>       <span style="color:#1f2328">limit</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">IncludeText</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">includeText</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Apply defaults if needed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Limit</span> <span style="color:#0550ae">&lt;=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Limit</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">5</span> <span style="color:#57606a">// Lower default for quick search</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Perform the search</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">results</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">searchSvc</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Search</span><span style="color:#1f2328">(</span><span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Context</span><span style="color:#1f2328">(),</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Quick search error: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Error</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Search failed&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusInternalServerError</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Return the results</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Header</span><span style="color:#1f2328">().</span><span style="color:#6639ba">Set</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Content-Type&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;application/json&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewEncoder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Encode</span><span style="color:#1f2328">(</span><span style="color:#1f2328">results</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// handleGetDocument retrieves a specific document by ID</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">Server</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">handleGetDocument</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ResponseWriter</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">r</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Request</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Extract document ID from path</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">vars</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">mux</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Vars</span><span style="color:#1f2328">(</span><span style="color:#1f2328">r</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">id</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">vars</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;id&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Retrieve the document</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">doc</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">searchSvc</span><span style="color:#1f2328">.</span><span style="color:#6639ba">GetDocument</span><span style="color:#1f2328">(</span><span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Context</span><span style="color:#1f2328">(),</span> <span style="color:#1f2328">id</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Document retrieval error: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Error</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Document not found&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusNotFound</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Return the document</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Header</span><span style="color:#1f2328">().</span><span style="color:#6639ba">Set</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Content-Type&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;application/json&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewEncoder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Encode</span><span style="color:#1f2328">(</span><span style="color:#1f2328">doc</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">main</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Initialize dependencies</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// (In a real app, these would be properly configured)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">embedder</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">initEmbedder</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">vectorStore</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">initVectorStore</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">searchSvc</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">NewSearchService</span><span style="color:#1f2328">(</span><span style="color:#1f2328">embedder</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">vectorStore</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Create and start the server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">port</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">os</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Getenv</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;PORT&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">port</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">port</span> <span style="color:#1f2328">=</span> <span style="color:#0a3069">&#34;8080&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">server</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">NewServer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">searchSvc</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">port</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Fatal</span><span style="color:#1f2328">(</span><span style="color:#1f2328">server</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Start</span><span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This API design offers:</p>
<ol>
<li>A detailed search endpoint (<code>/search</code>) that accepts JSON for complex queries</li>
<li>A simpler GET endpoint (<code>/search/quick</code>) for basic searches</li>
<li>A document retrieval endpoint (<code>/documents/{id}</code>) for fetching specific documents</li>
<li>A health check endpoint (<code>/health</code>) for monitoring</li>
</ol>
<p>It&rsquo;s RESTful, intuitive, and supports both simple and complex use cases.</p>
<h3 id="query-processing-and-vector-generation">Query Processing and Vector Generation</h3>
<p>The heart of our search API is the <code>SearchService</code> that processes queries and interacts with our vector store:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// SearchService handles the business logic for search operations</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">SearchService</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">embedder</span>    <span style="color:#1f2328">embedding</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Embedder</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">vectorStore</span> <span style="color:#1f2328">vectorstore</span><span style="color:#1f2328">.</span><span style="color:#1f2328">VectorStore</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// NewSearchService creates a new search service</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewSearchService</span><span style="color:#1f2328">(</span><span style="color:#1f2328">embedder</span> <span style="color:#1f2328">embedding</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Embedder</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">vectorStore</span> <span style="color:#1f2328">vectorstore</span><span style="color:#1f2328">.</span><span style="color:#1f2328">VectorStore</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchService</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">SearchService</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">embedder</span><span style="color:#1f2328">:</span>    <span style="color:#1f2328">embedder</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">vectorStore</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">vectorStore</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Search performs a search operation</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchService</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Search</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span> <span style="color:#1f2328">SearchRequest</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">SearchResponse</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">startTime</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Now</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Generate embedding for the query</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">queryEmbedding</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">embedder</span><span style="color:#1f2328">.</span><span style="color:#6639ba">EmbedText</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Query</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to generate embedding: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Prepare search options</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">searchOpts</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">vectorstore</span><span style="color:#1f2328">.</span><span style="color:#1f2328">SearchOptions</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Limit</span><span style="color:#1f2328">:</span>      <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Limit</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Filters</span><span style="color:#1f2328">:</span>    <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Filters</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">MinScore</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Similarity</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Perform vector search</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">docs</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">vectorStore</span><span style="color:#1f2328">.</span><span style="color:#6639ba">SimilaritySearchWithOptions</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">queryEmbedding</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">searchOpts</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;vector search failed: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Transform to API response format</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">results</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">make</span><span style="color:#1f2328">([]</span><span style="color:#1f2328">SearchResult</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">docs</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">doc</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">docs</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">result</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">SearchResult</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">ID</span><span style="color:#1f2328">:</span>         <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ID</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Metadata</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Metadata</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Score</span><span style="color:#1f2328">:</span>      <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Score</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Include source file from metadata</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">source</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ok</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;source&#34;</span><span style="color:#1f2328">].(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">ok</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">SourceFile</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">source</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Include text content if requested</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">IncludeText</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Content</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Content</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">results</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">result</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Calculate processing time</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">processingTime</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Since</span><span style="color:#1f2328">(</span><span style="color:#1f2328">startTime</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Milliseconds</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">SearchResponse</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Results</span><span style="color:#1f2328">:</span>     <span style="color:#1f2328">results</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">TotalCount</span><span style="color:#1f2328">:</span>  <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">results</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">ProcessedIn</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">processingTime</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">},</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// GetDocument retrieves a document by ID</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchService</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">GetDocument</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">id</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">SearchResult</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">doc</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">vectorStore</span><span style="color:#1f2328">.</span><span style="color:#6639ba">GetDocument</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">id</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">result</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">SearchResult</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">ID</span><span style="color:#1f2328">:</span>       <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ID</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Content</span><span style="color:#1f2328">:</span>  <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Content</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Metadata</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Metadata</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">source</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ok</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;source&#34;</span><span style="color:#1f2328">].(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">ok</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">SourceFile</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">source</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">result</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This service handles the critical tasks of:</p>
<ol>
<li>Converting the query to an embedding using our embedding model</li>
<li>Performing the similarity search in our vector database</li>
<li>Transforming the results into a consistent, useful format</li>
</ol>
<p>Let&rsquo;s extend the vector store interface to support more advanced search options:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// SearchOptions provides parameters for fine-tuning the search</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">SearchOptions</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Limit</span>      <span style="color:#cf222e">int</span>                    <span style="color:#57606a">// Maximum number of results to return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Filters</span>    <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span> <span style="color:#57606a">// Metadata filters to apply</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">MinScore</span>   <span style="color:#cf222e">float32</span>                <span style="color:#57606a">// Minimum similarity score threshold</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Extended VectorStore interface</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">VectorStore</span> <span style="color:#cf222e">interface</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Basic operations</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">AddDocuments</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">docs</span> <span style="color:#1f2328">[]</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">DeleteDocument</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">id</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">error</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Basic similarity search</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">SimilaritySearch</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">queryVector</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">float32</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">limit</span> <span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([]</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Advanced similarity search with filtering</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">SimilaritySearchWithOptions</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">queryVector</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">float32</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">options</span> <span style="color:#1f2328">SearchOptions</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([]</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Document retrieval by ID</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">GetDocument</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">id</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This interface design supports both simple searches for quick prototyping and advanced searches with filtering for production use.</p>
<h3 id="similarity-search-implementation">Similarity Search Implementation</h3>
<p>Let&rsquo;s implement the <code>SimilaritySearchWithOptions</code> method for our Weaviate vector store:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Document with similarity score</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Document</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ID</span>        <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Content</span>   <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Metadata</span>  <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Embedding</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">float32</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Score</span>     <span style="color:#cf222e">float32</span>  <span style="color:#57606a">// Similarity score, only populated in search results</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// WeaviateStore implementation of SimilaritySearchWithOptions</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">WeaviateStore</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">SimilaritySearchWithOptions</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">queryVector</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">float32</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">options</span> <span style="color:#1f2328">SearchOptions</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([]</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Prepare the query</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">limit</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">options</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Limit</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">limit</span> <span style="color:#0550ae">&lt;=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">limit</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">10</span> <span style="color:#57606a">// Default limit</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Build GraphQL query</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">nearVector</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">client</span><span style="color:#1f2328">.</span><span style="color:#1f2328">NearVectorArgBuilder</span><span style="color:#1f2328">{}.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">WithVector</span><span style="color:#1f2328">(</span><span style="color:#1f2328">queryVector</span><span style="color:#1f2328">).</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">WithDistance</span><span style="color:#1f2328">(</span><span style="color:#1f2328">options</span><span style="color:#1f2328">.</span><span style="color:#1f2328">MinScore</span><span style="color:#1f2328">).</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">WithCertainty</span><span style="color:#1f2328">(</span><span style="color:#1f2328">options</span><span style="color:#1f2328">.</span><span style="color:#1f2328">MinScore</span><span style="color:#1f2328">)</span> <span style="color:#57606a">// Weaviate can use either distance or certainty</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Build metadata filters</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">where</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">filters</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Where</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">options</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Filters</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">where</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">buildWeaviateFilters</span><span style="color:#1f2328">(</span><span style="color:#1f2328">options</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Filters</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Execute the query</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">result</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">client</span><span style="color:#1f2328">.</span><span style="color:#6639ba">GraphQL</span><span style="color:#1f2328">().</span><span style="color:#6639ba">Get</span><span style="color:#1f2328">().</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">WithClassName</span><span style="color:#1f2328">(</span><span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">className</span><span style="color:#1f2328">).</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">WithNearVector</span><span style="color:#1f2328">(</span><span style="color:#1f2328">nearVector</span><span style="color:#1f2328">).</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">WithFields</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;_additional { id distance certainty } content metadata&#34;</span><span style="color:#1f2328">).</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">WithLimit</span><span style="color:#1f2328">(</span><span style="color:#1f2328">limit</span><span style="color:#1f2328">).</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">WithWhere</span><span style="color:#1f2328">(</span><span style="color:#1f2328">where</span><span style="color:#1f2328">).</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">Do</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;weaviate query failed: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Process results</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">docs</span> <span style="color:#1f2328">[]</span><span style="color:#1f2328">Document</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Extract results from GraphQL response</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">searchResults</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Data</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;Get&#34;</span><span style="color:#1f2328">].(</span><span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{})[</span><span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">className</span><span style="color:#1f2328">].([]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">res</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">searchResults</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">item</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">res</span><span style="color:#1f2328">.(</span><span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">additional</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">item</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;_additional&#34;</span><span style="color:#1f2328">].(</span><span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Convert certainty to score (0-1 range)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">var</span> <span style="color:#1f2328">score</span> <span style="color:#cf222e">float32</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">cert</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ok</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">additional</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;certainty&#34;</span><span style="color:#1f2328">].(</span><span style="color:#cf222e">float64</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">ok</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">score</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">float32</span><span style="color:#1f2328">(</span><span style="color:#1f2328">cert</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Extract metadata</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">metadataMap</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">make</span><span style="color:#1f2328">(</span><span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">metaRaw</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ok</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">item</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;metadata&#34;</span><span style="color:#1f2328">].(</span><span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{});</span> <span style="color:#1f2328">ok</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">metadataMap</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">metaRaw</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">doc</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">Document</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">ID</span><span style="color:#1f2328">:</span>       <span style="color:#1f2328">additional</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;id&#34;</span><span style="color:#1f2328">].(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Content</span><span style="color:#1f2328">:</span>  <span style="color:#1f2328">item</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;content&#34;</span><span style="color:#1f2328">].(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Metadata</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">metadataMap</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Score</span><span style="color:#1f2328">:</span>    <span style="color:#1f2328">score</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">docs</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">docs</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">doc</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">docs</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Helper to build Weaviate filters from generic map</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">buildWeaviateFilters</span><span style="color:#1f2328">(</span><span style="color:#1f2328">filters</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">filters</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Where</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">where</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">filters</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Where</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">key</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">value</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">filters</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">switch</span> <span style="color:#1f2328">v</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">value</span><span style="color:#1f2328">.(</span><span style="color:#cf222e">type</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">case</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">where</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">where</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WithPath</span><span style="color:#1f2328">([]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">{</span><span style="color:#1f2328">key</span><span style="color:#1f2328">}).</span><span style="color:#6639ba">WithOperator</span><span style="color:#1f2328">(</span><span style="color:#1f2328">filters</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Equal</span><span style="color:#1f2328">).</span><span style="color:#6639ba">WithValueString</span><span style="color:#1f2328">(</span><span style="color:#1f2328">v</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">case</span> <span style="color:#cf222e">int</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">where</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">where</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WithPath</span><span style="color:#1f2328">([]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">{</span><span style="color:#1f2328">key</span><span style="color:#1f2328">}).</span><span style="color:#6639ba">WithOperator</span><span style="color:#1f2328">(</span><span style="color:#1f2328">filters</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Equal</span><span style="color:#1f2328">).</span><span style="color:#6639ba">WithValueInt</span><span style="color:#1f2328">(</span><span style="color:#1f2328">v</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">case</span> <span style="color:#cf222e">float64</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">where</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">where</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WithPath</span><span style="color:#1f2328">([]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">{</span><span style="color:#1f2328">key</span><span style="color:#1f2328">}).</span><span style="color:#6639ba">WithOperator</span><span style="color:#1f2328">(</span><span style="color:#1f2328">filters</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Equal</span><span style="color:#1f2328">).</span><span style="color:#6639ba">WithValueNumber</span><span style="color:#1f2328">(</span><span style="color:#1f2328">v</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">case</span> <span style="color:#cf222e">bool</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">where</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">where</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WithPath</span><span style="color:#1f2328">([]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">{</span><span style="color:#1f2328">key</span><span style="color:#1f2328">}).</span><span style="color:#6639ba">WithOperator</span><span style="color:#1f2328">(</span><span style="color:#1f2328">filters</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Equal</span><span style="color:#1f2328">).</span><span style="color:#6639ba">WithValueBoolean</span><span style="color:#1f2328">(</span><span style="color:#1f2328">v</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">case</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">where</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">where</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WithPath</span><span style="color:#1f2328">([]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">{</span><span style="color:#1f2328">key</span><span style="color:#1f2328">}).</span><span style="color:#6639ba">WithOperator</span><span style="color:#1f2328">(</span><span style="color:#1f2328">filters</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ContainsAny</span><span style="color:#1f2328">).</span><span style="color:#6639ba">WithValueText</span><span style="color:#1f2328">(</span><span style="color:#1f2328">v</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Add more cases as needed for different filter types</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">where</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This implementation handles the critical aspects of vector similarity search in Weaviate, including:</p>
<ol>
<li>Converting our generic search options to Weaviate-specific query parameters</li>
<li>Building metadata filters dynamically based on user requirements</li>
<li>Processing the GraphQL results into a consistent document format</li>
</ol>
<h3 id="result-ranking-and-filtering">Result Ranking and Filtering</h3>
<p>Similarity scores are just one aspect of result ranking. Let&rsquo;s enhance our search service with more sophisticated ranking logic:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// RankingOptions controls how results are scored and ranked</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">RankingOptions</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">RecencyBoost</span>   <span style="color:#cf222e">bool</span>    <span style="color:#57606a">// Boost more recent documents</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">LengthPenalty</span>  <span style="color:#cf222e">bool</span>    <span style="color:#57606a">// Penalize overly short chunks</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">TitleBoost</span>     <span style="color:#cf222e">float32</span> <span style="color:#57606a">// Boost when title matches query</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">HybridSearch</span>   <span style="color:#cf222e">bool</span>    <span style="color:#57606a">// Combine vector search with keyword matching</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Enhanced search method with ranking options</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchService</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">SearchWithRanking</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">req</span> <span style="color:#1f2328">SearchRequest</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">rankOpts</span> <span style="color:#1f2328">RankingOptions</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">SearchResponse</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">startTime</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Now</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Perform basic vector search</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">searchOpts</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">vectorstore</span><span style="color:#1f2328">.</span><span style="color:#1f2328">SearchOptions</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Limit</span><span style="color:#1f2328">:</span>    <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Limit</span> <span style="color:#0550ae">*</span> <span style="color:#0550ae">2</span><span style="color:#1f2328">,</span> <span style="color:#57606a">// Fetch more results than needed for re-ranking</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Filters</span><span style="color:#1f2328">:</span>  <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Filters</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">MinScore</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Similarity</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Generate embedding for the query</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">queryEmbedding</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">embedder</span><span style="color:#1f2328">.</span><span style="color:#6639ba">EmbedText</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Query</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to generate embedding: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Perform vector search</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">docs</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">vectorStore</span><span style="color:#1f2328">.</span><span style="color:#6639ba">SimilaritySearchWithOptions</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">queryEmbedding</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">searchOpts</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;vector search failed: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Apply additional ranking factors</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">rankedDocs</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#6639ba">rankResults</span><span style="color:#1f2328">(</span><span style="color:#1f2328">docs</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Query</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">rankOpts</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Limit to requested number after re-ranking</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">rankedDocs</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Limit</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">rankedDocs</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">rankedDocs</span><span style="color:#1f2328">[:</span><span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Limit</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Transform to API response format</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">results</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">make</span><span style="color:#1f2328">([]</span><span style="color:#1f2328">SearchResult</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">rankedDocs</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">doc</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">rankedDocs</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">results</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">SearchResult</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">ID</span><span style="color:#1f2328">:</span>         <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ID</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Metadata</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Metadata</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Score</span><span style="color:#1f2328">:</span>      <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Score</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">SourceFile</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">getSourceFile</span><span style="color:#1f2328">(</span><span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Metadata</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">IncludeText</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">results</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">].</span><span style="color:#1f2328">Content</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">doc</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Content</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">processingTime</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Since</span><span style="color:#1f2328">(</span><span style="color:#1f2328">startTime</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Milliseconds</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">SearchResponse</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Results</span><span style="color:#1f2328">:</span>     <span style="color:#1f2328">results</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">TotalCount</span><span style="color:#1f2328">:</span>  <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">results</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">ProcessedIn</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">processingTime</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">},</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// rankResults applies additional ranking factors to search results</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchService</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">rankResults</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">docs</span> <span style="color:#1f2328">[]</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">query</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">opts</span> <span style="color:#1f2328">RankingOptions</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span> <span style="color:#1f2328">[]</span><span style="color:#1f2328">Document</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Create a copy we can modify</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">results</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">make</span><span style="color:#1f2328">([]</span><span style="color:#1f2328">Document</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">docs</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">copy</span><span style="color:#1f2328">(</span><span style="color:#1f2328">results</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">docs</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Get current time for recency calculations</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">now</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Now</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Apply ranking adjustments</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">results</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Start with original similarity score</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">score</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">results</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">].</span><span style="color:#1f2328">Score</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Apply recency boost if enabled</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">opts</span><span style="color:#1f2328">.</span><span style="color:#1f2328">RecencyBoost</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">timestamp</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ok</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">results</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">].</span><span style="color:#1f2328">Metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;timestamp&#34;</span><span style="color:#1f2328">].(</span><span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Time</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">ok</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a">// Calculate age in days</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">age</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">now</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sub</span><span style="color:#1f2328">(</span><span style="color:#1f2328">timestamp</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Hours</span><span style="color:#1f2328">()</span> <span style="color:#0550ae">/</span> <span style="color:#0550ae">24</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a">// Apply logarithmic decay based on age</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#1f2328">age</span> <span style="color:#1f2328">&lt;</span> <span style="color:#0550ae">365</span> <span style="color:#1f2328">{</span> <span style="color:#57606a">// Only boost content less than a year old</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">recencyBoost</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">float32</span><span style="color:#1f2328">(</span><span style="color:#0550ae">0.1</span> <span style="color:#0550ae">*</span> <span style="color:#1f2328">math</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Exp</span><span style="color:#1f2328">(</span><span style="color:#0550ae">-</span><span style="color:#1f2328">age</span><span style="color:#0550ae">/</span><span style="color:#0550ae">90</span><span style="color:#1f2328">))</span> <span style="color:#57606a">// 90-day half-life</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">score</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">recencyBoost</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Apply length penalty if enabled</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">opts</span><span style="color:#1f2328">.</span><span style="color:#1f2328">LengthPenalty</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">contentLength</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">results</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">].</span><span style="color:#1f2328">Content</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">contentLength</span> <span style="color:#1f2328">&lt;</span> <span style="color:#0550ae">100</span> <span style="color:#1f2328">{</span> <span style="color:#57606a">// Penalize very short chunks</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">score</span> <span style="color:#0550ae">-=</span> <span style="color:#6639ba">float32</span><span style="color:#1f2328">(</span><span style="color:#0550ae">0.05</span> <span style="color:#0550ae">*</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">1</span> <span style="color:#0550ae">-</span> <span style="color:#1f2328">(</span><span style="color:#6639ba">float64</span><span style="color:#1f2328">(</span><span style="color:#1f2328">contentLength</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">/</span> <span style="color:#0550ae">100</span><span style="color:#1f2328">)))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Apply title boost if enabled</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">opts</span><span style="color:#1f2328">.</span><span style="color:#1f2328">TitleBoost</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">title</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ok</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">results</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">].</span><span style="color:#1f2328">Metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;title&#34;</span><span style="color:#1f2328">].(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">ok</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a">// Simple string matching for title boost</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Contains</span><span style="color:#1f2328">(</span><span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ToLower</span><span style="color:#1f2328">(</span><span style="color:#1f2328">title</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ToLower</span><span style="color:#1f2328">(</span><span style="color:#1f2328">query</span><span style="color:#1f2328">))</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">score</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">opts</span><span style="color:#1f2328">.</span><span style="color:#1f2328">TitleBoost</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Store adjusted score</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">results</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">].</span><span style="color:#1f2328">Score</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">score</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Sort by adjusted score</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">sort</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Slice</span><span style="color:#1f2328">(</span><span style="color:#1f2328">results</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">i</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">j</span> <span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">results</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">].</span><span style="color:#1f2328">Score</span> <span style="color:#1f2328">&gt;</span> <span style="color:#1f2328">results</span><span style="color:#1f2328">[</span><span style="color:#1f2328">j</span><span style="color:#1f2328">].</span><span style="color:#1f2328">Score</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">results</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">getSourceFile</span><span style="color:#1f2328">(</span><span style="color:#1f2328">metadata</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#cf222e">string</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">source</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ok</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;source&#34;</span><span style="color:#1f2328">].(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">ok</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">source</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This enhanced ranking system allows for more nuanced result ordering based on factors beyond simple vector similarity, like:</p>
<ol>
<li>Document recency (favoring newer documents)</li>
<li>Content length (avoiding overly short snippets)</li>
<li>Title matches (boosting documents with relevant titles)</li>
</ol>
<p>You could extend this further with domain-specific ranking factors relevant to your use case.</p>
<h3 id="handling-edge-cases">Handling Edge Cases</h3>
<p>A robust search API needs to gracefully handle various edge cases:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Enhanced search method with edge case handling</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchService</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">SearchWithErrorHandling</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">req</span> <span style="color:#1f2328">SearchRequest</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">SearchResponse</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Validate query length</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Query</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">1000</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ErrQueryTooLong</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Handle empty query with special logic</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#6639ba">TrimSpace</span><span style="color:#1f2328">(</span><span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Query</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#6639ba">handleEmptyQuery</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Set timeout for search operations</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">timeoutCtx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">cancel</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WithTimeout</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">5</span><span style="color:#0550ae">*</span><span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Second</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">defer</span> <span style="color:#6639ba">cancel</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Attempt vector search</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">results</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Search</span><span style="color:#1f2328">(</span><span style="color:#1f2328">timeoutCtx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Handle specific error cases</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">errors</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Is</span><span style="color:#1f2328">(</span><span style="color:#1f2328">err</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">DeadlineExceeded</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Println</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Search timed out, returning partial results&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#6639ba">fallbackSearch</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Search error: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#6639ba">fallbackSearch</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// If no results found, try query expansion</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">results</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Results</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Println</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;No results found, trying query expansion&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#6639ba">searchWithQueryExpansion</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">results</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// fallbackSearch provides a simpler search when main search fails</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchService</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">fallbackSearch</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">req</span> <span style="color:#1f2328">SearchRequest</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">SearchResponse</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Implement simpler search logic</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// For example, keyword-based search or simplified query</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// ...</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">SearchResponse</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Results</span><span style="color:#1f2328">:</span>     <span style="color:#1f2328">fallbackResults</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">TotalCount</span><span style="color:#1f2328">:</span>  <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">fallbackResults</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">ProcessedIn</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#57606a">// Not measured for fallback</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">},</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// handleEmptyQuery returns recent or popular documents for empty queries</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchService</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">handleEmptyQuery</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">req</span> <span style="color:#1f2328">SearchRequest</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">SearchResponse</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Retrieve recent documents instead of searching</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// ...</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">SearchResponse</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Results</span><span style="color:#1f2328">:</span>     <span style="color:#1f2328">recentDocs</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">TotalCount</span><span style="color:#1f2328">:</span>  <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">recentDocs</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">ProcessedIn</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">},</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// searchWithQueryExpansion tries alternative phrasings of the query</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchService</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">searchWithQueryExpansion</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">req</span> <span style="color:#1f2328">SearchRequest</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">SearchResponse</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Generate alternative phrasings</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">alternativeQueries</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">generateAlternativeQueries</span><span style="color:#1f2328">(</span><span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Query</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Try each alternative</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">bestResults</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchResponse</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">altQuery</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">alternativeQueries</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">altReq</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">req</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">altReq</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Query</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">altQuery</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">results</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Search</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">altReq</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">results</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Results</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// If we found results, use them</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">bestResults</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#0550ae">||</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">results</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Results</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">bestResults</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Results</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">bestResults</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">results</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">bestResults</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">bestResults</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// If no alternatives yielded results, return empty set</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">SearchResponse</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Results</span><span style="color:#1f2328">:</span>    <span style="color:#1f2328">[]</span><span style="color:#1f2328">SearchResult</span><span style="color:#1f2328">{},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">TotalCount</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">},</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// generateAlternativeQueries creates variations of the original query</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">generateAlternativeQueries</span><span style="color:#1f2328">(</span><span style="color:#1f2328">query</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">alternatives</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Add simple variations</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">alternatives</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">alternatives</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;about &#34;</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">query</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">alternatives</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">alternatives</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;what is &#34;</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">query</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">alternatives</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">alternatives</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">query</span> <span style="color:#0550ae">+</span> <span style="color:#0a3069">&#34; meaning&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">alternatives</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">alternatives</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">query</span> <span style="color:#0550ae">+</span> <span style="color:#0a3069">&#34; explanation&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Handle queries with potential negations</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Contains</span><span style="color:#1f2328">(</span><span style="color:#1f2328">query</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;not&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">||</span> <span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Contains</span><span style="color:#1f2328">(</span><span style="color:#1f2328">query</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;without&#34;</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Try removing negation</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">alternatives</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">alternatives</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ReplaceAll</span><span style="color:#1f2328">(</span><span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ReplaceAll</span><span style="color:#1f2328">(</span><span style="color:#1f2328">query</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;not &#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">),</span> <span style="color:#0a3069">&#34;without &#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">alternatives</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This error handling approach ensures a more robust user experience by:</p>
<ol>
<li>Providing sensible responses for empty queries</li>
<li>Setting timeouts to prevent long-running operations</li>
<li>Implementing fallback strategies for when vector search fails</li>
<li>Expanding queries when the original query yields no results</li>
</ol>
<h3 id="error-handling-and-logging">Error Handling and Logging</h3>
<p>Good error handling is essential for debuggability and reliability:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Custom error types for better error handling</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">var</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ErrQueryTooLong</span>       <span style="color:#1f2328">=</span> <span style="color:#1f2328">errors</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;query exceeds maximum length&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ErrEmbeddingFailed</span>    <span style="color:#1f2328">=</span> <span style="color:#1f2328">errors</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to generate embedding&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ErrVectorSearchFailed</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">errors</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;vector search operation failed&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ErrDocumentNotFound</span>   <span style="color:#1f2328">=</span> <span style="color:#1f2328">errors</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;document not found&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Structured logging for search operations</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">SearchLogger</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">logger</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">zap</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Logger</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewSearchLogger</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">SearchLogger</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">logger</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">zap</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewProduction</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">SearchLogger</span><span style="color:#1f2328">{</span><span style="color:#1f2328">logger</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">logger</span><span style="color:#1f2328">},</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// LogSearch records details about a search operation</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">l</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchLogger</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">LogSearch</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">req</span> <span style="color:#1f2328">SearchRequest</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">resp</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchResponse</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">err</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Extract user ID from context if available</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">userID</span> <span style="color:#0550ae">:=</span> <span style="color:#0a3069">&#34;anonymous&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">id</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ok</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">ctx</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Value</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;userID&#34;</span><span style="color:#1f2328">).(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">ok</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">userID</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">id</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Create structured log entry</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">fields</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">[]</span><span style="color:#1f2328">zap</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Field</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">zap</span><span style="color:#1f2328">.</span><span style="color:#6639ba">String</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;query&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Query</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">zap</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Int</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;limit&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Limit</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">zap</span><span style="color:#1f2328">.</span><span style="color:#6639ba">String</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;userID&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">userID</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">zap</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Int64</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;processingTime&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">resp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ProcessedIn</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">zap</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Int</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;resultCount&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">resp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">TotalCount</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Add filter information if present</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Filters</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">filterJSON</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">_</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Marshal</span><span style="color:#1f2328">(</span><span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Filters</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">fields</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">fields</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">zap</span><span style="color:#1f2328">.</span><span style="color:#6639ba">String</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;filters&#34;</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">string</span><span style="color:#1f2328">(</span><span style="color:#1f2328">filterJSON</span><span style="color:#1f2328">)))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Log the search event</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">fields</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">fields</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">zap</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Error</span><span style="color:#1f2328">(</span><span style="color:#1f2328">err</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">l</span><span style="color:#1f2328">.</span><span style="color:#1f2328">logger</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Error</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;search_failed&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fields</span><span style="color:#0550ae">...</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">l</span><span style="color:#1f2328">.</span><span style="color:#1f2328">logger</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Info</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;search_success&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fields</span><span style="color:#0550ae">...</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Enhance the search service with structured logging</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchService</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">SearchWithLogging</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">req</span> <span style="color:#1f2328">SearchRequest</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">logger</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchLogger</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">SearchResponse</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Perform the search</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">resp</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Search</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Log the search operation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">logger</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LogSearch</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">resp</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">resp</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This logging approach provides:</p>
<ol>
<li>Structured logs that are easily parsed and analyzed</li>
<li>Contextual information about search operations</li>
<li>Performance metrics for monitoring</li>
<li>Error details for troubleshooting</li>
</ol>
<h3 id="code-example-simple-search-api">Code Example: Simple Search API</h3>
<p>Let&rsquo;s bring these concepts together in a complete example of a simple but effective search API:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">package</span> <span style="color:#1f2328">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;encoding/json&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;github.com/gorilla/mux&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;go.uber.org/zap&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;myproject/embedding&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;myproject/vectorstore&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">main</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Initialize logger</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">logger</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">zap</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewProduction</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Fatalf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Failed to initialize logger: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">defer</span> <span style="color:#1f2328">logger</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sync</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">sugar</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">logger</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sugar</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Load configuration</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">config</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">LoadConfig</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">sugar</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Fatalf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Failed to load configuration: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Initialize embedder</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">embedder</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">embedding</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewEmbedder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">config</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Embedding</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">sugar</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Fatalf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Failed to initialize embedder: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Initialize vector store</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">vectorStore</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">vectorstore</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewWeaviateStore</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">config</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Weaviate</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Host</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">config</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Weaviate</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Class</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">sugar</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Fatalf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Failed to initialize vector store: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Create search service</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">searchSvc</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">NewSearchService</span><span style="color:#1f2328">(</span><span style="color:#1f2328">embedder</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">vectorStore</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">searchLogger</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">NewSearchLogger</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Create router</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">r</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">mux</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewRouter</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Register middleware</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Use</span><span style="color:#1f2328">(</span><span style="color:#1f2328">loggingMiddleware</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Use</span><span style="color:#1f2328">(</span><span style="color:#1f2328">corsMiddleware</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Use</span><span style="color:#1f2328">(</span><span style="color:#1f2328">authMiddleware</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Register routes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#6639ba">HandleFunc</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;/health&#34;</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ResponseWriter</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">r</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Request</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewEncoder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Encode</span><span style="color:#1f2328">(</span><span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">bool</span><span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;ok&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">true</span><span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}).</span><span style="color:#6639ba">Methods</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;GET&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#6639ba">HandleFunc</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;/search&#34;</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ResponseWriter</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">r</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Request</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">var</span> <span style="color:#1f2328">req</span> <span style="color:#1f2328">SearchRequest</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewDecoder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Body</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Decode</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">req</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Error</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Invalid request body&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusBadRequest</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">resp</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">searchSvc</span><span style="color:#1f2328">.</span><span style="color:#6639ba">SearchWithLogging</span><span style="color:#1f2328">(</span><span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Context</span><span style="color:#1f2328">(),</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">searchLogger</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">sugar</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorw</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Search failed&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;error&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;query&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Query</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Error</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Search failed&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusInternalServerError</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Header</span><span style="color:#1f2328">().</span><span style="color:#6639ba">Set</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Content-Type&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;application/json&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewEncoder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Encode</span><span style="color:#1f2328">(</span><span style="color:#1f2328">resp</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}).</span><span style="color:#6639ba">Methods</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;POST&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#6639ba">HandleFunc</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;/search/quick&#34;</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ResponseWriter</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">r</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Request</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">query</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#1f2328">URL</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Query</span><span style="color:#1f2328">().</span><span style="color:#6639ba">Get</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;q&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">query</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Error</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Query parameter &#39;q&#39; is required&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusBadRequest</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">req</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">SearchRequest</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Query</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">query</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Limit</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">5</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">resp</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">searchSvc</span><span style="color:#1f2328">.</span><span style="color:#6639ba">SearchWithLogging</span><span style="color:#1f2328">(</span><span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Context</span><span style="color:#1f2328">(),</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">searchLogger</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">sugar</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorw</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Quick search failed&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;error&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;query&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">query</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Error</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Search failed&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusInternalServerError</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Header</span><span style="color:#1f2328">().</span><span style="color:#6639ba">Set</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Content-Type&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;application/json&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewEncoder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Encode</span><span style="color:#1f2328">(</span><span style="color:#1f2328">resp</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}).</span><span style="color:#6639ba">Methods</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;GET&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Start server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">port</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">os</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Getenv</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;PORT&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">port</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">port</span> <span style="color:#1f2328">=</span> <span style="color:#0a3069">&#34;8080&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">server</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Server</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Addr</span><span style="color:#1f2328">:</span>         <span style="color:#0a3069">&#34;:&#34;</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">port</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Handler</span><span style="color:#1f2328">:</span>      <span style="color:#1f2328">r</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">ReadTimeout</span><span style="color:#1f2328">:</span>  <span style="color:#0550ae">10</span> <span style="color:#0550ae">*</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Second</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">WriteTimeout</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">10</span> <span style="color:#0550ae">*</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Second</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">IdleTimeout</span><span style="color:#1f2328">:</span>  <span style="color:#0550ae">120</span> <span style="color:#0550ae">*</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Second</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">sugar</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Infof</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Starting server on port %s&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">port</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">server</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ListenAndServe</span><span style="color:#1f2328">();</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">sugar</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Fatalf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Server failed: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Middleware for request logging</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">loggingMiddleware</span><span style="color:#1f2328">(</span><span style="color:#1f2328">next</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Handler</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Handler</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">HandlerFunc</span><span style="color:#1f2328">(</span><span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ResponseWriter</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">r</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Request</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">start</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Now</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Call the next handler</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ServeHTTP</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">r</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Log the request</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;%s %s %s %s&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#1f2328">RemoteAddr</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Method</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#1f2328">URL</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Path</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Since</span><span style="color:#1f2328">(</span><span style="color:#1f2328">start</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Middleware for CORS</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">corsMiddleware</span><span style="color:#1f2328">(</span><span style="color:#1f2328">next</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Handler</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Handler</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">HandlerFunc</span><span style="color:#1f2328">(</span><span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ResponseWriter</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">r</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Request</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Header</span><span style="color:#1f2328">().</span><span style="color:#6639ba">Set</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Access-Control-Allow-Origin&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;*&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Header</span><span style="color:#1f2328">().</span><span style="color:#6639ba">Set</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Access-Control-Allow-Methods&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;GET, POST, OPTIONS&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Header</span><span style="color:#1f2328">().</span><span style="color:#6639ba">Set</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Access-Control-Allow-Headers&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Content-Type, Authorization&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Method</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;OPTIONS&#34;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WriteHeader</span><span style="color:#1f2328">(</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusOK</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ServeHTTP</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">r</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Middleware for authentication</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">authMiddleware</span><span style="color:#1f2328">(</span><span style="color:#1f2328">next</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Handler</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Handler</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">HandlerFunc</span><span style="color:#1f2328">(</span><span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ResponseWriter</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">r</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Request</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Skip auth for health checks</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#1f2328">URL</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Path</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;/health&#34;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ServeHTTP</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">r</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Get auth token</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">token</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Header</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Get</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Authorization&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">token</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Error</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Unauthorized&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusUnauthorized</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// In a real app, validate the token and get user info</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">userID</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">validateToken</span><span style="color:#1f2328">(</span><span style="color:#1f2328">token</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">userID</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Error</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Invalid token&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusUnauthorized</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Add user ID to context</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">ctx</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WithValue</span><span style="color:#1f2328">(</span><span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Context</span><span style="color:#1f2328">(),</span> <span style="color:#0a3069">&#34;userID&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">userID</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Call the next handler with updated context</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ServeHTTP</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WithContext</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Placeholder token validation</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">validateToken</span><span style="color:#1f2328">(</span><span style="color:#1f2328">token</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">string</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// In a real app, verify the token and extract user ID</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// This is just a placeholder</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">token</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;invalid&#34;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;user-123&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This complete example provides:</p>
<ol>
<li>A fully functional search API with health checks</li>
<li>Middleware for logging, CORS, and authentication</li>
<li>Structured error handling and logging</li>
<li>Clean separation of concerns between handlers and business logic</li>
</ol>
<h3 id="best-practices-for-rag-search-apis">Best Practices for RAG Search APIs</h3>
<p>After building several RAG search APIs for production use, I&rsquo;ve collected some key best practices:</p>
<ol>
<li><strong>Cache query embeddings</strong>: If the same query is likely to be run multiple times, cache the embedding to avoid regenerating it.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">EmbeddingCache</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">cache</span>  <span style="color:#0550ae">*</span><span style="color:#1f2328">lru</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Cache</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">client</span> <span style="color:#1f2328">embedding</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Embedder</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewEmbeddingCache</span><span style="color:#1f2328">(</span><span style="color:#1f2328">client</span> <span style="color:#1f2328">embedding</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Embedder</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">size</span> <span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">EmbeddingCache</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">cache</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">_</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">lru</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">(</span><span style="color:#1f2328">size</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">EmbeddingCache</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">cache</span><span style="color:#1f2328">:</span>  <span style="color:#1f2328">cache</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">client</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">client</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">c</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">EmbeddingCache</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">EmbedText</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">text</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([]</span><span style="color:#cf222e">float32</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Check cache first</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">cached</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">found</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">cache</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Get</span><span style="color:#1f2328">(</span><span style="color:#1f2328">text</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">found</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">cached</span><span style="color:#1f2328">.([]</span><span style="color:#cf222e">float32</span><span style="color:#1f2328">),</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Generate embedding</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">embedding</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">client</span><span style="color:#1f2328">.</span><span style="color:#6639ba">EmbedText</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">text</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Cache the result</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">cache</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">text</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">embedding</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">embedding</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><ol start="2">
<li><strong>Implement rate limiting</strong>: Protect your embedding model and vector database from excessive load.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// RateLimiter enforces rate limits on API endpoints</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">RateLimiter</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">limiter</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">rate</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Limiter</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewRateLimiter</span><span style="color:#1f2328">(</span><span style="color:#1f2328">rps</span> <span style="color:#cf222e">float64</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">burst</span> <span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">RateLimiter</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">RateLimiter</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">limiter</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">rate</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewLimiter</span><span style="color:#1f2328">(</span><span style="color:#1f2328">rate</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Limit</span><span style="color:#1f2328">(</span><span style="color:#1f2328">rps</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">burst</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// RateLimitMiddleware enforces rate limits</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">rl</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">RateLimiter</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Middleware</span><span style="color:#1f2328">(</span><span style="color:#1f2328">next</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Handler</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Handler</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">HandlerFunc</span><span style="color:#1f2328">(</span><span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ResponseWriter</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">r</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Request</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">rl</span><span style="color:#1f2328">.</span><span style="color:#1f2328">limiter</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Allow</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Error</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Rate limit exceeded&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusTooManyRequests</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">next</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ServeHTTP</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">r</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><ol start="3">
<li><strong>Support semantic pagination</strong>: Traditional offset pagination doesn&rsquo;t work well with semantic search, so implement cursor-based pagination.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// SearchRequest with pagination support</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">SearchRequest</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Query</span>       <span style="color:#cf222e">string</span>                 <span style="color:#0a3069">`json:&#34;query&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Filters</span>     <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span> <span style="color:#0a3069">`json:&#34;filters,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Limit</span>       <span style="color:#cf222e">int</span>                    <span style="color:#0a3069">`json:&#34;limit,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Cursor</span>      <span style="color:#cf222e">string</span>                 <span style="color:#0a3069">`json:&#34;cursor,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Similarity</span>  <span style="color:#cf222e">float32</span>                <span style="color:#0a3069">`json:&#34;similarity,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">IncludeText</span> <span style="color:#cf222e">bool</span>                   <span style="color:#0a3069">`json:&#34;includeText,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// SearchResponse with pagination support</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">SearchResponse</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Results</span>     <span style="color:#1f2328">[]</span><span style="color:#1f2328">SearchResult</span> <span style="color:#0a3069">`json:&#34;results&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">TotalCount</span>  <span style="color:#cf222e">int</span>            <span style="color:#0a3069">`json:&#34;totalCount&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ProcessedIn</span> <span style="color:#cf222e">int64</span>          <span style="color:#0a3069">`json:&#34;processedIn&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">NextCursor</span>  <span style="color:#cf222e">string</span>         <span style="color:#0a3069">`json:&#34;nextCursor,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Implement cursor-based pagination</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchService</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">SearchWithPagination</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span> <span style="color:#1f2328">SearchRequest</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">SearchResponse</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Decode cursor if provided</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">lastScore</span> <span style="color:#cf222e">float32</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">lastID</span> <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Cursor</span> <span style="color:#0550ae">!=</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">cursors</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">decodeCursor</span><span style="color:#1f2328">(</span><span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Cursor</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;invalid cursor: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">lastScore</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">cursors</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Score</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">lastID</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">cursors</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ID</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Perform search with cursor info</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// ...</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Create next cursor for pagination</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">nextCursor</span> <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">results</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">lastResult</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">results</span><span style="color:#1f2328">[</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">results</span><span style="color:#1f2328">)</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">nextCursor</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">encodeCursor</span><span style="color:#1f2328">(</span><span style="color:#1f2328">lastResult</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Score</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">lastResult</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ID</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">SearchResponse</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Results</span><span style="color:#1f2328">:</span>    <span style="color:#1f2328">results</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">TotalCount</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">totalCount</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">NextCursor</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">nextCursor</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">},</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><ol start="4">
<li><strong>Monitor query performance</strong>: Track key metrics to identify performance issues.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">SearchMetrics</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">EmbeddingTime</span>   <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Duration</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">VectorSearchTime</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Duration</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ResultsCount</span>     <span style="color:#cf222e">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">TotalTime</span>        <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Duration</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchService</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">SearchWithMetrics</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span> <span style="color:#1f2328">SearchRequest</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">SearchResponse</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchMetrics</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">startTime</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Now</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">metrics</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">SearchMetrics</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Measure embedding generation time</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">embeddingStart</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Now</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">queryEmbedding</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">embedder</span><span style="color:#1f2328">.</span><span style="color:#6639ba">EmbedText</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Query</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">metrics</span><span style="color:#1f2328">.</span><span style="color:#1f2328">EmbeddingTime</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Since</span><span style="color:#1f2328">(</span><span style="color:#1f2328">embeddingStart</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">metrics</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;embedding generation failed: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Measure vector search time</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">searchStart</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Now</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">docs</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">vectorStore</span><span style="color:#1f2328">.</span><span style="color:#6639ba">SimilaritySearch</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">queryEmbedding</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Limit</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">metrics</span><span style="color:#1f2328">.</span><span style="color:#1f2328">VectorSearchTime</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Since</span><span style="color:#1f2328">(</span><span style="color:#1f2328">searchStart</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">metrics</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;vector search failed: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">metrics</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ResultsCount</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">docs</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">metrics</span><span style="color:#1f2328">.</span><span style="color:#1f2328">TotalTime</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Since</span><span style="color:#1f2328">(</span><span style="color:#1f2328">startTime</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Transform results</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// ...</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">response</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">metrics</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>These best practices help ensure your search API remains responsive, scalable, and maintainable as usage grows.</p>
<h3 id="looking-ahead-evolving-your-search-api">Looking Ahead: Evolving Your Search API</h3>
<p>The search API you build today should be designed to evolve with your needs. Consider these future enhancements:</p>
<ol>
<li><strong>Multi-modal search</strong>: Extending beyond text to search images, audio, or video</li>
<li><strong>Personalized ranking</strong>: Adjusting results based on user preferences and history</li>
<li><strong>Federated search</strong>: Combining results from multiple vector stores or data sources</li>
<li><strong>Semantic feedback loops</strong>: Learning from user interactions to improve relevance</li>
<li><strong>Explainable search</strong>: Providing users with insights into why results were selected</li>
</ol>
<p>By building on the solid foundation we&rsquo;ve established, these enhancements become natural extensions rather than painful rewrites.</p>
<h2 id="integrating-with-language-models">Integrating with Language Models</h2>
<p>We&rsquo;ve built an impressive search system that can find relevant documents based on semantic meaning rather than just keywords. But for many users, seeing a list of relevant document chunks isn&rsquo;t the end goal—they want answers to their questions. This is where we complete the RAG architecture by integrating with language models to generate coherent, contextual responses based on the retrieved information.</p>
<p>I once deployed a RAG system for a healthcare organization where the search component worked beautifully, but users found it frustrating to piece together answers from multiple document fragments. After adding LLM integration, user satisfaction scores jumped from 62% to 91%. The ability to get direct, synthesized answers made all the difference in adoption.</p>
<p>Let&rsquo;s explore how to integrate language models while maintaining our commitment to privacy and cost-effectiveness.</p>
<h3 id="self-hosted-llm-options-for-privacy">Self-Hosted LLM Options for Privacy</h3>
<p>When dealing with sensitive documents, sending their contents to third-party API services poses a significant privacy risk. Fortunately, several high-quality language models can now be run locally with reasonable hardware requirements.</p>
<h4 id="evaluating-lightweight-llms-for-generation">Evaluating Lightweight LLMs for Generation</h4>
<p>The LLM landscape is evolving rapidly, with increasingly capable models becoming available for local deployment. Here are some promising options as of our publication date:</p>
<ol>
<li>
<p><strong>Llama 3 8B/70B</strong>: Meta&rsquo;s Llama 3 models offer an excellent balance of performance and resource requirements. The 8B variant can run on consumer hardware with 16GB RAM, while the 70B version delivers near-GPT-4 level quality but requires more substantial resources.</p>
</li>
<li>
<p><strong>Mistral 7B/Mixtral 8x7B</strong>: Mistral AI&rsquo;s models deliver impressive performance for their size, with the Mixtral 8x7B model offering particularly strong capabilities in knowledge-intensive tasks like our RAG system requires.</p>
</li>
<li>
<p><strong>Gemma 2B/7B</strong>: Google&rsquo;s Gemma models are designed for efficiency and perform surprisingly well on many tasks despite their compact size.</p>
</li>
<li>
<p><strong>Phi-3 Mini/Small</strong>: Microsoft&rsquo;s Phi models offer strong performance with minimal resource requirements, making them ideal for deployment on modest hardware.</p>
</li>
</ol>
<p>When choosing a model, you need to consider:</p>
<ul>
<li>Resource requirements (RAM, disk space, CPU/GPU)</li>
<li>Performance on question answering tasks</li>
<li>License terms</li>
<li>Quantization options for reduced resource usage</li>
</ul>
<p>For our implementation, we&rsquo;ll design a flexible LLM integration layer that can work with any of these models (or others) depending on your specific requirements.</p>
<h3 id="implementing-the-generation-component">Implementing the Generation Component</h3>
<p>Let&rsquo;s create a clean interface for language model integration:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">package</span> <span style="color:#1f2328">llm</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Common errors</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">var</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ErrGenerationFailed</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">errors</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;text generation failed&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ErrContextTooLong</span>   <span style="color:#1f2328">=</span> <span style="color:#1f2328">errors</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;context exceeds model&#39;s maximum length&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ErrInvalidPrompt</span>    <span style="color:#1f2328">=</span> <span style="color:#1f2328">errors</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;prompt contains invalid or harmful content&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// GenerationRequest defines the input for text generation</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">GenerationRequest</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Prompt</span>        <span style="color:#cf222e">string</span>  <span style="color:#57606a">// The prompt template with placeholders</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Query</span>         <span style="color:#cf222e">string</span>  <span style="color:#57606a">// User&#39;s original query</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Context</span>       <span style="color:#cf222e">string</span>  <span style="color:#57606a">// Retrieved context to inform the generation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">MaxTokens</span>     <span style="color:#cf222e">int</span>     <span style="color:#57606a">// Maximum tokens to generate</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Temperature</span>   <span style="color:#cf222e">float32</span> <span style="color:#57606a">// Randomness control (0.0-1.0)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">StopSequences</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span> <span style="color:#57606a">// Sequences that will stop generation when encountered</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// GenerationResponse contains the generated text and metadata</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">GenerationResponse</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Text</span>        <span style="color:#cf222e">string</span>   <span style="color:#57606a">// The generated text</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">SourceIDs</span>   <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span> <span style="color:#57606a">// IDs of source documents used</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">TokensUsed</span>  <span style="color:#cf222e">int</span>      <span style="color:#57606a">// Number of tokens processed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Truncated</span>   <span style="color:#cf222e">bool</span>     <span style="color:#57606a">// Whether the context was truncated</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Generator defines the interface for text generation</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Generator</span> <span style="color:#cf222e">interface</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Generate produces text based on the provided request</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">Generate</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span> <span style="color:#1f2328">GenerationRequest</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">GenerationResponse</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// ModelInfo returns information about the underlying model</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">ModelInfo</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">ModelInfo</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// ModelInfo contains information about the language model</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">ModelInfo</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Name</span>            <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Version</span>         <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ContextLength</span>   <span style="color:#cf222e">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">EmbeddingDims</span>   <span style="color:#cf222e">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">QuantizationLevel</span> <span style="color:#cf222e">string</span> <span style="color:#57606a">// e.g., &#34;none&#34;, &#34;4-bit&#34;, &#34;8-bit&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This interface allows us to implement different language model backends while keeping the rest of our application consistent.</p>
<h3 id="local-llm-implementation-with-ollama">Local LLM Implementation with Ollama</h3>
<p><a href="https://ollama.ai/">Ollama</a> provides a simple way to run various LLMs locally with a convenient API. Let&rsquo;s implement our Generator interface using Ollama:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// OllamaGenerator implements Generator using the Ollama API</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">OllamaGenerator</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">baseURL</span>     <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">modelName</span>   <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">modelInfo</span>   <span style="color:#1f2328">ModelInfo</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">client</span>      <span style="color:#0550ae">*</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Client</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// NewOllamaGenerator creates a new generator using Ollama</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewOllamaGenerator</span><span style="color:#1f2328">(</span><span style="color:#1f2328">baseURL</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">modelName</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">OllamaGenerator</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">client</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Client</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Timeout</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">60</span> <span style="color:#0550ae">*</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Second</span><span style="color:#1f2328">,</span> <span style="color:#57606a">// LLM generation can take time</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Initialize with basic info</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">generator</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">OllamaGenerator</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">baseURL</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">baseURL</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">modelName</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">modelName</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">client</span><span style="color:#1f2328">:</span>    <span style="color:#1f2328">client</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">modelInfo</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">ModelInfo</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Name</span><span style="color:#1f2328">:</span>    <span style="color:#1f2328">modelName</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Version</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;unknown&#34;</span><span style="color:#1f2328">,</span> <span style="color:#57606a">// Will be populated from API</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Fetch model info from Ollama</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">generator</span><span style="color:#1f2328">.</span><span style="color:#6639ba">fetchModelInfo</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to fetch model info: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">generator</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// fetchModelInfo gets model details from Ollama</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">g</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">OllamaGenerator</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">fetchModelInfo</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">error</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">url</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sprintf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;%s/api/show&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">g</span><span style="color:#1f2328">.</span><span style="color:#1f2328">baseURL</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">reqBody</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Marshal</span><span style="color:#1f2328">(</span><span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">g</span><span style="color:#1f2328">.</span><span style="color:#1f2328">modelName</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">resp</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">g</span><span style="color:#1f2328">.</span><span style="color:#1f2328">client</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Post</span><span style="color:#1f2328">(</span><span style="color:#1f2328">url</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;application/json&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bytes</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewBuffer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">reqBody</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">defer</span> <span style="color:#1f2328">resp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Body</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Close</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">resp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusCode</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusOK</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Ollama API returned status %d&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">resp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusCode</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">result</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">ModelFile</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Parameter</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">ContextLength</span> <span style="color:#cf222e">int</span> <span style="color:#0a3069">`json:&#34;num_ctx&#34;`</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span> <span style="color:#0a3069">`json:&#34;parameter&#34;`</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span> <span style="color:#0a3069">`json:&#34;modelfile&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">err</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewDecoder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">resp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Body</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Decode</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">result</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">g</span><span style="color:#1f2328">.</span><span style="color:#1f2328">modelInfo</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ContextLength</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ModelFile</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Parameter</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ContextLength</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Generate implements the Generator interface</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">g</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">OllamaGenerator</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Generate</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span> <span style="color:#1f2328">GenerationRequest</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">GenerationResponse</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Prepare the full prompt with context</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">fullPrompt</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">g</span><span style="color:#1f2328">.</span><span style="color:#6639ba">formatPrompt</span><span style="color:#1f2328">(</span><span style="color:#1f2328">req</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Check if the prompt exceeds context length</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">fullPrompt</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#1f2328">g</span><span style="color:#1f2328">.</span><span style="color:#1f2328">modelInfo</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ContextLength</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Truncate if necessary</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">fullPrompt</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">fullPrompt</span><span style="color:#1f2328">[:</span><span style="color:#1f2328">g</span><span style="color:#1f2328">.</span><span style="color:#1f2328">modelInfo</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ContextLength</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Log a warning</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Warning: Prompt truncated to fit model context length&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Prepare request to Ollama API</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">requestBody</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{}{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;model&#34;</span><span style="color:#1f2328">:</span>       <span style="color:#1f2328">g</span><span style="color:#1f2328">.</span><span style="color:#1f2328">modelName</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;prompt&#34;</span><span style="color:#1f2328">:</span>      <span style="color:#1f2328">fullPrompt</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;temperature&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Temperature</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">MaxTokens</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">requestBody</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;max_tokens&#34;</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">MaxTokens</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StopSequences</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">requestBody</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;stop&#34;</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StopSequences</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">reqBody</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Marshal</span><span style="color:#1f2328">(</span><span style="color:#1f2328">requestBody</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Make API request</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">resp</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">g</span><span style="color:#1f2328">.</span><span style="color:#1f2328">client</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Post</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sprintf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;%s/api/generate&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">g</span><span style="color:#1f2328">.</span><span style="color:#1f2328">baseURL</span><span style="color:#1f2328">),</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;application/json&#34;</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">bytes</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewBuffer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">reqBody</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">defer</span> <span style="color:#1f2328">resp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Body</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Close</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">resp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusCode</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusOK</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Ollama API returned status %d&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">resp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusCode</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Parse response</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">result</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Response</span> <span style="color:#cf222e">string</span> <span style="color:#0a3069">`json:&#34;response&#34;`</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Eval_Count</span> <span style="color:#cf222e">int</span>  <span style="color:#0a3069">`json:&#34;eval_count&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">err</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewDecoder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">resp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Body</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Decode</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">result</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Extract source document IDs from context</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// This is a simplified approach - in a real implementation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// you&#39;d track which chunks were used in the context</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">sourceIDs</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">extractSourceIDs</span><span style="color:#1f2328">(</span><span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">GenerationResponse</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Text</span><span style="color:#1f2328">:</span>       <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Response</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">SourceIDs</span><span style="color:#1f2328">:</span>  <span style="color:#1f2328">sourceIDs</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">TokensUsed</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Eval_Count</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Truncated</span><span style="color:#1f2328">:</span>  <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">fullPrompt</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&lt;</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">g</span><span style="color:#1f2328">.</span><span style="color:#6639ba">formatPrompt</span><span style="color:#1f2328">(</span><span style="color:#1f2328">req</span><span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">},</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// ModelInfo returns information about the underlying model</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">g</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">OllamaGenerator</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">ModelInfo</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">ModelInfo</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">g</span><span style="color:#1f2328">.</span><span style="color:#1f2328">modelInfo</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// formatPrompt creates the full prompt with context</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">g</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">OllamaGenerator</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">formatPrompt</span><span style="color:#1f2328">(</span><span style="color:#1f2328">req</span> <span style="color:#1f2328">GenerationRequest</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">string</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// This is a simple prompt template - you would customize this</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// based on the specific model you&#39;re using</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sprintf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">`
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">You are a helpful assistant that provides accurate information based only on the provided context.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">If the information to answer the question is not in the context, say &#34;I don&#39;t have enough information to answer this question.&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">CONTEXT:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">%s
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">QUESTION:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">%s
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">ANSWER:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">`</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Query</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Helper function to extract source IDs from context</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">extractSourceIDs</span><span style="color:#1f2328">(</span><span style="color:#1f2328">context</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// In a real implementation, you would include source IDs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// in the context in a structured way and extract them here</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// This is just a placeholder</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This implementation handles the key aspects of LLM integration:</p>
<ol>
<li>Model information discovery</li>
<li>Context length management</li>
<li>Prompt formatting</li>
<li>Generation parameter control</li>
<li>Error handling</li>
</ol>
<p>For production use, you would enhance this with features like:</p>
<ul>
<li>Structured source tracking for citations</li>
<li>Streaming responses for better UX</li>
<li>More sophisticated prompt templates</li>
</ul>
<h3 id="context-window-management">Context Window Management</h3>
<p>One of the trickiest aspects of RAG systems is managing the context window effectively. Most LLMs have a fixed maximum context length, and exceeding it can cause truncation or errors.</p>
<p>Let&rsquo;s implement a context manager that optimizes how we use the available context window:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// ContextManager handles the assembly and optimization of context for the LLM</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">ContextManager</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">maxContextLength</span> <span style="color:#cf222e">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">tokenizer</span>        <span style="color:#0550ae">*</span><span style="color:#1f2328">tokenizer</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Tokenizer</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// NewContextManager creates a new context manager</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewContextManager</span><span style="color:#1f2328">(</span><span style="color:#1f2328">maxContextLength</span> <span style="color:#cf222e">int</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">tokenizerPath</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">ContextManager</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Initialize a tokenizer - this would typically be model-specific</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// For this example, we&#39;re using a hypothetical tokenizer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">tokenizer</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">tokenizer</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewFromFile</span><span style="color:#1f2328">(</span><span style="color:#1f2328">tokenizerPath</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;failed to load tokenizer: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">ContextManager</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">maxContextLength</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">maxContextLength</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">tokenizer</span><span style="color:#1f2328">:</span>        <span style="color:#1f2328">tokenizer</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">},</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// AssembleContext builds an optimal context from search results</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">m</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ContextManager</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">AssembleContext</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">query</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">results</span> <span style="color:#1f2328">[]</span><span style="color:#1f2328">SearchResult</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">reservedTokens</span> <span style="color:#cf222e">int</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Calculate tokens needed for the prompt template and query</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">promptTemplate</span> <span style="color:#0550ae">:=</span> <span style="color:#0a3069">&#34;You are a helpful assistant...[template text]...&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">basePrompt</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sprintf</span><span style="color:#1f2328">(</span><span style="color:#1f2328">promptTemplate</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">query</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">baseTokenCount</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tokenizer</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CountTokens</span><span style="color:#1f2328">(</span><span style="color:#1f2328">basePrompt</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Calculate available tokens for context</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">availableTokens</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">maxContextLength</span> <span style="color:#0550ae">-</span> <span style="color:#1f2328">baseTokenCount</span> <span style="color:#0550ae">-</span> <span style="color:#1f2328">reservedTokens</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">availableTokens</span> <span style="color:#0550ae">&lt;=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">errors</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;not enough context space for results&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Track used source IDs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">usedSources</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// First, try to use all results if they fit</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">builder</span> <span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Builder</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">currentTokens</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">result</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">results</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Add source reference</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">sourceRef</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sprintf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;[Source: %s]\n&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ID</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">sourceTokens</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tokenizer</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CountTokens</span><span style="color:#1f2328">(</span><span style="color:#1f2328">sourceRef</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Add content with token counting</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">content</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Content</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">contentTokens</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tokenizer</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CountTokens</span><span style="color:#1f2328">(</span><span style="color:#1f2328">content</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Check if adding this result would exceed our budget</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">currentTokens</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">sourceTokens</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">contentTokens</span> <span style="color:#1f2328">&gt;</span> <span style="color:#1f2328">availableTokens</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// If this is the first result and it doesn&#39;t fit, we need to truncate</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">usedSources</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a">// Calculate how many tokens we can use</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">availableContentTokens</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">availableTokens</span> <span style="color:#0550ae">-</span> <span style="color:#1f2328">sourceTokens</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#57606a">// Truncate content to fit</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">truncatedContent</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tokenizer</span><span style="color:#1f2328">.</span><span style="color:#6639ba">TruncateToTokens</span><span style="color:#1f2328">(</span><span style="color:#1f2328">content</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">availableContentTokens</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">builder</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WriteString</span><span style="color:#1f2328">(</span><span style="color:#1f2328">sourceRef</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">builder</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WriteString</span><span style="color:#1f2328">(</span><span style="color:#1f2328">truncatedContent</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">builder</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WriteString</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;\n\n&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">usedSources</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">usedSources</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ID</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// Otherwise, we&#39;ve added as many full results as we can</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Add the result to our context</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">builder</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WriteString</span><span style="color:#1f2328">(</span><span style="color:#1f2328">sourceRef</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">builder</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WriteString</span><span style="color:#1f2328">(</span><span style="color:#1f2328">content</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">builder</span><span style="color:#1f2328">.</span><span style="color:#6639ba">WriteString</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;\n\n&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">currentTokens</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">sourceTokens</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">contentTokens</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">usedSources</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">usedSources</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ID</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">builder</span><span style="color:#1f2328">.</span><span style="color:#6639ba">String</span><span style="color:#1f2328">(),</span> <span style="color:#1f2328">usedSources</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This context manager handles several important tasks:</p>
<ol>
<li>Calculating token budgets based on the model&rsquo;s context window</li>
<li>Prioritizing the most relevant results</li>
<li>Truncating content when necessary</li>
<li>Tracking which sources were included</li>
</ol>
<p>In a production system, you would refine this further with techniques like:</p>
<ul>
<li>More sophisticated content truncation that preserves semantic meaning</li>
<li>Reordering content based on relevance</li>
<li>Summarizing lengthy sections to fit more content</li>
</ul>
<h3 id="prompt-engineering-for-better-results">Prompt Engineering for Better Results</h3>
<p>The way you frame questions to the language model significantly impacts the quality of responses. Let&rsquo;s explore some effective prompt templates for RAG:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// PromptTemplate defines a template for generating LLM prompts</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">PromptTemplate</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Name</span>          <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Template</span>      <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">RequiresModel</span> <span style="color:#cf222e">string</span> <span style="color:#57606a">// Model name/family this template is designed for</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// GetPromptTemplates returns a set of prompt templates for different scenarios</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">GetPromptTemplates</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#1f2328">PromptTemplate</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#1f2328">PromptTemplate</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;default&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Name</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;Default RAG Prompt&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Template</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">`You are a helpful assistant that answers questions based on the provided context.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Answer the question using ONLY the information from the context below.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">If the answer cannot be found in the context, say &#34;I don&#39;t have enough information to answer this question.&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Do not use any prior knowledge.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">CONTEXT:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#57606a">{{</span><span style="color:#1f2328">.Context</span><span style="color:#57606a">}}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">QUESTION:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#57606a">{{</span><span style="color:#1f2328">.Query</span><span style="color:#57606a">}}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">ANSWER:`</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;detailed&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Name</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;Detailed Analysis Prompt&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Template</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">`You are a helpful assistant that provides detailed, comprehensive answers based on the provided context.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Answer the question thoroughly using ONLY the information from the context below.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Organize your answer with clear sections and bullet points when appropriate.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">If the answer cannot be found in the context, say &#34;I don&#39;t have enough information to answer this question.&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Do not use any prior knowledge.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">CONTEXT:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#57606a">{{</span><span style="color:#1f2328">.Context</span><span style="color:#57606a">}}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">QUESTION:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#57606a">{{</span><span style="color:#1f2328">.Query</span><span style="color:#57606a">}}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">DETAILED ANSWER:`</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;concise&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Name</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;Concise Summary Prompt&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Template</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">`You are a helpful assistant that provides brief, to-the-point answers based on the provided context.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Answer the question concisely using ONLY the information from the context below.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Use no more than 2-3 sentences.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">If the answer cannot be found in the context, say &#34;I don&#39;t have enough information.&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Do not use any prior knowledge.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">CONTEXT:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#57606a">{{</span><span style="color:#1f2328">.Context</span><span style="color:#57606a">}}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">QUESTION:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#57606a">{{</span><span style="color:#1f2328">.Query</span><span style="color:#57606a">}}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">CONCISE ANSWER:`</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;llama&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Name</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;Llama-Specific RAG Prompt&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">RequiresModel</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;llama&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Template</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">`&lt;s&gt;[INST] &lt;&lt;SYS&gt;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">You are a helpful assistant that answers questions based on the provided context.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Answer the question using ONLY the information from the context below.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">If the answer cannot be found in the context, say &#34;I don&#39;t have enough information to answer this question.&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Do not use any prior knowledge.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&lt;&lt;/SYS&gt;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">CONTEXT:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#57606a">{{</span><span style="color:#1f2328">.Context</span><span style="color:#57606a">}}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">QUESTION:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#57606a">{{</span><span style="color:#1f2328">.Query</span><span style="color:#57606a">}}</span><span style="color:#0a3069"> [/INST]`</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;mistral&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Name</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;Mistral-Specific RAG Prompt&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">RequiresModel</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;mistral&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Template</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">`&lt;s&gt;[INST] 
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">You are a helpful assistant that answers questions based on the provided context.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Answer the question using ONLY the information from the context below.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">If the answer cannot be found in the context, say &#34;I don&#39;t have enough information to answer this question.&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Do not use any prior knowledge.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">CONTEXT:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#57606a">{{</span><span style="color:#1f2328">.Context</span><span style="color:#57606a">}}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">QUESTION:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#57606a">{{</span><span style="color:#1f2328">.Query</span><span style="color:#57606a">}}</span><span style="color:#0a3069"> [/INST]`</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// PromptFormatter formats prompts using templates</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">PromptFormatter</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">templates</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#1f2328">PromptTemplate</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// NewPromptFormatter creates a new prompt formatter</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewPromptFormatter</span><span style="color:#1f2328">()</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">PromptFormatter</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">PromptFormatter</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">templates</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">GetPromptTemplates</span><span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// FormatPrompt formats a prompt using the specified template</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">f</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">PromptFormatter</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">FormatPrompt</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">templateName</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">query</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">context</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">modelName</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Check if template exists</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">template</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ok</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">f</span><span style="color:#1f2328">.</span><span style="color:#1f2328">templates</span><span style="color:#1f2328">[</span><span style="color:#1f2328">templateName</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">ok</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;template &#39;%s&#39; not found&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">templateName</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// If template requires specific model, check compatibility</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">template</span><span style="color:#1f2328">.</span><span style="color:#1f2328">RequiresModel</span> <span style="color:#0550ae">!=</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Contains</span><span style="color:#1f2328">(</span><span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ToLower</span><span style="color:#1f2328">(</span><span style="color:#1f2328">modelName</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">template</span><span style="color:#1f2328">.</span><span style="color:#1f2328">RequiresModel</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;template &#39;%s&#39; requires model &#39;%s&#39;&#34;</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">templateName</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">template</span><span style="color:#1f2328">.</span><span style="color:#1f2328">RequiresModel</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Parse the template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">tmpl</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">text</span><span style="color:#1f2328">.</span><span style="color:#1f2328">template</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;prompt&#34;</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Parse</span><span style="color:#1f2328">(</span><span style="color:#1f2328">template</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Template</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Prepare data for template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">data</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Query</span>   <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Context</span> <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Query</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">query</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Context</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Execute the template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> <span style="color:#1f2328">result</span> <span style="color:#1f2328">strings</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Builder</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">err</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">tmpl</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Execute</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">result</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">data</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#6639ba">String</span><span style="color:#1f2328">(),</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This approach provides several advantages:</p>
<ol>
<li>Model-specific prompting for optimal results</li>
<li>Templates for different use cases (default, detailed, concise)</li>
<li>Clean separation of prompt logic from generation</li>
<li>Easy addition of new templates as models evolve</li>
</ol>
<h3 id="code-example-integrating-with-a-self-hosted-llm">Code Example: Integrating with a Self-Hosted LLM</h3>
<p>Now let&rsquo;s put it all together with a complete example of integrating our search API with a local LLM to create a full RAG system:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">package</span> <span style="color:#1f2328">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;encoding/json&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;github.com/gorilla/mux&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// RAGRequest represents the input for a RAG query</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">RAGRequest</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Query</span>         <span style="color:#cf222e">string</span>                 <span style="color:#0a3069">`json:&#34;query&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Filters</span>       <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span> <span style="color:#0a3069">`json:&#34;filters,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">MaxResults</span>    <span style="color:#cf222e">int</span>                    <span style="color:#0a3069">`json:&#34;maxResults,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">PromptTemplate</span> <span style="color:#cf222e">string</span>                <span style="color:#0a3069">`json:&#34;promptTemplate,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Temperature</span>   <span style="color:#cf222e">float32</span>                <span style="color:#0a3069">`json:&#34;temperature,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// RAGResponse represents the output from a RAG query</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">RAGResponse</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Answer</span>        <span style="color:#cf222e">string</span>         <span style="color:#0a3069">`json:&#34;answer&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Sources</span>       <span style="color:#1f2328">[]</span><span style="color:#1f2328">SourceInfo</span>   <span style="color:#0a3069">`json:&#34;sources&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ProcessingTime</span> <span style="color:#cf222e">int64</span>         <span style="color:#0a3069">`json:&#34;processingTime&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// SourceInfo contains information about a source document</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">SourceInfo</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ID</span>       <span style="color:#cf222e">string</span>                 <span style="color:#0a3069">`json:&#34;id&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Title</span>    <span style="color:#cf222e">string</span>                 <span style="color:#0a3069">`json:&#34;title,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Source</span>   <span style="color:#cf222e">string</span>                 <span style="color:#0a3069">`json:&#34;source&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Metadata</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{}</span> <span style="color:#0a3069">`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Score</span>    <span style="color:#cf222e">float32</span>                <span style="color:#0a3069">`json:&#34;score&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// RAGService combines search and LLM generation</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">RAGService</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">searchService</span>  <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchService</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">generator</span>      <span style="color:#1f2328">llm</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Generator</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">contextManager</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ContextManager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">promptFormatter</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">PromptFormatter</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// NewRAGService creates a new RAG service</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewRAGService</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">searchService</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchService</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">generator</span> <span style="color:#1f2328">llm</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Generator</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">contextManager</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ContextManager</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">promptFormatter</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">PromptFormatter</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">RAGService</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">RAGService</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">searchService</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">searchService</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">generator</span><span style="color:#1f2328">:</span>       <span style="color:#1f2328">generator</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">contextManager</span><span style="color:#1f2328">:</span>  <span style="color:#1f2328">contextManager</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">promptFormatter</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">promptFormatter</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// ProcessQuery handles a complete RAG query</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">RAGService</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">ProcessQuery</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">req</span> <span style="color:#1f2328">RAGRequest</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">RAGResponse</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">startTime</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Now</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Set defaults if not provided</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">MaxResults</span> <span style="color:#0550ae">&lt;=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">MaxResults</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">PromptTemplate</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">PromptTemplate</span> <span style="color:#1f2328">=</span> <span style="color:#0a3069">&#34;default&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Temperature</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Temperature</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">0.7</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Step 1: Perform the search</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">searchReq</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">SearchRequest</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Query</span><span style="color:#1f2328">:</span>      <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Query</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Filters</span><span style="color:#1f2328">:</span>    <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Filters</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Limit</span><span style="color:#1f2328">:</span>      <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">MaxResults</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">IncludeText</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">true</span><span style="color:#1f2328">,</span> <span style="color:#57606a">// We need the content for the LLM</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">searchResp</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">searchService</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Search</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">searchReq</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;search failed: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Step 2: Assemble context from search results</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">modelInfo</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">generator</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ModelInfo</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Reserve tokens for the answer (estimated)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">reservedTokens</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">300</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">usedSources</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">contextManager</span><span style="color:#1f2328">.</span><span style="color:#6639ba">AssembleContext</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Query</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">searchResp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Results</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">reservedTokens</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;context assembly failed: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// If no relevant context was found</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">context</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">RAGResponse</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">Answer</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;I couldn&#39;t find any relevant information to answer your query.&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">ProcessingTime</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Since</span><span style="color:#1f2328">(</span><span style="color:#1f2328">startTime</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Milliseconds</span><span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">},</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Step 3: Format the prompt</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">prompt</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">promptFormatter</span><span style="color:#1f2328">.</span><span style="color:#6639ba">FormatPrompt</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">PromptTemplate</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Query</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">context</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">modelInfo</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Name</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Fall back to default template if there&#39;s an issue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">prompt</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">promptFormatter</span><span style="color:#1f2328">.</span><span style="color:#6639ba">FormatPrompt</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;default&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Query</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">context</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">modelInfo</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Name</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;prompt formatting failed: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Step 4: Generate the answer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">genReq</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">llm</span><span style="color:#1f2328">.</span><span style="color:#1f2328">GenerationRequest</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Prompt</span><span style="color:#1f2328">:</span>      <span style="color:#1f2328">prompt</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Query</span><span style="color:#1f2328">:</span>       <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Query</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Context</span><span style="color:#1f2328">:</span>     <span style="color:#1f2328">context</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Temperature</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Temperature</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">MaxTokens</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">reservedTokens</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">genResp</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">generator</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Generate</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">genReq</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Errorf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;text generation failed: %w&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Step 5: Collect source information</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">sources</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">make</span><span style="color:#1f2328">([]</span><span style="color:#1f2328">SourceInfo</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">usedSources</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">sourceMap</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">make</span><span style="color:#1f2328">(</span><span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">bool</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">id</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">usedSources</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">sourceMap</span><span style="color:#1f2328">[</span><span style="color:#1f2328">id</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">continue</span> <span style="color:#57606a">// Avoid duplicates</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">sourceMap</span><span style="color:#1f2328">[</span><span style="color:#1f2328">id</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Find the source in search results</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">result</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">searchResp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Results</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ID</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">id</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">sources</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">sources</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">SourceInfo</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">ID</span><span style="color:#1f2328">:</span>       <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ID</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">Title</span><span style="color:#1f2328">:</span>    <span style="color:#6639ba">getTitle</span><span style="color:#1f2328">(</span><span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Metadata</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">Source</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">SourceFile</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">Metadata</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Metadata</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">Score</span><span style="color:#1f2328">:</span>    <span style="color:#1f2328">result</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Score</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">RAGResponse</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Answer</span><span style="color:#1f2328">:</span>        <span style="color:#1f2328">genResp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Text</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">Sources</span><span style="color:#1f2328">:</span>       <span style="color:#1f2328">sources</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">ProcessingTime</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Since</span><span style="color:#1f2328">(</span><span style="color:#1f2328">startTime</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Milliseconds</span><span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">},</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Helper function to extract title from metadata</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">getTitle</span><span style="color:#1f2328">(</span><span style="color:#1f2328">metadata</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#cf222e">string</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">title</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ok</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">metadata</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;title&#34;</span><span style="color:#1f2328">].(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">ok</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">title</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// RAG HTTP handler</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">handleRAG</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ragService</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">RAGService</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">HandlerFunc</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ResponseWriter</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">r</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Request</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">var</span> <span style="color:#1f2328">req</span> <span style="color:#1f2328">RAGRequest</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Decode the request</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewDecoder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Body</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Decode</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">req</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Error</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Invalid request body&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusBadRequest</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Process the query</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">resp</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">ragService</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ProcessQuery</span><span style="color:#1f2328">(</span><span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Context</span><span style="color:#1f2328">(),</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;RAG processing error: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Error</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Query processing failed&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusInternalServerError</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Return the response</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">w</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Header</span><span style="color:#1f2328">().</span><span style="color:#6639ba">Set</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Content-Type&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;application/json&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewEncoder</span><span style="color:#1f2328">(</span><span style="color:#1f2328">w</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Encode</span><span style="color:#1f2328">(</span><span style="color:#1f2328">resp</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">main</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Initialize components</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">searchService</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">initSearchService</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Initialize LLM generator</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">generator</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">llm</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewOllamaGenerator</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;http://localhost:11434&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;llama3:8b&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Fatalf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Failed to initialize generator: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Initialize context manager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">contextManager</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">NewContextManager</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">generator</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ModelInfo</span><span style="color:#1f2328">().</span><span style="color:#1f2328">ContextLength</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;path/to/tokenizer&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Fatalf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Failed to initialize context manager: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Initialize prompt formatter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">promptFormatter</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">NewPromptFormatter</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Create RAG service</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ragService</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">NewRAGService</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">searchService</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">generator</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">contextManager</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">promptFormatter</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Set up routes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">r</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">mux</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewRouter</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// RAG endpoint</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">r</span><span style="color:#1f2328">.</span><span style="color:#6639ba">HandleFunc</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;/rag&#34;</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">handleRAG</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ragService</span><span style="color:#1f2328">)).</span><span style="color:#6639ba">Methods</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;POST&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Start server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Println</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Starting server on :8080&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Fatal</span><span style="color:#1f2328">(</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ListenAndServe</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;:8080&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">r</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This implementation provides a complete RAG system with:</p>
<ol>
<li>Search integration for document retrieval</li>
<li>Context assembly optimized for the LLM&rsquo;s context window</li>
<li>Prompt formatting with templates</li>
<li>LLM generation with a self-hosted model</li>
<li>Source attribution in responses</li>
</ol>
<h3 id="future-directions-and-considerations">Future Directions and Considerations</h3>
<p>As you implement this RAG architecture, consider these future directions:</p>
<h4 id="1-multi-model-support">1. Multi-model Support</h4>
<p>Different queries might benefit from different language models. You could implement a model selection strategy:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// ModelSelector chooses the optimal LLM based on query characteristics</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">ModelSelector</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">generators</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#1f2328">llm</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Generator</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// SelectModel chooses the best model for a query</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ModelSelector</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">SelectModel</span><span style="color:#1f2328">(</span><span style="color:#1f2328">query</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">filters</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#cf222e">string</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Simple length-based selection</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">queryLength</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#1f2328">query</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">queryLength</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">200</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Complex query - use larger model if available</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ok</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#1f2328">generators</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;large&#34;</span><span style="color:#1f2328">];</span> <span style="color:#1f2328">ok</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;large&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Check for specific domains</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">isCodeQuery</span><span style="color:#1f2328">(</span><span style="color:#1f2328">query</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#6639ba">hasModelForDomain</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;code&#34;</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;code&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">isLegalQuery</span><span style="color:#1f2328">(</span><span style="color:#1f2328">query</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">s</span><span style="color:#1f2328">.</span><span style="color:#6639ba">hasModelForDomain</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;legal&#34;</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;legal&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Default to base model</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;base&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h4 id="2-response-streaming">2. Response Streaming</h4>
<p>For better UX, implement streaming responses:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// StreamingGenerator extends Generator with streaming capabilities</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">StreamingGenerator</span> <span style="color:#cf222e">interface</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Generator</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// GenerateStream produces text in a streaming fashion</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">GenerateStream</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span> <span style="color:#1f2328">GenerationRequest</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">&lt;-</span><span style="color:#cf222e">chan</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Implementation for Ollama streaming</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">g</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">OllamaGenerator</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">GenerateStream</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span> <span style="color:#1f2328">GenerationRequest</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">&lt;-</span><span style="color:#cf222e">chan</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Create output channel</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">outputChan</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">make</span><span style="color:#1f2328">(</span><span style="color:#cf222e">chan</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Format prompt</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">fullPrompt</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">g</span><span style="color:#1f2328">.</span><span style="color:#6639ba">formatPrompt</span><span style="color:#1f2328">(</span><span style="color:#1f2328">req</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Prepare request</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">requestBody</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{}{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;model&#34;</span><span style="color:#1f2328">:</span>       <span style="color:#1f2328">g</span><span style="color:#1f2328">.</span><span style="color:#1f2328">modelName</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;prompt&#34;</span><span style="color:#1f2328">:</span>      <span style="color:#1f2328">fullPrompt</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;temperature&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Temperature</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;stream&#34;</span><span style="color:#1f2328">:</span>      <span style="color:#cf222e">true</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Set up HTTP request</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">reqBody</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Marshal</span><span style="color:#1f2328">(</span><span style="color:#1f2328">requestBody</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">httpReq</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewRequestWithContext</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;POST&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sprintf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;%s/api/generate&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">g</span><span style="color:#1f2328">.</span><span style="color:#1f2328">baseURL</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">bytes</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewBuffer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">reqBody</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">httpReq</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Header</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Set</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Content-Type&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;application/json&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Launch goroutine to handle the streaming</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">go</span> <span style="color:#cf222e">func</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">defer</span> <span style="color:#6639ba">close</span><span style="color:#1f2328">(</span><span style="color:#1f2328">outputChan</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">resp</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">g</span><span style="color:#1f2328">.</span><span style="color:#1f2328">client</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Do</span><span style="color:#1f2328">(</span><span style="color:#1f2328">httpReq</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Streaming request failed: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">defer</span> <span style="color:#1f2328">resp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Body</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Close</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">resp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusCode</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusOK</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Streaming API returned status %d&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">resp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">StatusCode</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">scanner</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">bufio</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewScanner</span><span style="color:#1f2328">(</span><span style="color:#1f2328">resp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Body</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> <span style="color:#1f2328">scanner</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Scan</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">line</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">scanner</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Text</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">line</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// Parse the JSON response</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">var</span> <span style="color:#1f2328">streamResp</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">Response</span> <span style="color:#cf222e">string</span> <span style="color:#0a3069">`json:&#34;response&#34;`</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">Done</span>     <span style="color:#cf222e">bool</span>   <span style="color:#0a3069">`json:&#34;done&#34;`</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">json</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Unmarshal</span><span style="color:#1f2328">([]</span><span style="color:#6639ba">byte</span><span style="color:#1f2328">(</span><span style="color:#1f2328">line</span><span style="color:#1f2328">),</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">streamResp</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Failed to parse stream response: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// Send the token to the channel</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">outputChan</span> <span style="color:#0550ae">&lt;-</span> <span style="color:#1f2328">streamResp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Response</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#57606a">// Check if generation is complete</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">streamResp</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Done</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">scanner</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Err</span><span style="color:#1f2328">();</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">log</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Printf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Stream reading error: %v&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">outputChan</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h4 id="3-hybrid-llm-architecture">3. Hybrid LLM Architecture</h4>
<p>Consider a hybrid approach that combines self-hosted models for sensitive data with API-based models for non-sensitive queries:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// HybridGenerator selects between local and cloud LLMs based on query sensitivity</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">HybridGenerator</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">localGenerator</span>  <span style="color:#1f2328">llm</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Generator</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">cloudGenerator</span>  <span style="color:#1f2328">llm</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Generator</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">sensitivityAnalyzer</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SensitivityAnalyzer</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Generate selects the appropriate backend based on query sensitivity</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">g</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">HybridGenerator</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">Generate</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span> <span style="color:#1f2328">GenerationRequest</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">GenerationResponse</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Analyze query sensitivity</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">sensitivityScore</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">g</span><span style="color:#1f2328">.</span><span style="color:#1f2328">sensitivityAnalyzer</span><span style="color:#1f2328">.</span><span style="color:#6639ba">AnalyzeQuery</span><span style="color:#1f2328">(</span><span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Query</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Choose generator based on sensitivity</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">sensitivityScore</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">0.7</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// High sensitivity - use local model</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">g</span><span style="color:#1f2328">.</span><span style="color:#1f2328">localGenerator</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Generate</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// Low sensitivity - can use cloud model</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">g</span><span style="color:#1f2328">.</span><span style="color:#1f2328">cloudGenerator</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Generate</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">req</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h4 id="4-feedback-loop-integration">4. Feedback Loop Integration</h4>
<p>Implement a feedback system to continuously improve your RAG system:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Feedback captures user feedback on RAG responses</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Feedback</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">QueryID</span>      <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">UserRating</span>   <span style="color:#cf222e">int</span>       <span style="color:#57606a">// 1-5 rating</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Comments</span>     <span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">Timestamp</span>    <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Time</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// FeedbackStore interfaces with feedback storage</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">FeedbackStore</span> <span style="color:#cf222e">interface</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">SaveFeedback</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">feedback</span> <span style="color:#1f2328">Feedback</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">GetFeedbackForQuery</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">queryID</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([]</span><span style="color:#1f2328">Feedback</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">GetRecentFeedback</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">limit</span> <span style="color:#cf222e">int</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">([]</span><span style="color:#1f2328">Feedback</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Apply feedback to improve search rankings</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">s</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SearchService</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">ApplyFeedbackToRankings</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span> <span style="color:#1f2328">context</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Context</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">feedbackStore</span> <span style="color:#1f2328">FeedbackStore</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">error</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Get recent feedback</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">feedback</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">feedbackStore</span><span style="color:#1f2328">.</span><span style="color:#6639ba">GetRecentFeedback</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ctx</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">1000</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Process feedback to adjust rankings</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// This would be a sophisticated algorithm in a real implementation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// ...</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h3 id="best-practices-for-production-deployment-1">Best Practices for Production Deployment</h3>
<p>Based on real-world experience deploying RAG systems, here are some best practices:</p>
<h4 id="1-model-versioning-and-compatibility">1. Model Versioning and Compatibility</h4>
<p>Clearly track which models and prompt templates work together:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// CompatibilityMatrix tracks which prompts work with which models</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">var</span> <span style="color:#1f2328">modelCompatibility</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">][]</span><span style="color:#cf222e">string</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;llama3:8b&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;default&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;detailed&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;concise&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;llama&#34;</span><span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;mistral:7b&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;default&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;detailed&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;concise&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;mistral&#34;</span><span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;phi:2&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;default&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;concise&#34;</span><span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Check compatibility before using a prompt template</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">isCompatible</span><span style="color:#1f2328">(</span><span style="color:#1f2328">modelName</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">templateName</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">compatibleTemplates</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ok</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">modelCompatibility</span><span style="color:#1f2328">[</span><span style="color:#1f2328">modelName</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">ok</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">name</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">compatibleTemplates</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">name</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">templateName</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h4 id="2-response-caching">2. Response Caching</h4>
<p>Implement caching for common queries to improve performance and reduce resource usage:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Cache for RAG responses</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">ResponseCache</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">cache</span>  <span style="color:#0550ae">*</span><span style="color:#1f2328">cache</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Cache</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ttl</span>    <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Duration</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// NewResponseCache creates a new response cache</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">NewResponseCache</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ttl</span> <span style="color:#1f2328">time</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Duration</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ResponseCache</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">ResponseCache</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">cache</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">cache</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ttl</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ttl</span><span style="color:#0550ae">*</span><span style="color:#0550ae">2</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">ttl</span><span style="color:#1f2328">:</span>   <span style="color:#1f2328">ttl</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// GetCachedResponse retrieves a cached response</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">c</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ResponseCache</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">GetCachedResponse</span><span style="color:#1f2328">(</span><span style="color:#1f2328">query</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">filters</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">RAGResponse</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">bool</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">cacheKey</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">generateCacheKey</span><span style="color:#1f2328">(</span><span style="color:#1f2328">query</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">filters</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">cached</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">found</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">cache</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Get</span><span style="color:#1f2328">(</span><span style="color:#1f2328">cacheKey</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">found</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">cached</span><span style="color:#1f2328">.(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">RAGResponse</span><span style="color:#1f2328">),</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// CacheResponse stores a response in cache</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">c</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">ResponseCache</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">CacheResponse</span><span style="color:#1f2328">(</span><span style="color:#1f2328">query</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">filters</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{},</span> <span style="color:#1f2328">response</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">RAGResponse</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">cacheKey</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">generateCacheKey</span><span style="color:#1f2328">(</span><span style="color:#1f2328">query</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">filters</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">cache</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Set</span><span style="color:#1f2328">(</span><span style="color:#1f2328">cacheKey</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">response</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">c</span><span style="color:#1f2328">.</span><span style="color:#1f2328">ttl</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Helper to generate cache key</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">generateCacheKey</span><span style="color:#1f2328">(</span><span style="color:#1f2328">query</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">filters</span> <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">interface</span><span style="color:#1f2328">{})</span> <span style="color:#cf222e">string</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Create a deterministic key from query and filters</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h4 id="3-monitoring-and-observability">3. Monitoring and Observability</h4>
<p>Implement comprehensive monitoring for your RAG system:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">// Metrics for monitoring</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">RAGMetrics</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">QueryCount</span>        <span style="color:#cf222e">int64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">AvgProcessingTime</span> <span style="color:#cf222e">float64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">CacheHitRate</span>      <span style="color:#cf222e">float64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ErrorRate</span>         <span style="color:#cf222e">float64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">TopQueries</span>        <span style="color:#1f2328">[]</span><span style="color:#cf222e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">ModelUsage</span>        <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">int64</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// MetricsCollector tracks system performance</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">MetricsCollector</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">queries</span>         <span style="color:#cf222e">int64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">processingTimes</span> <span style="color:#1f2328">[]</span><span style="color:#cf222e">int64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">cacheHits</span>       <span style="color:#cf222e">int64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">errors</span>          <span style="color:#cf222e">int64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">queryCounts</span>     <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">modelUsage</span>      <span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#cf222e">int64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">mu</span>              <span style="color:#1f2328">sync</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Mutex</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// RecordQuery tracks a query execution</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">m</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">MetricsCollector</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">RecordQuery</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">query</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">processingTime</span> <span style="color:#cf222e">int64</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">cacheHit</span> <span style="color:#cf222e">bool</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">modelName</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">err</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">mu</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Lock</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">defer</span> <span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">mu</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Unlock</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">queries</span><span style="color:#0550ae">++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">processingTimes</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">processingTimes</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">processingTime</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">cacheHit</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">cacheHits</span><span style="color:#0550ae">++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">err</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">errors</span><span style="color:#0550ae">++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">queryCounts</span><span style="color:#1f2328">[</span><span style="color:#1f2328">query</span><span style="color:#1f2328">]</span><span style="color:#0550ae">++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">modelUsage</span><span style="color:#1f2328">[</span><span style="color:#1f2328">modelName</span><span style="color:#1f2328">]</span><span style="color:#0550ae">++</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// GetMetrics returns current metrics</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">m</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">MetricsCollector</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">GetMetrics</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">RAGMetrics</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">mu</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Lock</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">defer</span> <span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">mu</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Unlock</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Calculate metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// ...</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">metrics</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>We&rsquo;ve now built a complete, self-hosted RAG architecture that provides privacy-preserving document search with natural language answers. Our system integrates:</p>
<ol>
<li>Document processing with intelligent chunking</li>
<li>Embedding generation for semantic search</li>
<li>Vector storage for efficient retrieval</li>
<li>A flexible search API</li>
<li>Language model integration for answer generation</li>
</ol>
<p>This architecture gives you complete control over your data and processing, with no sensitive information leaving your environment. It&rsquo;s scalable, extensible, and can be tailored to your specific needs.</p>
<p>The field of RAG is evolving rapidly, but the core architecture we&rsquo;ve described provides a solid foundation that can be enhanced and extended as new techniques and models emerge. By following these patterns and best practices, you&rsquo;ll be well-positioned to take advantage of advances in language models while maintaining strict privacy control.</p>
<p>Most importantly, you&rsquo;ve built a system that transforms how users interact with your document collection, moving from tedious keyword search to natural conversations that directly answer their questions - all while keeping sensitive information secure and private.</p>


<div class="mt-6 py-6 border-gray-200 border-t flex justify-between">
    
    <a href="/ai/mcp-go/" class="pr-4">&larr; Model Context Protocol (MCP): Lets Implement an MCP server in Go</a>
    
        
</div>



    </article>
    </div>
    <footer class="container mx-auto pl-5 pt-3 pb-5 mt-32 border-t border-gray-400">
        <div class="text-xs text-gray-700 float-right h-24">
            &copy; 2025 Prasanth Janardhanan
        </div>
    </footer>
</body>
</html>

