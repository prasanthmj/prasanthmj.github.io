<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Creating an isolated cluster - provisioning a cluster and a Bastion host using Ansible </title><meta name="keywords" content="hetzner, ansible, terraform" /><meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/css/styles.css" />
</head>
<body class="antialiased text-grey-900">
    
    <div class="container mx-auto max-w-screen-lg">
    <header class="flex items-center justify-between h-16 px-3 border-b border-gray-300">
    <div >
        <a href="/" class="flex items-center">
            <span class="text-lg text-gray-800 font-semibold">Prasanth Janardhanan</span>
        </a>
    </div>
    <div>
        <ul class="flex">
            <li class="t ml-5 text-md text-gray-700 hover:text-red-800"><a href="/" class="hover:underline">Articles</a></li>
            <li class="t ml-5 text-md text-gray-700 hover:text-red-800"><a href="/projects/" class="hover:underline">Projects</a></li>
            <li class="t ml-5 text-md text-gray-700 hover:text-red-800"><a href="/about/" class="hover:underline">About</a></li>
        </ul>
    </div>
</header>
    
    <article class="mt-6 mx-auto md:w-9/12 min-h-screen">
<h1 class="mt-5">Creating an isolated cluster - provisioning a cluster and a Bastion host using Ansible</h1>
<ul class="flex mb-2 list-none px-0 text-sm mt-0 ml-0 pt-0">
    
      <li class="pr-4 list-none">&#x1f3f7; <a href="/tags/hetzner" class="text-gray-600">hetzner</a> </li>
    
      <li class="pr-4 list-none">&#x1f3f7; <a href="/tags/ansible" class="text-gray-600">ansible</a> </li>
    
      <li class="pr-4 list-none">&#x1f3f7; <a href="/tags/terraform" class="text-gray-600">terraform</a> </li>
    
</ul>
  
<p>This is the second part of the series on setting up a cluster using Terraform and Ansible. In the <a href="../terraform-hetzner-cloud-setup-example/">first part</a>, we had set up the bare cluster Virtual Machines.
The set up included a virtual private network, a bastion server, and a separately configurable cluster of nodes.</p>
<p>The nodes are ready but not software or configuration is done so far. In the next step, we will provision all the nodes in our cloud</p>
<h2 id="provisioning-bastion-server-using-ansible">Provisioning Bastion Server using Ansible</h2>
<p>Checkout the Ansible playbook in the folder 2-provision/bastion folder
The first step we do is to configure the system:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#24292e">---</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Set timezone to Etc/UTC<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">timezone</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Etc/UTC<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#57606a"># Install Packages</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Update apt<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">apt</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>update_cache=yes<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Install required system packages<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">apt</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>name={{ item }} state=latest update_cache=yes force_apt_get=yes<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">loop</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;curl&#39;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;vim&#39;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;ufw&#39;</span><span style="color:#1f2328">]</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Should be able to add local hosts in /etc/hosts<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">lineinfile</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">path</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>/etc/cloud/cloud.cfg<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">regexp</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;^manage_etc_hosts:&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">line</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>manage_etc_hosts:false<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Update system<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">package</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;*&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">update_cache</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#cf222e">yes</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">state</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>latest<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">register</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>system_updated<span style="color:#fff">
</span></span></span></code></pre></div><p>First, we set up the timezone to be UTC. Then we install or upgrade some system packages. We update the file <code>/etc/cloud/cloud.cfg</code> to add a configuration to be able to edit the <code>etc/hosts</code> file. We will be updating the hosts file for accessing the nodes in the cluster easily using names like node1, node2 etc</p>
<h3 id="user-setup">User setup</h3>
<p>The next step is to configure user login and ssh. See the role users in the folder <code>2-provision/roles/users</code>. We create a &lsquo;wheel&rsquo; group with <code>sudo</code> permissions. Then we disable root login. Note that this is just one way of configuring user access and ssh configuration. Depending on your requirements and configuration you can customize the user login setup by adding stricter and tighter SSH login restrictions.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#57606a"># Sudo Group Setup</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Make sure we have a &#39;wheel&#39; group<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">group</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>wheel<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">state</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>present<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Allow &#39;wheel&#39; group to have passwordless sudo<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">lineinfile</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">path</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>/etc/sudoers<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">state</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>present<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">regexp</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;^%wheel&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">line: &#39;%wheel ALL=(ALL) NOPASSWD</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>ALL&#39;<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">validate</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;/usr/sbin/visudo -cf %s&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Create a new user<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">user</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;{{ deploy_user_name }}&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">state</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>present<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">groups</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>wheel<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">append</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#cf222e">true</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">create_home</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#cf222e">true</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">shell</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>/bin/bash<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Set authorized key for remote user<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">authorized_key</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">user</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;{{ deploy_user_name }}&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">state</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>present<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">key</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;{{ lookup(&#39;file&#39;, deploy_user_key_path ) }}&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Disable password login<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">lineinfile</span><span style="color:#1f2328">:</span><span style="color:#fff"> 
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">path</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>/etc/ssh/sshd_config <span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">regexp</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;^(#\s*)?PasswordAuthentication &#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">line</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;PasswordAuthentication no&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">notify</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Restart sshd<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Disable root login<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">lineinfile</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">path</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>/etc/ssh/sshd_config<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">state</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>present<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">regexp</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;^#?PermitRootLogin&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">line</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;PermitRootLogin no&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">notify</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Restart sshd<span style="color:#fff">
</span></span></span></code></pre></div><h3 id="configuring-node-communications">Configuring node communications</h3>
<p>The next few steps are to configure the SSH communication with the nodes in the cluster a bit easier. We will assign names to the nodes in the cluster and use the private IP address to communicate between the nodes.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#fff">    </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Add IP address of all hosts to hosts file<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">lineinfile</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">dest</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>/etc/hosts<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">regexp</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;.*{{ item.name }}$&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">line</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;{{ item.ip }}  {{item.name}}&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">state</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>present<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">with_items</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>node1<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">ip</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;10.0.0.5&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>node2<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">ip</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;10.0.0.6&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>node3<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">ip</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;10.0.0.7&#34;</span><span style="color:#fff">   
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>node4<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">ip</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;10.0.0.15&#34;</span><span style="color:#fff">   
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>node5<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">ip</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;10.0.0.16&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>node6<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">ip</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;10.0.0.17&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Copy keys used to connect to nodes<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">copy</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">src</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;keys/{{item}}&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">dest</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;/home/{{ deploy_user_name }}/.ssh/{{item}}&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">mode</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;600&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">owner</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;{{ deploy_user_name }}&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">group</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;{{ deploy_user_name }}&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">with_items</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>- nodes<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>- nodes.pub<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Make sure ssh/config file exists<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">file</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         </span><span style="color:#0550ae">path</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;/home/{{ deploy_user_name }}/.ssh/config&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         </span><span style="color:#0550ae">state</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>touch        <span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Setup SSH config file for nodes<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">blockinfile</span><span style="color:#1f2328">:</span><span style="color:#fff"> 
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         </span><span style="color:#0550ae">path</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;/home/{{ deploy_user_name }}/.ssh/config&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         </span><span style="color:#0550ae">marker</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;# {mark} Added through ansible scripts {{item}}&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         </span><span style="color:#0550ae">block</span><span style="color:#1f2328">:</span><span style="color:#fff">  </span><span style="color:#1f2328">|</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Host {{item}}
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                IdentityFile ~/.ssh/nodes
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                User {{ deploy_user_name }}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">loop</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         </span>- node1<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         </span>- node2<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         </span>- node3<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         </span>- node4<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         </span>- node5<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         </span>- node6<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         
</span></span></span></code></pre></div><h3 id="installing-tools">Installing tools</h3>
<p>Next, we install tools required for running the cluster. For example, it will be handy to have <code>kubectl</code> and helm  on the bastion host. So we install these tools.</p>
<p>Next, we install and configure an NFS share on the bastion host. This is optional. However, this will be handy to have a network share accessible from all nodes of the cluster.</p>
<h3 id="firewall-setup">Firewall setup</h3>
<p>We will use <code>ufw</code> for firewall. First, install <code>ufw</code> then allow only SSH incoming. We also open the NFS port only to the private network.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#fff">    </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Install ufw<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">apt</span><span style="color:#1f2328">:</span><span style="color:#fff"> 
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>ufw<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">state</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>latest<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>ufw allow ssh<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">ufw</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">rule</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>allow<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>OpenSSH<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>ufw allow NFS<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">ufw</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">rule</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>allow<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">port</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;2049&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">src</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;10.0.0.0/16&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Enable UFW<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">ufw</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">state</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>enabled<span style="color:#fff">
</span></span></span></code></pre></div><h3 id="provisioning-the-bastion-server">Provisioning the Bastion server</h3>
<p>Now that we have the scripts ready, let us run Ansible to configure the servers.</p>
<p>First, you need to generate SSH keys for setting up a login on the bastion host
Let&rsquo;s name it <code>mycluster-bastion</code>. Then create SSH keys for the nodes. Keep the node keys(private and public) in the folder 2-provision/bastion/keys</p>
<p>Get the IP address of the bastion host to node.txt Then run the Ansible playbook</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible-playbook bastion.yaml -i node.txt --user<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;root&#39;</span> --key-file<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;~/.ssh/tcloud&#34;</span> --ssh-extra-args<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;-p 22 -o ConnectTimeout=10 -o ConnectionAttempts=10 -o StrictHostKeyChecking=no&#39;</span> --extra-vars<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;deploy_user_name=nodeuser deploy_user_key_path=~/.ssh/mycluster-bastion.pub&#34;</span>
</span></span></code></pre></div><p>All these steps can be automated in the <code>run.sh</code> bash script like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#cf222e">function</span> ProvisionBase<span style="color:#0550ae">(){</span>
</span></span><span style="display:flex;"><span>   <span style="color:#6639ba">cd</span> ./1-infra/mycluster/base
</span></span><span style="display:flex;"><span>   <span style="color:#953800">IP</span><span style="color:#0550ae">=</span><span style="color:#cf222e">$(</span>terraform show <span style="color:#1f2328">|</span> egrep bastion_ip <span style="color:#1f2328">|</span> cut -d<span style="color:#0a3069">&#39;&#34;&#39;</span> -f <span style="color:#0550ae">2</span> <span style="color:#cf222e">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#6639ba">echo</span> <span style="color:#0a3069">&#34;IP is </span><span style="color:#953800">$IP</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#6639ba">cd</span> ../../../2-provision/bastion 
</span></span><span style="display:flex;"><span>   <span style="color:#6639ba">printf</span> <span style="color:#0a3069">&#34;</span><span style="color:#953800">$IP</span><span style="color:#0a3069">\n&#34;</span> &gt; node.txt
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>   <span style="color:#953800">ANSIBLE_FORCE_COLOR</span><span style="color:#0550ae">=</span><span style="color:#6639ba">true</span> 
</span></span><span style="display:flex;"><span>   ansible-playbook bastion.yaml -i node.txt --user<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;root&#39;</span> --key-file<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;~/.ssh/tcloud&#34;</span> --ssh-extra-args<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;-p 22 -o ConnectTimeout=10 -o ConnectionAttempts=10 -o StrictHostKeyChecking=no&#39;</span> --extra-vars<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;deploy_user_name=nodeuser deploy_user_key_path=~/.ssh/mycluster-bastion.pub&#34;</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span><span style="color:#0550ae">}</span>
</span></span></code></pre></div><p>The script can be run like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./run.sh provision base
</span></span></code></pre></div><h2 id="provisioning-the-cluster-nodes">Provisioning the cluster nodes</h2>
<p>We run the basic system setup on the cluster nodes as well using the same roles used for provisioning the bastion server. Then we setup SSH and user rights using the users role.</p>
<h2 id="installing-essential-software-on-the-nodes">Installing essential software on the nodes</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>post build setup - nodes<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">hosts</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>all<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">become</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#cf222e">true</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">tasks</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Initial System Setup<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">include_role</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>../roles/system<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Users setup<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">include_role</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>../roles/users  <span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Install docker<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">include_role</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>geerlingguy.docker <span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">vars</span><span style="color:#1f2328">:</span><span style="color:#fff"> 
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         </span><span style="color:#0550ae">docker_users</span><span style="color:#1f2328">:</span><span style="color:#fff"> 
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0a3069">&#34;{{ deploy_user_name }}&#34;</span><span style="color:#fff">      
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                   
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Set authorized key taken from file<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">ansible.posix.authorized_key</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">user</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>myadmin<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">state</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>present<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">key</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;{{ lookup(&#39;file&#39;, &#39;../bastion/keys/nodes.pub&#39;) }}&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Enable UFW firewall<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">include_role</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>../roles/ufw    <span style="color:#fff">
</span></span></span></code></pre></div><p>The nodes require only a few software installed. We intend to build a Kubernetes cluster. We intend to use Docker for the virtualization layer. So we install docker. Then we copy the SSH keys. Finally, we install and configure UFW firewall.</p>
<p>The firewall is configured to disallow communications from the public network. All communications to the cluster nodes are through the private network. See the UFW rules configured using Ansible:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>make sure ufw is installed<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">apt</span><span style="color:#1f2328">:</span><span style="color:#fff"> 
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>ufw<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">state</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>latest<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>disable all incoming on eth0<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">ufw</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">     </span><span style="color:#0550ae">rule</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>reject<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">     </span><span style="color:#0550ae">direction</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>in<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">     </span><span style="color:#0550ae">interface</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>eth0<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>allow all from internal network<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">ufw</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">     </span><span style="color:#0550ae">rule</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>allow<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">     </span><span style="color:#0550ae">from_ip</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;10.0.0.0/16&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">     </span><span style="color:#0550ae">to_ip</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>any<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">     
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Enable UFW<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">ufw</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">state</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>enabled<span style="color:#fff">
</span></span></span></code></pre></div><p>Now that the script is ready, we can run Ansible playbook.</p>
<p>First, create SSH key for the node user <code>mycluster-nodes</code>.
First, get the public IP addresses of the nodes to a cluster.txt inventory file. Then run the command</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6639ba">cd</span> ./2-provision/cluster
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible-playbook nodes.yaml -i cluster.txt --user<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;root&#39;</span> --key-file<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;~/.ssh/tcloud&#34;</span> --ssh-extra-args<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;-p 22 -o ConnectTimeout=10 -o ConnectionAttempts=10 -o StrictHostKeyChecking=no&#39;</span> --extra-vars<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;deploy_user_name=nodeuser deploy_user_key_path=~/.ssh/mycluster-nodes.pub&#34;</span>
</span></span></code></pre></div><p>Here is the bash script function that does the same:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#cf222e">function</span> provisionCluster<span style="color:#0550ae">(){</span>
</span></span><span style="display:flex;"><span>   <span style="color:#953800">NAME</span><span style="color:#0550ae">=</span><span style="color:#953800">$1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#6639ba">cd</span> <span style="color:#0a3069">&#34;./1-infra/mycluster/</span><span style="color:#953800">$NAME</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#953800">NODES</span><span style="color:#0550ae">=</span><span style="color:#cf222e">$(</span>terraform show <span style="color:#1f2328">|</span> egrep ipv4_address <span style="color:#1f2328">|</span> cut -d<span style="color:#0a3069">&#39;&#34;&#39;</span> -f <span style="color:#0550ae">2</span> <span style="color:#1f2328">|</span> sort -u<span style="color:#cf222e">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#6639ba">cd</span> ../../../2-provision/cluster
</span></span><span style="display:flex;"><span>   <span style="color:#6639ba">printf</span> <span style="color:#0a3069">&#34;</span><span style="color:#953800">$NODES</span><span style="color:#0a3069">\n&#34;</span> &gt; cluster.txt
</span></span><span style="display:flex;"><span>   <span style="color:#953800">ANSIBLE_FORCE_COLOR</span><span style="color:#0550ae">=</span><span style="color:#6639ba">true</span> 
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>   ansible-playbook nodes.yaml -i cluster.txt --user<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;root&#39;</span> --key-file<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;~/.ssh/tcloud&#34;</span> --ssh-extra-args<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;-p 22 -o ConnectTimeout=10 -o ConnectionAttempts=10 -o StrictHostKeyChecking=no&#39;</span> --extra-vars<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;deploy_user_name=nodeuser deploy_user_key_path=~/.ssh/mycluster-nodes.pub&#34;</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span><span style="color:#0550ae">}</span>
</span></span></code></pre></div><p>Once the command finishes the cluster nodes are provisioned.</p>
<p>In order to test whether the setup is working, first SSH to the Bastion host
Then from the bastion host, ssh to the nodes in the cluster.
Add the IP address of the bastion host to your <code>/etc/hosts</code> file</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh -i ~/.ssh/mycluster-bastion nodeuser@bastion
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh nodeuser@node1
</span></span></code></pre></div><p>If you could get to node1 through SSH, the setup is working as expected. We can proceed to install Kubernetes on this cluster.</p>
<p>Similarly, you can try logging into node2 and node3.</p>
<h2 id="ssh-to-the-nodes-through-the-bastion-host">SSH to the nodes through the bastion host</h2>
<p>You can configure SSH on your local laptop to connect to the node through the bastion host. Here is a sample ssh config file (place the file in ~/.ssh/config )</p>
<pre tabindex="0"><code>Host bastion
  User nodeuser
  IdentityFile ~/.ssh/mycluster-bastion
  
Host node1
  IdentityFile ~/.ssh/mycluster-nodes
  ProxyCommand ssh nodeuser@bastion -W %h:%p
  
</code></pre><p>Now you can access node1 directly from your local laptop:</p>
<pre tabindex="0"><code>ssh nodeuser@node1
</code></pre>

<div class="mt-6 py-6 border-gray-200 border-t flex justify-between">
    
    <a href="/terraform/terraform-hetzner-cloud-setup-example/" class="pr-4">&larr; Setting up a Bastion host and a three-node cluster on Hetzner cloud using Terraform and Ansible</a>
    
        
</div>



    </article>
    </div>
    <footer class="container mx-auto pl-5 pt-3 pb-5 mt-32 border-t border-gray-400">
        <div class="text-xs text-gray-700 float-right h-24">
            &copy; 2025 Prasanth Janardhanan
        </div>
    </footer>
</body>
</html>

